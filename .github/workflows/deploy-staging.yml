name: Deploy to Railway Staging

on:
  push:
    branches:
      - develop
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging

env:
  NODE_VERSION: '20'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://mcp-server-staging.railway.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --frozen-lockfile

      - name: Run tests
        run: npm run test

      - name: Build application
        run: npm run build:prod

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway Staging
        run: railway up --detach -e staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment
        run: sleep 60

      - name: Run database migrations
        run: railway run npm run migrate -e staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Run staging health checks
        run: |
          echo "Running staging health checks..."

          # Health endpoint
          if ! curl -f --max-time 30 https://mcp-server-staging.railway.app/health; then
            echo "Staging health check failed"
            exit 1
          fi

          # MCP SSE endpoint
          if ! curl -f --max-time 30 -H "Accept: text/event-stream" https://mcp-server-staging.railway.app/mcp/sse; then
            echo "Staging MCP SSE endpoint check failed"
            exit 1
          fi

          echo "Staging health checks completed successfully"

      - name: Create staging deployment record
        run: |
          echo "Staging deployment successful at $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Environment: staging"

  notify-staging:
    name: Notify Staging Deployment
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: always()

    steps:
      - name: Notify deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.deploy-staging.result }}';
            const environment = 'staging';
            const url = 'https://mcp-server-staging.railway.app';

            const title = status === 'success' 
              ? `âœ… Staging Deployment Successful`
              : `âŒ Staging Deployment Failed`;
              
            const body = `
            **Environment:** ${environment}
            **Status:** ${status}
            **URL:** ${url}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_number }}

            ${status === 'success' 
              ? 'ðŸŽ‰ Staging deployment completed successfully and is ready for testing!'
              : 'ðŸ’¥ Staging deployment failed. Please check the logs and try again.'
            }
            `;

            // Create or update deployment comment
            const { data: comments } = await github.rest.issues.listCommentsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const deploymentComment = comments.find(comment => 
              comment.body.includes('**Environment:** staging') &&
              comment.body.includes(`**Commit:** ${{ github.sha }}`)
            );

            if (deploymentComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: deploymentComment.id,
                body: body
              });
            }

            // If deployment failed, create issue
            if (status === 'failure') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Staging Deployment Failed',
                body: body + '\n\nPlease investigate the failure and re-deploy when ready.',
                labels: ['bug', 'staging', 'deployment']
              });
            }
