{"file":"/workspace/tests/integration/pkce-validation.test.ts","mappings":"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","names":[],"sources":["/workspace/tests/integration/pkce-validation.test.ts"],"sourcesContent":["/**\n * PKCE Business Logic Tests\n *\n * Tests application-specific PKCE functionality:\n * - Authorization flow with PKCE\n * - Token exchange using PKCE\n */\n\nimport {\n  describe,\n  test,\n  expect,\n  beforeEach,\n  afterEach,\n  jest,\n  beforeAll,\n  afterAll,\n} from '@jest/globals';\nimport { OAuthClient } from '@/auth/oauth-client.js';\nimport type { OAuthTokens, PKCEChallenge } from '@/auth/oauth-client.js';\nimport { createServer } from 'http';\nimport type { Server } from 'http';\nimport type { AddressInfo } from 'net';\n\ndescribe('PKCE Business Logic Tests', () => {\n  let mockOAuthServer: Server;\n  let serverPort: number;\n  let oauthClient: OAuthClient;\n\n  beforeAll(async () => {\n    mockOAuthServer = await createPKCETestServer();\n    const address = mockOAuthServer.address() as AddressInfo;\n    serverPort = address.port;\n\n    oauthClient = new OAuthClient({\n      clientId: 'test-client-id',\n      authorizationEndpoint: `http://localhost:${serverPort}/oauth/authorize`,\n      tokenEndpoint: `http://localhost:${serverPort}/oauth/token`,\n      redirectUri: 'http://127.0.0.1:3000/callback',\n      scopes: ['tutorial:read', 'user:profile'],\n    });\n  });\n\n  afterAll(async () => {\n    if (mockOAuthServer) {\n      await new Promise<void>(resolve => {\n        mockOAuthServer.close(() => resolve());\n      });\n    }\n  });\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    clearServerState();\n  });\n\n  describe('Authorization Request with PKCE', () => {\n    test('should include PKCE parameters in authorization URL', () => {\n      const challenge = oauthClient.generatePKCEChallenge();\n\n      const buildAuthUrlMethod = (\n        oauthClient as any\n      ).buildAuthorizationUrl.bind(oauthClient);\n      const authUrl = buildAuthUrlMethod({\n        codeChallenge: challenge.codeChallenge,\n        codeChallengeMethod: challenge.codeChallengeMethod,\n        state: 'test-state',\n        redirectUri: 'http://127.0.0.1:3000/callback',\n      });\n\n      const url = new URL(authUrl);\n\n      expect(url.searchParams.get('code_challenge')).toBe(\n        challenge.codeChallenge\n      );\n      expect(url.searchParams.get('code_challenge_method')).toBe('S256');\n    });\n  });\n\n  describe('Token Request with PKCE', () => {\n    test('should include code verifier in token exchange request', async () => {\n      const challenge = oauthClient.generatePKCEChallenge();\n      const authCode = 'test_authorization_code';\n\n      setMockTokenResponse({\n        accessToken: 'access_token_123',\n        refreshToken: 'refresh_token_456',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n      });\n\n      // Store the challenge for server verification\n      setExpectedPKCE(challenge);\n\n      const exchangeMethod = (oauthClient as any).exchangeCodeForTokens.bind(\n        oauthClient\n      );\n\n      const tokens = await exchangeMethod(authCode, challenge.codeVerifier);\n\n      expect(tokens.accessToken).toBe('access_token_123');\n\n      // Verify the server received correct PKCE parameters\n      expect(getLastTokenRequest()).toEqual(\n        expect.objectContaining({\n          grant_type: 'authorization_code',\n          client_id: 'test-client-id',\n          code: authCode,\n          redirect_uri: 'http://127.0.0.1:3000/callback',\n          code_verifier: challenge.codeVerifier,\n        })\n      );\n    });\n  });\n});\n\n// Mock server implementation for PKCE testing\nlet expectedPKCE: PKCEChallenge | null = null;\nlet mockTokenResponse: OAuthTokens | null = null;\nlet mockTokenError: { status: number; error: string } | null = null;\nlet lastTokenRequest: Record<string, string> | null = null;\n\nfunction setExpectedPKCE(challenge: PKCEChallenge): void {\n  expectedPKCE = challenge;\n}\n\nfunction setMockTokenResponse(tokens: OAuthTokens): void {\n  mockTokenResponse = tokens;\n  mockTokenError = null;\n}\n\nfunction setMockTokenError(status: number, error: string): void {\n  mockTokenError = { status, error };\n  mockTokenResponse = null;\n}\n\nfunction getLastTokenRequest(): Record<string, string> | null {\n  return lastTokenRequest;\n}\n\nfunction clearServerState(): void {\n  expectedPKCE = null;\n  mockTokenResponse = null;\n  mockTokenError = null;\n  lastTokenRequest = null;\n}\n\nasync function createPKCETestServer(): Promise<Server> {\n  return new Promise<Server>(resolve => {\n    const server = createServer((req, res) => {\n      const url = new URL(req.url || '', `http://localhost`);\n\n      if (url.pathname === '/oauth/token' && req.method === 'POST') {\n        handlePKCETokenRequest(req, res);\n      } else if (url.pathname === '/oauth/authorize' && req.method === 'GET') {\n        handleAuthorizeRequest(req, res);\n      } else {\n        res.writeHead(404);\n        res.end('Not found');\n      }\n    });\n\n    server.listen(0, '127.0.0.1', () => {\n      resolve(server);\n    });\n  });\n}\n\nfunction handlePKCETokenRequest(req: any, res: any): void {\n  let body = '';\n  req.on('data', (chunk: Buffer) => {\n    body += chunk.toString();\n  });\n\n  req.on('end', () => {\n    const params = new URLSearchParams(body);\n    lastTokenRequest = Object.fromEntries(params.entries());\n\n    // Validate PKCE if expected\n    if (expectedPKCE) {\n      const codeVerifier = params.get('code_verifier');\n      if (!codeVerifier) {\n        res.writeHead(400, { 'Content-Type': 'application/json' });\n        res.end(\n          JSON.stringify({\n            error: 'invalid_request',\n            error_description: 'Missing code_verifier',\n          })\n        );\n        return;\n      }\n\n      // Simple PKCE validation for testing business logic\n      if (codeVerifier !== expectedPKCE.codeVerifier) {\n        res.writeHead(400, { 'Content-Type': 'application/json' });\n        res.end(\n          JSON.stringify({\n            error: 'invalid_grant',\n            error_description: 'PKCE verification failed',\n          })\n        );\n        return;\n      }\n    }\n\n    // Return configured response\n    if (mockTokenError) {\n      res.writeHead(mockTokenError.status, {\n        'Content-Type': 'application/json',\n      });\n      res.end(JSON.stringify({ error: mockTokenError.error }));\n      return;\n    }\n\n    if (mockTokenResponse) {\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end(\n        JSON.stringify({\n          access_token: mockTokenResponse.accessToken,\n          refresh_token: mockTokenResponse.refreshToken,\n          token_type: mockTokenResponse.tokenType,\n          expires_in: mockTokenResponse.expiresIn,\n          scope: mockTokenResponse.scope,\n        })\n      );\n      return;\n    }\n\n    res.writeHead(500, { 'Content-Type': 'application/json' });\n    res.end(JSON.stringify({ error: 'server_error' }));\n  });\n}\n\nfunction handleAuthorizeRequest(req: any, res: any): void {\n  const url = new URL(req.url || '', `http://localhost`);\n  const redirectUri = url.searchParams.get('redirect_uri');\n  const state = url.searchParams.get('state');\n\n  if (redirectUri && state) {\n    const callbackUrl = new URL(redirectUri);\n    callbackUrl.searchParams.set('code', 'test_auth_code');\n    callbackUrl.searchParams.set('state', state);\n\n    res.writeHead(302, { Location: callbackUrl.toString() });\n    res.end();\n  } else {\n    res.writeHead(400);\n    res.end('Invalid request');\n  }\n}\n"],"version":3}