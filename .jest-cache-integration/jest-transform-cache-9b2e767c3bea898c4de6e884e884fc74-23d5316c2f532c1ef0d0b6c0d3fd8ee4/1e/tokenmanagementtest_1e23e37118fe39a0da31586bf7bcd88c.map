{"file":"/workspace/tests/integration/token-management.test.ts","mappings":"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","names":[],"sources":["/workspace/tests/integration/token-management.test.ts"],"sourcesContent":["/**\n * Token management and security integration tests\n */\n\nimport { promises as fs } from 'fs';\nimport { join } from 'path';\nimport { tmpdir } from 'os';\nimport jwt from 'jsonwebtoken';\nimport { TokenManager, StoredTokens } from '@/auth/token-manager.js';\nimport type { OAuthTokens } from '@/auth/oauth-client.js';\nimport { OAuthClient } from '@/auth/oauth-client.js';\n// CryptoUtils removed for MVP simplification\n// import { CryptoUtils } from '../../src/auth/crypto-utils.js';\n\ndescribe('Token Management Integration Tests', () => {\n  let tokenManager: TokenManager;\n  let oauthClient: OAuthClient;\n  let testTokenDir: string;\n  let originalHomedir: string;\n\n  const createMockJWT = (payload: any, expiresIn: string = '1h'): string => {\n    // Don't pass expiresIn if payload already has exp\n    const options = payload.exp ? {} : { expiresIn };\n    return jwt.sign(payload, 'test-secret', options);\n  };\n\n  beforeAll(() => {\n    // Mock homedir for testing\n    originalHomedir = process.env.HOME || '';\n    testTokenDir = join(tmpdir(), 'drupal-test-tokens');\n    process.env.HOME = tmpdir();\n\n    oauthClient = new OAuthClient({\n      clientId: 'test-client-id',\n      authorizationEndpoint: 'http://localhost/oauth/authorize',\n      tokenEndpoint: 'http://localhost/oauth/token',\n      redirectUri: 'http://127.0.0.1:3000/callback',\n      scopes: ['tutorial:read', 'user:profile'],\n    });\n\n    tokenManager = new TokenManager(oauthClient, 'test-user');\n  });\n\n  afterAll(() => {\n    process.env.HOME = originalHomedir;\n  });\n\n  beforeEach(async () => {\n    // Clean up test tokens before each test\n    try {\n      await fs.rm(join(tmpdir(), '.drupal-bridge-mcp'), {\n        recursive: true,\n        force: true,\n      });\n    } catch {\n      // Ignore if directory doesn't exist\n    }\n  });\n\n  afterEach(async () => {\n    // Clean up test tokens after each test\n    try {\n      await fs.rm(join(tmpdir(), '.drupal-bridge-mcp'), {\n        recursive: true,\n        force: true,\n      });\n    } catch {\n      // Ignore if directory doesn't exist\n    }\n  });\n\n  describe('Token Storage Security', () => {\n    test('should store tokens in plain JSON format (MVP simplified)', async () => {\n      // Create a fresh token manager for this specific test\n      const testTokenManager = new TokenManager(oauthClient, 'plain-test-user');\n\n      const mockTokens: OAuthTokens = {\n        accessToken: 'test-access-token',\n        refreshToken: 'test-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n        scope: 'tutorial:read user:profile',\n      };\n\n      await testTokenManager.storeTokens(mockTokens, 'plain-test-user', [\n        'tutorial:read',\n      ]);\n\n      // Read raw file content - use the specific token file for this user\n      const { tokenFile } = testTokenManager as any;\n      const rawContent = await fs.readFile(tokenFile, 'utf8');\n      const tokenData = JSON.parse(rawContent);\n\n      // Verify tokens are stored in plain JSON format (MVP simplified)\n      expect(rawContent).toContain(mockTokens.accessToken);\n      expect(rawContent).toContain(mockTokens.refreshToken);\n      expect(tokenData.accessToken).toBe(mockTokens.accessToken);\n      expect(tokenData.refreshToken).toBe(mockTokens.refreshToken);\n      expect(tokenData.userId).toBe('plain-test-user');\n    });\n\n    test('should retrieve tokens correctly (MVP simplified)', async () => {\n      const mockTokens: OAuthTokens = {\n        accessToken: 'test-access-token',\n        refreshToken: 'test-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n        scope: 'tutorial:read user:profile',\n      };\n\n      await tokenManager.storeTokens(mockTokens, 'test-user', [\n        'tutorial:read',\n      ]);\n      const retrievedTokens = await tokenManager.getTokens('test-user');\n\n      expect(retrievedTokens).toBeDefined();\n      expect(retrievedTokens!.accessToken).toBe(mockTokens.accessToken);\n      expect(retrievedTokens!.refreshToken).toBe(mockTokens.refreshToken);\n      expect(retrievedTokens!.tokenType).toBe(mockTokens.tokenType);\n      expect(retrievedTokens!.userId).toBe('test-user');\n    });\n\n    test('should fail to decrypt with wrong user', async () => {\n      const mockTokens: OAuthTokens = {\n        accessToken: 'test-access-token',\n        refreshToken: 'test-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n      };\n\n      await tokenManager.storeTokens(mockTokens, 'user1', ['tutorial:read']);\n\n      // Different user should not be able to access tokens\n      const retrievedTokens = await tokenManager.getTokens('user2');\n      expect(retrievedTokens).toBeNull();\n    });\n\n    test('should secure file permissions', async () => {\n      const mockTokens: OAuthTokens = {\n        accessToken: 'test-access-token',\n        refreshToken: 'test-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n      };\n\n      await tokenManager.storeTokens(mockTokens, 'test-user', [\n        'tutorial:read',\n      ]);\n\n      const { tokenDir } = tokenManager as any;\n\n      try {\n        // Check directory permissions (owner only)\n        const dirStats = await fs.stat(tokenDir);\n        const dirMode = dirStats.mode & parseInt('777', 8);\n        expect(dirMode).toBe(parseInt('700', 8)); // Owner read/write/execute only\n\n        // Find the actual token file and check file permissions (owner only)\n        const files = await fs.readdir(tokenDir);\n        const tokenFile = join(\n          tokenDir,\n          files.find(f => f.startsWith('tokens_')) || 'tokens.json'\n        );\n        const fileStats = await fs.stat(tokenFile);\n        const fileMode = fileStats.mode & parseInt('777', 8);\n        expect(fileMode).toBe(parseInt('600', 8)); // Owner read/write only\n      } catch (error) {\n        throw new Error(\n          `File permissions test failed: ${error instanceof Error ? error.message : 'Unknown error'}`\n        );\n      }\n    });\n  });\n\n  describe('JWT Token Validation', () => {\n    test('should validate JWT structure and expiration', async () => {\n      const mockPayload = {\n        sub: 'test-user-id',\n        scope: 'tutorial:read user:profile',\n        iat: Math.floor(Date.now() / 1000),\n        exp: Math.floor(Date.now() / 1000) + 3600,\n      };\n\n      const mockToken = createMockJWT(mockPayload);\n      const validation = await tokenManager.validateToken(mockToken);\n\n      expect(validation.isValid).toBe(true);\n      expect(validation.isExpired).toBe(false);\n      expect(validation.needsRefresh).toBe(false);\n      expect(validation.scopes).toEqual(['tutorial:read', 'user:profile']);\n      expect(validation.userId).toBe('test-user-id');\n    });\n\n    test('should detect expired tokens', async () => {\n      const mockPayload = {\n        sub: 'test-user-id',\n        scope: 'tutorial:read user:profile',\n        iat: Math.floor(Date.now() / 1000) - 7200, // 2 hours ago\n        exp: Math.floor(Date.now() / 1000) - 3600, // Expired 1 hour ago\n      };\n\n      const mockToken = createMockJWT(mockPayload);\n      const validation = await tokenManager.validateToken(mockToken);\n\n      expect(validation.isValid).toBe(false);\n      expect(validation.isExpired).toBe(true);\n      expect(validation.needsRefresh).toBe(true);\n    });\n\n    test('should detect tokens needing refresh (5-minute buffer)', async () => {\n      const mockPayload = {\n        sub: 'test-user-id',\n        scope: 'tutorial:read user:profile',\n        iat: Math.floor(Date.now() / 1000),\n        exp: Math.floor(Date.now() / 1000) + 240, // Expires in 4 minutes\n      };\n\n      const mockToken = createMockJWT(mockPayload);\n      const validation = await tokenManager.validateToken(mockToken);\n\n      expect(validation.isValid).toBe(true);\n      expect(validation.isExpired).toBe(false);\n      expect(validation.needsRefresh).toBe(true); // Should refresh within 5 minutes\n    });\n\n    test('should validate required scopes', async () => {\n      const mockPayload = {\n        sub: 'test-user-id',\n        scope: 'tutorial:read',\n        iat: Math.floor(Date.now() / 1000),\n        exp: Math.floor(Date.now() / 1000) + 3600,\n      };\n\n      const mockToken = createMockJWT(mockPayload);\n\n      // Valid with required scopes\n      const validValidation = await tokenManager.validateToken(mockToken, [\n        'tutorial:read',\n      ]);\n      expect(validValidation.isValid).toBe(true);\n\n      // Invalid with missing scopes\n      const invalidValidation = await tokenManager.validateToken(mockToken, [\n        'tutorial:read',\n        'tutorial:write',\n      ]);\n      expect(invalidValidation.isValid).toBe(false);\n    });\n  });\n\n  describe('Automatic Token Refresh', () => {\n    test('should refresh token automatically when expired', async () => {\n      // Create expired token\n      const expiredToken: OAuthTokens = {\n        accessToken: createMockJWT({\n          sub: 'test-user',\n          exp: Math.floor(Date.now() / 1000) - 3600,\n        }),\n        refreshToken: 'test-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 1,\n      };\n\n      // Mock successful refresh\n      const newTokens: OAuthTokens = {\n        accessToken: createMockJWT({\n          sub: 'test-user',\n          exp: Math.floor(Date.now() / 1000) + 3600,\n        }),\n        refreshToken: 'new-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n      };\n\n      jest.spyOn(oauthClient, 'refreshToken').mockResolvedValue(newTokens);\n\n      await tokenManager.storeTokens(expiredToken, 'test-user', [\n        'tutorial:read',\n      ]);\n\n      const validToken = await tokenManager.getValidAccessToken('test-user');\n\n      expect(validToken).toBe(newTokens.accessToken);\n      expect(oauthClient.refreshToken).toHaveBeenCalledWith(\n        'test-refresh-token'\n      );\n    });\n\n    test('should clear tokens when refresh fails', async () => {\n      const expiredToken: OAuthTokens = {\n        accessToken: createMockJWT({\n          sub: 'test-user',\n          exp: Math.floor(Date.now() / 1000) - 3600,\n        }),\n        refreshToken: 'invalid-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 1,\n      };\n\n      // Mock failed refresh\n      jest\n        .spyOn(oauthClient, 'refreshToken')\n        .mockRejectedValue(new Error('Refresh failed'));\n\n      await tokenManager.storeTokens(expiredToken, 'test-user', [\n        'tutorial:read',\n      ]);\n\n      const validToken = await tokenManager.getValidAccessToken('test-user');\n\n      expect(validToken).toBeNull();\n\n      // Verify tokens were cleared\n      const tokens = await tokenManager.getTokens('test-user');\n      expect(tokens).toBeNull();\n    });\n  });\n\n  // Cryptographic Utilities tests disabled for MVP simplification\n  /*\n  describe('Cryptographic Utilities', () => {\n    test('should encrypt and decrypt data correctly', () => {\n      const testData = 'sensitive-data-12345';\n      const key = CryptoUtils.generateEncryptionKey('test-user');\n\n      const encrypted = CryptoUtils.encrypt(testData, key);\n      const decrypted = CryptoUtils.decrypt(encrypted, key);\n\n      expect(decrypted).toBe(testData);\n      expect(encrypted).not.toContain(testData);\n    });\n\n    test('should fail decryption with wrong key', () => {\n      const testData = 'sensitive-data-12345';\n      const key1 = CryptoUtils.generateEncryptionKey('user1');\n      const key2 = CryptoUtils.generateEncryptionKey('user2');\n\n      const encrypted = CryptoUtils.encrypt(testData, key1);\n\n      expect(() => {\n        CryptoUtils.decrypt(encrypted, key2);\n      }).toThrow('Decryption failed');\n    });\n\n    test('should generate unique encryption keys for different users', () => {\n      const key1 = CryptoUtils.generateEncryptionKey('user1');\n      const key2 = CryptoUtils.generateEncryptionKey('user2');\n\n      expect(key1).not.toEqual(key2);\n      expect(key1.length).toBe(32); // 256 bits\n      expect(key2.length).toBe(32); // 256 bits\n    });\n\n    test('should create secure user fingerprints', async () => {\n      const fingerprint1 = CryptoUtils.createUserFingerprint();\n      // Small delay to ensure different timestamp\n      await new Promise(resolve => setTimeout(resolve, 1));\n      const fingerprint2 = CryptoUtils.createUserFingerprint();\n\n      expect(fingerprint1).toBeDefined();\n      expect(fingerprint2).toBeDefined();\n      expect(fingerprint1.length).toBe(16);\n      expect(fingerprint2.length).toBe(16);\n      // Fingerprints should be different due to timestamp\n      expect(fingerprint1).not.toBe(fingerprint2);\n    });\n  });\n  */\n\n  describe('Token Isolation', () => {\n    test('should isolate tokens between users', async () => {\n      const tokens1: OAuthTokens = {\n        accessToken: 'user1-access-token',\n        refreshToken: 'user1-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n      };\n\n      const tokens2: OAuthTokens = {\n        accessToken: 'user2-access-token',\n        refreshToken: 'user2-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n      };\n\n      const tokenManager1 = new TokenManager(oauthClient, 'user1');\n      const tokenManager2 = new TokenManager(oauthClient, 'user2');\n\n      await tokenManager1.storeTokens(tokens1, 'user1', ['tutorial:read']);\n      await tokenManager2.storeTokens(tokens2, 'user2', ['tutorial:read']);\n\n      const retrieved1 = await tokenManager1.getTokens('user1');\n      const retrieved2 = await tokenManager2.getTokens('user2');\n\n      expect(retrieved1!.accessToken).toBe(tokens1.accessToken);\n      expect(retrieved2!.accessToken).toBe(tokens2.accessToken);\n\n      // User1 cannot access User2's tokens\n      const crossAccess = await tokenManager1.getTokens('user2');\n      expect(crossAccess).toBeNull();\n    });\n  });\n});\n"],"version":3}