{"file":"/workspace/tests/integration/endpoint-discovery-integration.test.ts","mappings":"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","names":[],"sources":["/workspace/tests/integration/endpoint-discovery-integration.test.ts"],"sourcesContent":["/**\n * Endpoint Discovery Integration Tests\n *\n * Tests real-world endpoint discovery scenarios including:\n * - Successful discovery from .well-known endpoints\n * - Fallback to standard endpoints when discovery fails\n * - Network timeout and error handling\n * - Cache behavior and TTL validation\n * - Different server configurations and responses\n */\n\nimport {\n  describe,\n  test,\n  expect,\n  beforeEach,\n  jest,\n  beforeAll,\n  afterAll,\n} from '@jest/globals';\nimport {\n  discoverOAuthEndpoints,\n  clearDiscoveryCache,\n} from '@/auth/endpoint-discovery.js';\nimport { createServer } from 'http';\nimport type { Server } from 'http';\nimport type { AddressInfo } from 'net';\n\ndescribe('Endpoint Discovery Integration Tests', () => {\n  let mockServer: Server;\n  let serverPort: number;\n\n  beforeAll(async () => {\n    mockServer = await createDiscoveryTestServer();\n    const address = mockServer.address() as AddressInfo;\n    serverPort = address.port;\n  });\n\n  afterAll(async () => {\n    if (mockServer) {\n      await new Promise<void>(resolve => {\n        mockServer.close(() => resolve());\n      });\n    }\n  });\n\n  beforeEach(() => {\n    clearDiscoveryCache();\n    jest.clearAllMocks();\n  });\n\n  describe('Real Server Discovery Integration', () => {\n    test('should discover endpoints from real HTTP server with complete metadata', async () => {\n      setMockResponse('complete');\n\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 5000,\n        debug: true,\n      });\n\n      expect(endpoints.isFallback).toBe(false);\n      expect(endpoints.authorizationEndpoint).toBe(\n        `http://localhost:${serverPort}/oauth/authorize`\n      );\n      expect(endpoints.tokenEndpoint).toBe(\n        `http://localhost:${serverPort}/oauth/token`\n      );\n      expect(endpoints.issuer).toBe(`http://localhost:${serverPort}`);\n      expect(endpoints.discoveredAt).toBeInstanceOf(Date);\n      expect(endpoints.metadata).toBeDefined();\n      expect(endpoints.metadata!.code_challenge_methods_supported).toContain(\n        'S256'\n      );\n    });\n\n    test('should discover endpoints from real HTTP server with minimal metadata', async () => {\n      setMockResponse('minimal');\n\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 5000,\n      });\n\n      expect(endpoints.isFallback).toBe(false);\n      expect(endpoints.authorizationEndpoint).toBe(\n        `http://localhost:${serverPort}/oauth/authorize`\n      );\n      expect(endpoints.tokenEndpoint).toBe(\n        `http://localhost:${serverPort}/oauth/token`\n      );\n      expect(endpoints.issuer).toBe(`http://localhost:${serverPort}`);\n    });\n\n    test('should handle Drupal-specific endpoint paths', async () => {\n      setMockResponse('drupal');\n\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 5000,\n      });\n\n      expect(endpoints.isFallback).toBe(false);\n      expect(endpoints.authorizationEndpoint).toBe(\n        `http://localhost:${serverPort}/oauth/authorize`\n      );\n      expect(endpoints.tokenEndpoint).toBe(\n        `http://localhost:${serverPort}/oauth/token`\n      );\n    });\n  });\n\n  describe('Real Network Error Scenarios', () => {\n    test('should handle real server errors and fallback appropriately', async () => {\n      // Test 404 response from real server\n      setMockResponse('not_found');\n      const notFoundResult = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 2000,\n        retries: 1,\n      });\n      expect(notFoundResult.isFallback).toBe(true);\n      expect(notFoundResult.metadata).toBeUndefined();\n\n      // Test invalid JSON from real server\n      setMockResponse('invalid_json');\n      const invalidJsonResult = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 2000,\n        retries: 1,\n      });\n      expect(invalidJsonResult.isFallback).toBe(true);\n\n      // Test server error from real server\n      setMockResponse('server_error');\n      const serverErrorResult = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 2000,\n        retries: 1,\n      });\n      expect(serverErrorResult.isFallback).toBe(true);\n    });\n\n    test('should handle real network timeout scenarios', async () => {\n      setMockResponse('timeout');\n\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 100, // Very short timeout\n        retries: 0,\n      });\n\n      expect(endpoints.isFallback).toBe(true);\n    });\n  });\n\n  describe('Real-world Server Compatibility', () => {\n    test('should handle content-type variations', async () => {\n      setMockResponse('content_type_charset');\n\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n      });\n\n      expect(endpoints.isFallback).toBe(false);\n    });\n\n    test('should handle extra metadata fields gracefully', async () => {\n      setMockResponse('extra_fields');\n\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n      });\n\n      expect(endpoints.isFallback).toBe(false);\n      expect(endpoints.metadata).toBeDefined();\n    });\n\n    test('should work with different endpoint path conventions', async () => {\n      setMockResponse('different_paths');\n\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n      });\n\n      expect(endpoints.isFallback).toBe(false);\n      expect(endpoints.authorizationEndpoint).toBe(\n        `http://localhost:${serverPort}/auth/oauth2/authorize`\n      );\n      expect(endpoints.tokenEndpoint).toBe(\n        `http://localhost:${serverPort}/auth/oauth2/token`\n      );\n    });\n  });\n\n  describe('Configuration Options', () => {\n    test('should respect custom timeout settings', async () => {\n      setMockResponse('slow_response');\n\n      // Short timeout should cause fallback\n      const endpointsShortTimeout = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 100,\n        retries: 0,\n      });\n      expect(endpointsShortTimeout.isFallback).toBe(true);\n\n      clearDiscoveryCache();\n\n      // Longer timeout should succeed\n      const endpointsLongTimeout = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 2000,\n        retries: 0,\n      });\n      expect(endpointsLongTimeout.isFallback).toBe(false);\n    });\n\n    test('should respect retry configuration', async () => {\n      setMockResponse('intermittent_failure');\n\n      // No retries should fail quickly\n      const endpointsNoRetry = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        retries: 0,\n      });\n      expect(endpointsNoRetry.isFallback).toBe(true);\n\n      clearDiscoveryCache();\n\n      // Multiple retries should eventually succeed\n      const endpointsWithRetry = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        retries: 3,\n      });\n      expect(endpointsWithRetry.isFallback).toBe(false);\n    });\n\n    test('should support debug mode', async () => {\n      const consoleSpy = jest.spyOn(console, 'log').mockImplementation();\n\n      setMockResponse('complete');\n\n      await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        debug: true,\n      });\n\n      expect(consoleSpy).toHaveBeenCalledWith(\n        expect.stringContaining('[Discovery] Discovering OAuth endpoints')\n      );\n\n      consoleSpy.mockRestore();\n    });\n  });\n});\n\n// Mock server implementation with various response scenarios\nlet mockResponseType: string = 'complete';\nlet requestCount = 0;\n\nfunction setMockResponse(type: string): void {\n  mockResponseType = type;\n  requestCount = 0;\n}\n\nasync function createDiscoveryTestServer(): Promise<Server> {\n  return new Promise<Server>(resolve => {\n    const server = createServer((req, res) => {\n      const url = new URL(req.url || '', `http://localhost`);\n\n      if (url.pathname === '/.well-known/oauth-authorization-server') {\n        handleDiscoveryRequest(req, res);\n      } else {\n        res.writeHead(404);\n        res.end('Not found');\n      }\n    });\n\n    server.listen(0, '127.0.0.1', () => {\n      resolve(server);\n    });\n  });\n}\n\nfunction handleDiscoveryRequest(req: any, res: any): void {\n  requestCount++;\n  const address = req.socket.address();\n  const baseUrl = `http://localhost:${address.port}`;\n\n  switch (mockResponseType) {\n    case 'complete':\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end(\n        JSON.stringify({\n          issuer: baseUrl,\n          authorization_endpoint: `${baseUrl}/oauth/authorize`,\n          token_endpoint: `${baseUrl}/oauth/token`,\n          jwks_uri: `${baseUrl}/.well-known/jwks.json`,\n          scopes_supported: ['read', 'write', 'tutorial:read'],\n          response_types_supported: ['code'],\n          grant_types_supported: ['authorization_code', 'refresh_token'],\n          code_challenge_methods_supported: ['S256'],\n          token_endpoint_auth_methods_supported: ['none'],\n        })\n      );\n      break;\n\n    case 'minimal':\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end(\n        JSON.stringify({\n          issuer: baseUrl,\n          authorization_endpoint: `${baseUrl}/oauth/authorize`,\n          token_endpoint: `${baseUrl}/oauth/token`,\n        })\n      );\n      break;\n\n    case 'drupal':\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end(\n        JSON.stringify({\n          issuer: baseUrl,\n          authorization_endpoint: `${baseUrl}/oauth/authorize`,\n          token_endpoint: `${baseUrl}/oauth/token`,\n          scopes_supported: ['tutorial:read', 'user:profile'],\n          response_types_supported: ['code'],\n          grant_types_supported: ['authorization_code', 'refresh_token'],\n          code_challenge_methods_supported: ['S256'],\n        })\n      );\n      break;\n\n    case 'not_found':\n      res.writeHead(404);\n      res.end('Not Found');\n      break;\n\n    case 'invalid_json':\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end('{ invalid json');\n      break;\n\n    case 'missing_fields':\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end(\n        JSON.stringify({\n          issuer: baseUrl,\n          // Missing required authorization_endpoint and token_endpoint\n        })\n      );\n      break;\n\n    case 'server_error':\n      res.writeHead(500);\n      res.end('Internal Server Error');\n      break;\n\n    case 'timeout':\n      // Don't respond (simulate timeout)\n      break;\n\n    case 'content_type_charset':\n      res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });\n      res.end(\n        JSON.stringify({\n          issuer: baseUrl,\n          authorization_endpoint: `${baseUrl}/oauth/authorize`,\n          token_endpoint: `${baseUrl}/oauth/token`,\n        })\n      );\n      break;\n\n    case 'extra_fields':\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end(\n        JSON.stringify({\n          issuer: baseUrl,\n          authorization_endpoint: `${baseUrl}/oauth/authorize`,\n          token_endpoint: `${baseUrl}/oauth/token`,\n          custom_field: 'custom_value',\n          another_extension: { nested: 'data' },\n        })\n      );\n      break;\n\n    case 'different_paths':\n      res.writeHead(200, { 'Content-Type': 'application/json' });\n      res.end(\n        JSON.stringify({\n          issuer: baseUrl,\n          authorization_endpoint: `${baseUrl}/auth/oauth2/authorize`,\n          token_endpoint: `${baseUrl}/auth/oauth2/token`,\n        })\n      );\n      break;\n\n    case 'slow_response':\n      setTimeout(() => {\n        res.writeHead(200, { 'Content-Type': 'application/json' });\n        res.end(\n          JSON.stringify({\n            issuer: baseUrl,\n            authorization_endpoint: `${baseUrl}/oauth/authorize`,\n            token_endpoint: `${baseUrl}/oauth/token`,\n          })\n        );\n      }, 500); // 500ms delay\n      break;\n\n    case 'intermittent_failure':\n      if (requestCount <= 2) {\n        res.writeHead(500);\n        res.end('Temporary server error');\n      } else {\n        res.writeHead(200, { 'Content-Type': 'application/json' });\n        res.end(\n          JSON.stringify({\n            issuer: baseUrl,\n            authorization_endpoint: `${baseUrl}/oauth/authorize`,\n            token_endpoint: `${baseUrl}/oauth/token`,\n          })\n        );\n      }\n      break;\n\n    default:\n      res.writeHead(500);\n      res.end('Unknown mock response type');\n  }\n}\n"],"version":3}