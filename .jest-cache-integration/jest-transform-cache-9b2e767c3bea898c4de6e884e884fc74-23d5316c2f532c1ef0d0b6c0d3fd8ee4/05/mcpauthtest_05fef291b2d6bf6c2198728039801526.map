{"file":"/workspace/tests/integration/mcp-auth.test.ts","mappings":"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","names":[],"sources":["/workspace/tests/integration/mcp-auth.test.ts"],"sourcesContent":["/**\n * MCP Authentication Integration Tests (Fixed version)\n * Testing authentication tools and middleware with direct method calls\n */\n\nimport {\n  describe,\n  test,\n  expect,\n  beforeAll,\n  afterAll,\n  beforeEach,\n  afterEach,\n  jest,\n} from '@jest/globals';\nimport { DrupalMcpServer } from '@/mcp/server.js';\nimport type { AppConfig } from '@/types/index.js';\nimport { OAuthClient } from '@/auth/index.js';\nimport { tmpdir } from 'os';\n\ndescribe('MCP Authentication Integration Tests', () => {\n  let testConfig: AppConfig;\n  let mcpServer: DrupalMcpServer;\n  let originalHomedir: string | undefined;\n\n  beforeAll(() => {\n    originalHomedir = process.env.HOME;\n    process.env.HOME = tmpdir();\n\n    testConfig = {\n      drupal: {\n        baseUrl: 'http://localhost/drupal',\n        endpoint: '/jsonrpc',\n        timeout: 10000,\n        retries: 3,\n        headers: {\n          'Content-Type': 'application/json',\n          Accept: 'application/json',\n        },\n      },\n      oauth: {\n        clientId: 'test-client-id',\n        authorizationEndpoint: 'http://localhost/drupal/oauth/authorize',\n        tokenEndpoint: 'http://localhost/drupal/oauth/token',\n        redirectUri: 'http://127.0.0.1:3000/callback',\n        scopes: ['tutorial:read', 'user:profile'],\n      },\n      auth: {\n        enabled: true,\n        requiredScopes: ['tutorial:read'],\n        skipAuth: false,\n      },\n      mcp: {\n        name: 'test-drupal-bridge-mcp',\n        version: '1.0.0-test',\n        protocolVersion: '2024-11-05',\n        capabilities: {\n          resources: { subscribe: true, listChanged: true },\n          tools: { listChanged: true },\n          prompts: { listChanged: true },\n        },\n      },\n      server: {\n        port: 3000,\n        host: '0.0.0.0',\n      },\n      logging: {\n        level: 'error' as const,\n      },\n      environment: 'test' as const,\n    };\n  });\n\n  afterAll(() => {\n    process.env.HOME = originalHomedir;\n  });\n\n  beforeEach(async () => {\n    mcpServer = new DrupalMcpServer(testConfig);\n\n    // Clean up test tokens before each test\n    try {\n      const { promises: fs } = await import('fs');\n      const { join } = await import('path');\n      await fs.rm(join(tmpdir(), '.drupal-bridge-mcp'), {\n        recursive: true,\n        force: true,\n      });\n    } catch {\n      // Ignore if directory doesn't exist\n    }\n  });\n\n  afterEach(async () => {\n    await mcpServer.close();\n  });\n\n  describe('Authentication Tools', () => {\n    test('should list authentication tools', async () => {\n      // Test tool listing directly\n      const tools = (mcpServer as any).getTools();\n\n      const authTools = tools.filter((tool: any) =>\n        tool.name.startsWith('auth_')\n      );\n\n      expect(authTools).toHaveLength(3);\n      expect(authTools.some((tool: any) => tool.name === 'auth_login')).toBe(\n        true\n      );\n      expect(authTools.some((tool: any) => tool.name === 'auth_status')).toBe(\n        true\n      );\n      expect(authTools.some((tool: any) => tool.name === 'auth_logout')).toBe(\n        true\n      );\n    });\n\n    test('should handle auth_status without authentication', async () => {\n      // Call the auth tool directly\n      const response = await (mcpServer as any).executeAuthTool(\n        'auth_status',\n        {}\n      );\n\n      expect(response.content).toBeDefined();\n      expect(response.content[0].type).toBe('text');\n\n      const result = JSON.parse(response.content[0].text);\n      expect(result.isAuthenticated).toBe(false);\n      expect(result.needsAuthentication).toBe(true);\n    });\n\n    test('should handle auth_logout', async () => {\n      // Call the auth tool directly\n      const response = await (mcpServer as any).executeAuthTool(\n        'auth_logout',\n        {}\n      );\n\n      expect(response.content).toBeDefined();\n      expect(response.content[0].type).toBe('text');\n\n      const result = JSON.parse(response.content[0].text);\n      expect(result.success).toBe(true);\n      expect(result.message).toBe('Logout successful');\n    });\n  });\n\n  describe('Authentication Middleware', () => {\n    test('should require authentication for protected tools when auth is enabled', async () => {\n      // Test with auth enabled config\n      const authEnabledConfig = {\n        ...testConfig,\n        auth: { ...testConfig.auth, enabled: true, skipAuth: false },\n      };\n      const authServer = new DrupalMcpServer(authEnabledConfig);\n\n      // Call executeToolWithAuth which includes the authentication check\n      const response = await (authServer as any).executeToolWithAuth(\n        'load_node',\n        { nodeId: '1' }\n      );\n\n      // Should return an MCP-formatted error response\n      expect(response.content).toBeDefined();\n      expect(response.content[0].type).toBe('text');\n\n      const errorResponse = JSON.parse(response.content[0].text);\n      expect(errorResponse.error).toBeDefined();\n      expect(errorResponse.error.message).toContain('authenticate');\n\n      await authServer.close();\n    });\n\n    test('should allow tools when authentication is skipped', async () => {\n      const skipAuthConfig = {\n        ...testConfig,\n        auth: {\n          ...testConfig.auth,\n          skipAuth: true,\n        },\n      };\n\n      const skipAuthServer = new DrupalMcpServer(skipAuthConfig);\n\n      // This should not require authentication\n      const response = await (skipAuthServer as any).executeTool(\n        'test_connection',\n        {}\n      );\n\n      expect(response.content).toBeDefined();\n      expect(response.content[0].type).toBe('text');\n\n      const result = JSON.parse(response.content[0].text);\n\n      // Should succeed without authentication error\n      expect(result.connected).toBeDefined();\n      expect(result.config).toBeDefined();\n\n      await skipAuthServer.close();\n    });\n  });\n\n  describe('Session Management', () => {\n    test('should create session after successful authentication', async () => {\n      // Mock the OAuth client authorize method\n      const mockTokens = {\n        access_token: 'mock-access-token',\n        refresh_token: 'mock-refresh-token',\n        token_type: 'Bearer',\n        expires_in: 3600,\n      };\n\n      jest\n        .spyOn((mcpServer as any).oauthClient, 'authorize')\n        .mockResolvedValue(mockTokens);\n\n      const response = await (mcpServer as any).executeAuthTool(\n        'auth_login',\n        {}\n      );\n\n      expect(response.content).toBeDefined();\n      const result = JSON.parse(response.content[0].text);\n      expect(result.success).toBe(true);\n    });\n\n    test('should handle authentication failure gracefully', async () => {\n      // Mock the OAuth client to throw an error\n      jest\n        .spyOn((mcpServer as any).oauthClient, 'authorize')\n        .mockRejectedValue(new Error('Authentication failed'));\n\n      const response = await (mcpServer as any).executeAuthTool(\n        'auth_login',\n        {}\n      );\n\n      expect(response.content).toBeDefined();\n      const result = JSON.parse(response.content[0].text);\n      expect(result.success).toBe(false);\n      expect(result.error).toContain('Authentication failed');\n    });\n  });\n\n  describe('Token Integration with Drupal Client', () => {\n    test('should set access token on Drupal client after authentication', async () => {\n      const mockTokens = {\n        accessToken: 'test-access-token',\n        refreshToken: 'test-refresh-token',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n      };\n\n      jest\n        .spyOn((mcpServer as any).oauthClient, 'authorize')\n        .mockResolvedValue(mockTokens);\n\n      jest.spyOn((mcpServer as any).drupalClient, 'setAccessToken');\n\n      // First authenticate\n      await (mcpServer as any).executeAuthTool('auth_login', {});\n\n      // Verify that the Drupal client received the access token\n      expect(\n        (mcpServer as any).drupalClient.setAccessToken\n      ).toHaveBeenCalledWith('test-access-token');\n    });\n\n    test('should clear access token on logout', async () => {\n      // Set up initial authentication state\n      jest.spyOn((mcpServer as any).drupalClient, 'clearAccessToken');\n\n      await (mcpServer as any).executeAuthTool('auth_logout', {});\n\n      expect(\n        (mcpServer as any).drupalClient.clearAccessToken\n      ).toHaveBeenCalled();\n    });\n  });\n\n  describe('Error Handling', () => {\n    test('should return proper MCP error format for authentication errors', async () => {\n      // Test with auth enabled and no authentication\n      const authEnabledConfig = {\n        ...testConfig,\n        auth: { ...testConfig.auth, enabled: true, skipAuth: false },\n      };\n      const authServer = new DrupalMcpServer(authEnabledConfig);\n\n      const response = await (authServer as any).executeTool('load_node', {\n        nodeId: '1',\n      });\n\n      expect(response.content).toBeDefined();\n      expect(response.content[0].type).toBe('text');\n\n      const result = JSON.parse(response.content[0].text);\n      expect(result.error).toBeDefined();\n      expect(result.error.type).toBeDefined();\n\n      await authServer.close();\n    });\n\n    test('should handle OAuth flow errors in auth tools', async () => {\n      const oauthError = new Error('OAuth flow failed');\n      jest\n        .spyOn((mcpServer as any).oauthClient, 'authorize')\n        .mockRejectedValue(oauthError);\n\n      const response = await (mcpServer as any).executeAuthTool(\n        'auth_login',\n        {}\n      );\n\n      expect(response.content).toBeDefined();\n      const result = JSON.parse(response.content[0].text);\n      expect(result.success).toBe(false);\n      expect(result.error).toContain('OAuth flow failed');\n    });\n  });\n\n  describe('Cross-Client Compatibility', () => {\n    test('should work consistently across different MCP client environments', async () => {\n      // Test tool listing\n      const tools = (mcpServer as any).getTools();\n      expect(Array.isArray(tools)).toBe(true);\n      expect(tools.length).toBeGreaterThan(0);\n\n      // Test auth status\n      const authStatusResponse = await (mcpServer as any).executeAuthTool(\n        'auth_status',\n        {}\n      );\n      expect(authStatusResponse.content).toBeDefined();\n      expect(authStatusResponse.content[0].type).toBe('text');\n\n      const authStatus = JSON.parse(authStatusResponse.content[0].text);\n      expect(typeof authStatus.isAuthenticated).toBe('boolean');\n      expect(typeof authStatus.needsAuthentication).toBe('boolean');\n    });\n  });\n});\n"],"version":3}