{"file":"/workspace/src/config/index.ts","mappings":"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","names":[],"sources":["/workspace/src/config/index.ts"],"sourcesContent":["/**\n * Configuration management for the MCP server\n */\n\nimport type { DrupalClientConfig, McpServerInfo } from '@/types/index.js';\nimport type { DiscoveryConfig, OAuthEndpoints } from '@/auth/types.js';\nimport { discoverOAuthEndpoints } from '@/auth/endpoint-discovery.js';\nimport {\n  McpOAuthProvider,\n  type McpOAuthConfig,\n} from '@/auth/oauth-provider.js';\n\n/**\n * Simplified OAuth configuration interface\n * Supports both legacy static configuration and new discovery-based configuration\n */\nexport interface SimplifiedOAuthConfig {\n  readonly clientId: string;\n  readonly authorizationEndpoint?: string; // Optional for discovery\n  readonly tokenEndpoint?: string; // Optional for discovery\n  readonly redirectUri: string;\n  readonly scopes: string[];\n  readonly serverUrl: string; // Base URL for MCP OAuth provider\n  readonly discoveredEndpoints?: OAuthEndpoints; // Populated during configuration loading\n}\n\n/**\n * Application configuration interface\n */\nexport interface AppConfig {\n  readonly drupal: DrupalClientConfig;\n  readonly mcp: McpServerInfo;\n  readonly oauth: SimplifiedOAuthConfig;\n  readonly auth: {\n    readonly enabled: boolean;\n    readonly requiredScopes: string[];\n    readonly skipAuth: boolean;\n  };\n  readonly server: {\n    readonly port: number;\n    readonly host: string;\n  };\n  readonly logging: {\n    readonly level: 'error' | 'warn' | 'info' | 'debug';\n  };\n  readonly environment: 'development' | 'test' | 'production';\n  readonly discovery: DiscoveryConfig;\n}\n\n/**\n * Environment variables with defaults\n */\nconst getEnvConfig = (): AppConfig => {\n  const drupalBaseUrl =\n    process.env.DRUPAL_BASE_URL ?? 'http://localhost/drupal';\n  const drupalEndpoint = process.env.DRUPAL_JSON_RPC_ENDPOINT ?? '/jsonrpc';\n\n  return {\n    drupal: {\n      baseUrl: drupalBaseUrl,\n      endpoint: drupalEndpoint,\n      timeout: parseInt(process.env.DRUPAL_TIMEOUT ?? '10000', 10),\n      retries: parseInt(process.env.DRUPAL_RETRIES ?? '3', 10),\n      headers: {\n        'Content-Type': 'application/json',\n        Accept: 'application/json',\n      },\n    },\n    oauth: {\n      clientId: process.env.OAUTH_CLIENT_ID ?? '',\n      // Support legacy static configuration for backward compatibility\n      authorizationEndpoint: process.env.OAUTH_AUTHORIZATION_ENDPOINT,\n      tokenEndpoint: process.env.OAUTH_TOKEN_ENDPOINT,\n      redirectUri:\n        process.env.OAUTH_REDIRECT_URI ?? 'urn:ietf:wg:oauth:2.0:oob',\n      scopes: (\n        process.env.OAUTH_SCOPES ?? 'tutorial:read user:profile tutorial:search'\n      ).split(' '),\n      serverUrl: drupalBaseUrl,\n    },\n    auth: {\n      enabled: process.env.AUTH_ENABLED !== 'false',\n      requiredScopes: (\n        process.env.AUTH_REQUIRED_SCOPES ?? 'tutorial:read'\n      ).split(' '),\n      skipAuth:\n        process.env.AUTH_SKIP === 'true' ||\n        process.env.NODE_ENV === 'development',\n    },\n    mcp: {\n      name: process.env.MCP_SERVER_NAME ?? 'drupal-bridge-mcp',\n      version: process.env.MCP_SERVER_VERSION ?? '1.0.0',\n      protocolVersion: '2024-11-05',\n      capabilities: {\n        resources: {\n          subscribe: true,\n          listChanged: true,\n        },\n        tools: {\n          listChanged: true,\n        },\n        prompts: {\n          listChanged: true,\n        },\n      },\n    },\n    server: {\n      port: parseInt(process.env.PORT ?? '3000', 10),\n      host: process.env.HOST ?? '0.0.0.0',\n    },\n    logging: {\n      level: (process.env.LOG_LEVEL as AppConfig['logging']['level']) ?? 'info',\n    },\n    environment:\n      (process.env.NODE_ENV as AppConfig['environment']) ?? 'development',\n    discovery: {\n      baseUrl: drupalBaseUrl,\n      timeout: parseInt(process.env.OAUTH_DISCOVERY_TIMEOUT ?? '5000', 10),\n      retries: parseInt(process.env.OAUTH_DISCOVERY_RETRIES ?? '2', 10),\n      cacheTtl: parseInt(\n        process.env.OAUTH_DISCOVERY_CACHE_TTL ?? '3600000',\n        10\n      ), // 1 hour\n      validateHttps: process.env.OAUTH_DISCOVERY_VALIDATE_HTTPS !== 'false',\n      debug: process.env.OAUTH_DISCOVERY_DEBUG === 'true',\n    },\n  };\n};\n\n/**\n * Validate configuration\n */\nconst validateConfig = (config: AppConfig): void => {\n  if (!config.drupal.baseUrl) {\n    throw new Error('DRUPAL_BASE_URL is required');\n  }\n\n  if (!config.drupal.endpoint) {\n    throw new Error('DRUPAL_JSON_RPC_ENDPOINT is required');\n  }\n\n  if (!config.mcp.name) {\n    throw new Error('MCP_SERVER_NAME is required');\n  }\n\n  if (!config.mcp.version) {\n    throw new Error('MCP_SERVER_VERSION is required');\n  }\n\n  if (config.auth.enabled) {\n    if (!config.oauth.clientId) {\n      throw new Error(\n        'OAUTH_CLIENT_ID is required when authentication is enabled'\n      );\n    }\n\n    // For simplified configuration, only DRUPAL_BASE_URL and OAUTH_CLIENT_ID are required\n    // Endpoints will be discovered or fallback to defaults\n    if (!config.drupal.baseUrl) {\n      throw new Error(\n        'DRUPAL_BASE_URL is required for OAuth endpoint discovery'\n      );\n    }\n  }\n\n  if (config.server.port < 1 || config.server.port > 65535) {\n    throw new Error('PORT must be between 1 and 65535');\n  }\n};\n\n/**\n * Load and validate configuration with OAuth endpoint discovery\n */\nexport const loadConfig = async (): Promise<AppConfig> => {\n  try {\n    // Try to load .env file in development\n    if (process.env.NODE_ENV !== 'production') {\n      await import('dotenv/config');\n    }\n  } catch {\n    // dotenv is optional, continue without it\n  }\n\n  const config = getEnvConfig();\n  validateConfig(config);\n\n  // Perform OAuth endpoint discovery if authentication is enabled and endpoints are not explicitly configured\n  if (config.auth.enabled && !process.env.OAUTH_SKIP_DISCOVERY) {\n    // Only discover endpoints if legacy static configuration is not provided\n    const hasStaticConfig =\n      config.oauth.authorizationEndpoint && config.oauth.tokenEndpoint;\n\n    if (!hasStaticConfig) {\n      try {\n        const discoveredEndpoints = await discoverOAuthEndpoints(\n          config.discovery\n        );\n\n        // Update OAuth config with discovered endpoints and store discovery result\n        (config as { oauth: SimplifiedOAuthConfig }).oauth = {\n          ...config.oauth,\n          authorizationEndpoint: discoveredEndpoints.authorizationEndpoint,\n          tokenEndpoint: discoveredEndpoints.tokenEndpoint,\n          discoveredEndpoints,\n        };\n\n        if (config.discovery.debug) {\n          console.log('[Config] OAuth endpoints discovered:', {\n            authorization: discoveredEndpoints.authorizationEndpoint,\n            token: discoveredEndpoints.tokenEndpoint,\n            isFallback: discoveredEndpoints.isFallback,\n          });\n        }\n      } catch (error) {\n        if (config.discovery.debug) {\n          console.warn(\n            '[Config] OAuth endpoint discovery failed, using fallback endpoints:',\n            error\n          );\n        }\n\n        // Use fallback endpoints when discovery fails\n        const fallbackAuthEndpoint = `${config.drupal.baseUrl}/oauth/authorize`;\n        const fallbackTokenEndpoint = `${config.drupal.baseUrl}/oauth/token`;\n\n        (config as { oauth: SimplifiedOAuthConfig }).oauth = {\n          ...config.oauth,\n          authorizationEndpoint: fallbackAuthEndpoint,\n          tokenEndpoint: fallbackTokenEndpoint,\n        };\n      }\n    } else {\n      if (config.discovery.debug) {\n        console.log('[Config] Using static OAuth endpoint configuration');\n      }\n    }\n  }\n\n  return config;\n};\n\n/**\n * Get full Drupal JSON-RPC URL\n */\nexport const getDrupalJsonRpcUrl = (config: AppConfig): string => {\n  const { baseUrl, endpoint } = config.drupal;\n  return new URL(endpoint, baseUrl).toString();\n};\n\n/**\n * Create McpOAuthProvider from simplified configuration\n */\nexport const createOAuthProvider = (\n  config: AppConfig,\n  userId = 'default'\n): McpOAuthProvider => {\n  const oauthConfig: McpOAuthConfig = {\n    clientId: config.oauth.clientId,\n    authorizationEndpoint:\n      config.oauth.authorizationEndpoint ||\n      `${config.oauth.serverUrl}/oauth/authorize`,\n    redirectUri: config.oauth.redirectUri,\n    scopes: config.oauth.scopes,\n    serverUrl: config.oauth.serverUrl,\n  };\n\n  return new McpOAuthProvider(oauthConfig, userId);\n};\n"],"version":3}