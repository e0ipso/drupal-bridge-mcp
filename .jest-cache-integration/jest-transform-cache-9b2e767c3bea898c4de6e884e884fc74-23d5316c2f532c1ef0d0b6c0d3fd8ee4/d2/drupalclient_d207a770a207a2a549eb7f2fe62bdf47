9c48ba815a04a4992f4c961e29f786e1
"use strict";
/**
 * Drupal JSON-RPC client service using json-rpc-2.0 library
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.DrupalClient = exports.DrupalClientError = void 0;
const json_rpc_2_0_1 = require("json-rpc-2.0");
const index_js_1 = require("@/types/index.js");
const error_handler_js_1 = require("@/utils/error-handler.js");
/**
 * Custom error for Drupal client operations
 */
class DrupalClientError extends Error {
    code;
    originalError;
    constructor(message, code, originalError) {
        super(message);
        this.code = code;
        this.originalError = originalError;
        this.name = 'DrupalClientError';
    }
}
exports.DrupalClientError = DrupalClientError;
/**
 * Drupal JSON-RPC client implementation
 */
class DrupalClient {
    config;
    client;
    baseUrl;
    timeout;
    retries;
    headers;
    requestCounter = 0;
    constructor(config) {
        this.config = config;
        this.baseUrl = new URL(config.endpoint, config.baseUrl).toString();
        this.timeout = config.timeout ?? 30000; // 30 second timeout for Drupal response times
        this.retries = config.retries ?? 3;
        this.headers = {
            'Content-Type': 'application/json',
            Accept: 'application/json',
            ...config.headers,
        };
        // Initialize JSON-RPC client with HTTP transport
        this.client = new json_rpc_2_0_1.JSONRPCClient(async (jsonRPCRequest) => {
            return this.makeHttpRequest(jsonRPCRequest);
        });
    }
    /**
     * Set access token for authenticated requests
     */
    setAccessToken(token) {
        this.headers['Authorization'] = `Bearer ${token}`;
    }
    /**
     * Clear access token
     */
    clearAccessToken() {
        delete this.headers['Authorization'];
    }
    /**
     * Make HTTP request with retry logic
     */
    async makeHttpRequest(jsonRPCRequest) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);
        const requestId = this.generateRequestId();
        let lastError;
        for (let attempt = 1; attempt <= this.retries; attempt++) {
            try {
                const response = await fetch(this.baseUrl, {
                    method: 'POST',
                    headers: this.headers,
                    body: JSON.stringify(jsonRPCRequest),
                    signal: controller.signal,
                });
                clearTimeout(timeoutId);
                if (response.status === 200) {
                    const contentType = response.headers.get('content-type');
                    if (!contentType?.includes('application/json')) {
                        throw new error_handler_js_1.IntegrationError(error_handler_js_1.IntegrationErrorType.MALFORMED_RESPONSE, `Invalid content-type: expected application/json, got ${contentType}`, response.status, undefined, { expected: 'application/json', received: contentType }, undefined, false);
                    }
                    let jsonRPCResponse;
                    try {
                        jsonRPCResponse = await response.json();
                    }
                    catch (parseError) {
                        throw new error_handler_js_1.IntegrationError(error_handler_js_1.IntegrationErrorType.PARSE_ERROR, 'Failed to parse JSON response', response.status, undefined, { parseError: String(parseError) }, parseError, false);
                    }
                    // Validate JSON-RPC response format
                    if (!jsonRPCResponse ||
                        typeof jsonRPCResponse !== 'object' ||
                        !('jsonrpc' in jsonRPCResponse)) {
                        throw new error_handler_js_1.IntegrationError(error_handler_js_1.IntegrationErrorType.MALFORMED_RESPONSE, 'Invalid JSON-RPC response: missing jsonrpc field', undefined, undefined, { response: jsonRPCResponse }, undefined, false);
                    }
                    const rpcResponse = jsonRPCResponse;
                    if (rpcResponse.jsonrpc !== '2.0') {
                        throw new error_handler_js_1.IntegrationError(error_handler_js_1.IntegrationErrorType.MALFORMED_RESPONSE, `Invalid JSON-RPC version: expected "2.0", got "${rpcResponse.jsonrpc}"`, undefined, undefined, { expected: '2.0', received: rpcResponse.jsonrpc }, undefined, false);
                    }
                    // Check for JSON-RPC errors in the response
                    if ((0, index_js_1.isJsonRpcErrorResponse)(rpcResponse)) {
                        throw (0, error_handler_js_1.parseJsonRpcError)(rpcResponse, requestId);
                    }
                    this.client.receive(rpcResponse);
                    return;
                }
                else {
                    // Handle HTTP error responses
                    let errorText = '';
                    try {
                        errorText = await response.text();
                    }
                    catch {
                        errorText = 'Unable to read error response';
                    }
                    const errorType = response.status >= 500
                        ? error_handler_js_1.IntegrationErrorType.SERVER_UNAVAILABLE
                        : response.status === 429
                            ? error_handler_js_1.IntegrationErrorType.RATE_LIMIT_ERROR
                            : response.status === 401 || response.status === 403
                                ? error_handler_js_1.IntegrationErrorType.AUTHENTICATION_ERROR
                                : error_handler_js_1.IntegrationErrorType.VALIDATION_ERROR;
                    throw new error_handler_js_1.IntegrationError(errorType, `HTTP ${response.status}: ${response.statusText}`, response.status, undefined, { statusText: response.statusText, responseBody: errorText }, undefined, response.status >= 500 || response.status === 429);
                }
            }
            catch (error) {
                // Normalize the error to IntegrationError
                if (error instanceof error_handler_js_1.IntegrationError) {
                    lastError = error;
                }
                else {
                    lastError = (0, error_handler_js_1.normalizeError)(error, `HTTP request attempt ${attempt}/${this.retries}`, requestId);
                }
                // Don't retry on timeout/abort errors or non-retryable errors
                if (lastError.errorType === error_handler_js_1.IntegrationErrorType.TIMEOUT_ERROR ||
                    !lastError.retryable) {
                    throw lastError;
                }
                if (attempt === this.retries) {
                    break;
                }
                // Exponential backoff for retryable errors
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        clearTimeout(timeoutId);
        if (lastError) {
            // Wrap the final error with retry context
            throw new error_handler_js_1.IntegrationError(lastError.errorType, `Failed after ${this.retries} attempts: ${lastError.message}`, lastError.code, lastError.field, {
                ...lastError.details,
                attempts: this.retries,
                originalError: lastError,
            }, lastError, false // No more retries available
            );
        }
    }
    /**
     * Generate unique request ID for tracing
     */
    generateRequestId() {
        return `req-${Date.now()}-${++this.requestCounter}`;
    }
    /**
     * Make a JSON-RPC request with error handling
     */
    async request(method, params) {
        const requestId = this.generateRequestId();
        try {
            const result = await this.client.request(method, params);
            return result;
        }
        catch (error) {
            // The error has already been processed by makeHttpRequest, so we just need to normalize it
            if (error instanceof error_handler_js_1.IntegrationError) {
                throw error;
            }
            // Handle any unexpected errors from the JSON-RPC client itself
            const normalizedError = (0, error_handler_js_1.normalizeError)(error, `JSON-RPC method: ${method}`, requestId);
            // Check if this error contains JSON-RPC error information
            if (error &&
                typeof error === 'object' &&
                'code' in error &&
                'message' in error) {
                const rpcError = error;
                const jsonRpcErrorResponse = {
                    jsonrpc: '2.0',
                    error: {
                        code: rpcError.code,
                        message: rpcError.message,
                        data: rpcError.data,
                    },
                    id: null,
                };
                throw (0, error_handler_js_1.parseJsonRpcError)(jsonRpcErrorResponse, requestId);
            }
            throw normalizedError;
        }
    }
    /**
     * Load an entity by type and ID
     */
    async loadEntity(entityType, entityId) {
        const params = {
            entity_type: entityType,
            entity_id: entityId,
        };
        return this.request('entity.load', params);
    }
    /**
     * Query entities with conditions
     */
    async queryEntities(entityType, conditions, options) {
        const params = {
            entity_type: entityType,
            conditions,
            ...options,
        };
        return this.request('entity.query', params);
    }
    /**
     * Load a node by ID
     */
    async loadNode(nodeId) {
        return this.loadEntity('node', nodeId);
    }
    /**
     * Create a new node
     */
    async createNode(params) {
        return this.request('node.create', params);
    }
    /**
     * Update an existing node
     */
    async updateNode(nodeId, updates) {
        const params = {
            nid: nodeId,
            ...updates,
        };
        return this.request('node.update', params);
    }
    /**
     * Delete a node
     */
    async deleteNode(nodeId) {
        const params = { nid: nodeId };
        return this.request('node.delete', params);
    }
    /**
     * Get nodes with optional filtering
     */
    async getNodes(options) {
        const conditions = {};
        if (options?.type)
            conditions.type = options.type;
        if (options?.status !== undefined)
            conditions.status = options.status;
        return this.queryEntities('node', conditions, {
            limit: options?.limit,
            offset: options?.offset,
        });
    }
    /**
     * Test connection to Drupal
     */
    async testConnection() {
        try {
            await this.request('system.connect');
            return true;
        }
        catch {
            return false;
        }
    }
    /**
     * Search tutorials using JSON-RPC dme_mcp.search_content method
     */
    async searchTutorials(params) {
        const requestParams = {
            keywords: params.keywords,
            types: params.types || ['tutorial', 'topic', 'course'],
            drupal_version: params.drupal_version,
            category: params.category,
            sort: params.sort || 'search_api_relevance',
            page: params.page || { limit: 10, offset: 0 },
        };
        return this.request('dme_mcp.search_content', requestParams);
    }
    /**
     * Get server configuration
     */
    getConfig() {
        return { ...this.config };
    }
}
exports.DrupalClient = DrupalClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL3dvcmtzcGFjZS9zcmMvc2VydmljZXMvZHJ1cGFsLWNsaWVudC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7OztBQUVILCtDQUE2QztBQUM3QywrQ0FTMEI7QUFDMUIsK0RBS2tDO0FBRWxDOztHQUVHO0FBQ0gsTUFBYSxpQkFBa0IsU0FBUSxLQUFLO0lBR3hCO0lBQ0E7SUFIbEIsWUFDRSxPQUFlLEVBQ0MsSUFBYSxFQUNiLGFBQXVCO1FBRXZDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUhDLFNBQUksR0FBSixJQUFJLENBQVM7UUFDYixrQkFBYSxHQUFiLGFBQWEsQ0FBVTtRQUd2QyxJQUFJLENBQUMsSUFBSSxHQUFHLG1CQUFtQixDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQVRELDhDQVNDO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLFlBQVk7SUFRTTtJQVBaLE1BQU0sQ0FBZ0I7SUFDdEIsT0FBTyxDQUFTO0lBQ2hCLE9BQU8sQ0FBUztJQUNoQixPQUFPLENBQVM7SUFDaEIsT0FBTyxDQUF5QjtJQUN6QyxjQUFjLEdBQUcsQ0FBQyxDQUFDO0lBRTNCLFlBQTZCLE1BQTBCO1FBQTFCLFdBQU0sR0FBTixNQUFNLENBQW9CO1FBQ3JELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDbkUsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxDQUFDLDhDQUE4QztRQUN0RixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDYixjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLE1BQU0sRUFBRSxrQkFBa0I7WUFDMUIsR0FBRyxNQUFNLENBQUMsT0FBTztTQUNsQixDQUFDO1FBRUYsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSw0QkFBYSxDQUFDLEtBQUssRUFBQyxjQUFjLEVBQUMsRUFBRTtZQUNyRCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjLENBQUMsS0FBYTtRQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxHQUFHLFVBQVUsS0FBSyxFQUFFLENBQUM7SUFDcEQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZ0JBQWdCO1FBQ2QsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNLLEtBQUssQ0FBQyxlQUFlLENBQUMsY0FBdUI7UUFDbkQsTUFBTSxVQUFVLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQztRQUN6QyxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNyRSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUUzQyxJQUFJLFNBQXVDLENBQUM7UUFFNUMsS0FBSyxJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQUUsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQztZQUN6RCxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtvQkFDekMsTUFBTSxFQUFFLE1BQU07b0JBQ2QsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO29CQUNyQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUM7b0JBQ3BDLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtpQkFDMUIsQ0FBQyxDQUFDO2dCQUVILFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFFeEIsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO29CQUM1QixNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFDekQsSUFBSSxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFDO3dCQUMvQyxNQUFNLElBQUksbUNBQWdCLENBQ3hCLHVDQUFvQixDQUFDLGtCQUFrQixFQUN2Qyx3REFBd0QsV0FBVyxFQUFFLEVBQ3JFLFFBQVEsQ0FBQyxNQUFNLEVBQ2YsU0FBUyxFQUNULEVBQUUsUUFBUSxFQUFFLGtCQUFrQixFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsRUFDdkQsU0FBUyxFQUNULEtBQUssQ0FDTixDQUFDO29CQUNKLENBQUM7b0JBRUQsSUFBSSxlQUF3QixDQUFDO29CQUM3QixJQUFJLENBQUM7d0JBQ0gsZUFBZSxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO29CQUMxQyxDQUFDO29CQUFDLE9BQU8sVUFBVSxFQUFFLENBQUM7d0JBQ3BCLE1BQU0sSUFBSSxtQ0FBZ0IsQ0FDeEIsdUNBQW9CLENBQUMsV0FBVyxFQUNoQywrQkFBK0IsRUFDL0IsUUFBUSxDQUFDLE1BQU0sRUFDZixTQUFTLEVBQ1QsRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQ2xDLFVBQVUsRUFDVixLQUFLLENBQ04sQ0FBQztvQkFDSixDQUFDO29CQUVELG9DQUFvQztvQkFDcEMsSUFDRSxDQUFDLGVBQWU7d0JBQ2hCLE9BQU8sZUFBZSxLQUFLLFFBQVE7d0JBQ25DLENBQUMsQ0FBQyxTQUFTLElBQUksZUFBZSxDQUFDLEVBQy9CLENBQUM7d0JBQ0QsTUFBTSxJQUFJLG1DQUFnQixDQUN4Qix1Q0FBb0IsQ0FBQyxrQkFBa0IsRUFDdkMsa0RBQWtELEVBQ2xELFNBQVMsRUFDVCxTQUFTLEVBQ1QsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFLEVBQzdCLFNBQVMsRUFDVCxLQUFLLENBQ04sQ0FBQztvQkFDSixDQUFDO29CQUVELE1BQU0sV0FBVyxHQUFHLGVBQWtDLENBQUM7b0JBQ3ZELElBQUksV0FBVyxDQUFDLE9BQU8sS0FBSyxLQUFLLEVBQUUsQ0FBQzt3QkFDbEMsTUFBTSxJQUFJLG1DQUFnQixDQUN4Qix1Q0FBb0IsQ0FBQyxrQkFBa0IsRUFDdkMsa0RBQWtELFdBQVcsQ0FBQyxPQUFPLEdBQUcsRUFDeEUsU0FBUyxFQUNULFNBQVMsRUFDVCxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFdBQVcsQ0FBQyxPQUFPLEVBQUUsRUFDbEQsU0FBUyxFQUNULEtBQUssQ0FDTixDQUFDO29CQUNKLENBQUM7b0JBRUQsNENBQTRDO29CQUM1QyxJQUFJLElBQUEsaUNBQXNCLEVBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQzt3QkFDeEMsTUFBTSxJQUFBLG9DQUFpQixFQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDbEQsQ0FBQztvQkFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUE4QixDQUFDLENBQUM7b0JBQ3BELE9BQU87Z0JBQ1QsQ0FBQztxQkFBTSxDQUFDO29CQUNOLDhCQUE4QjtvQkFDOUIsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO29CQUNuQixJQUFJLENBQUM7d0JBQ0gsU0FBUyxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO29CQUNwQyxDQUFDO29CQUFDLE1BQU0sQ0FBQzt3QkFDUCxTQUFTLEdBQUcsK0JBQStCLENBQUM7b0JBQzlDLENBQUM7b0JBRUQsTUFBTSxTQUFTLEdBQ2IsUUFBUSxDQUFDLE1BQU0sSUFBSSxHQUFHO3dCQUNwQixDQUFDLENBQUMsdUNBQW9CLENBQUMsa0JBQWtCO3dCQUN6QyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHOzRCQUN2QixDQUFDLENBQUMsdUNBQW9CLENBQUMsZ0JBQWdCOzRCQUN2QyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHO2dDQUNsRCxDQUFDLENBQUMsdUNBQW9CLENBQUMsb0JBQW9CO2dDQUMzQyxDQUFDLENBQUMsdUNBQW9CLENBQUMsZ0JBQWdCLENBQUM7b0JBRWhELE1BQU0sSUFBSSxtQ0FBZ0IsQ0FDeEIsU0FBUyxFQUNULFFBQVEsUUFBUSxDQUFDLE1BQU0sS0FBSyxRQUFRLENBQUMsVUFBVSxFQUFFLEVBQ2pELFFBQVEsQ0FBQyxNQUFNLEVBQ2YsU0FBUyxFQUNULEVBQUUsVUFBVSxFQUFFLFFBQVEsQ0FBQyxVQUFVLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxFQUM1RCxTQUFTLEVBQ1QsUUFBUSxDQUFDLE1BQU0sSUFBSSxHQUFHLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHLENBQ2xELENBQUM7Z0JBQ0osQ0FBQztZQUNILENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLDBDQUEwQztnQkFDMUMsSUFBSSxLQUFLLFlBQVksbUNBQWdCLEVBQUUsQ0FBQztvQkFDdEMsU0FBUyxHQUFHLEtBQUssQ0FBQztnQkFDcEIsQ0FBQztxQkFBTSxDQUFDO29CQUNOLFNBQVMsR0FBRyxJQUFBLGlDQUFjLEVBQ3hCLEtBQUssRUFDTCx3QkFBd0IsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFDakQsU0FBUyxDQUNWLENBQUM7Z0JBQ0osQ0FBQztnQkFFRCw4REFBOEQ7Z0JBQzlELElBQ0UsU0FBUyxDQUFDLFNBQVMsS0FBSyx1Q0FBb0IsQ0FBQyxhQUFhO29CQUMxRCxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQ3BCLENBQUM7b0JBQ0QsTUFBTSxTQUFTLENBQUM7Z0JBQ2xCLENBQUM7Z0JBRUQsSUFBSSxPQUFPLEtBQUssSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO29CQUM3QixNQUFNO2dCQUNSLENBQUM7Z0JBRUQsMkNBQTJDO2dCQUMzQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQzlELE1BQU0sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDM0QsQ0FBQztRQUNILENBQUM7UUFFRCxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFeEIsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNkLDBDQUEwQztZQUMxQyxNQUFNLElBQUksbUNBQWdCLENBQ3hCLFNBQVMsQ0FBQyxTQUFTLEVBQ25CLGdCQUFnQixJQUFJLENBQUMsT0FBTyxjQUFjLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFDN0QsU0FBUyxDQUFDLElBQUksRUFDZCxTQUFTLENBQUMsS0FBSyxFQUNmO2dCQUNFLEdBQUcsU0FBUyxDQUFDLE9BQU87Z0JBQ3BCLFFBQVEsRUFBRSxJQUFJLENBQUMsT0FBTztnQkFDdEIsYUFBYSxFQUFFLFNBQVM7YUFDekIsRUFDRCxTQUFTLEVBQ1QsS0FBSyxDQUFDLDRCQUE0QjthQUNuQyxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLGlCQUFpQjtRQUN2QixPQUFPLE9BQU8sSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3RELENBQUM7SUFFRDs7T0FFRztJQUNLLEtBQUssQ0FBQyxPQUFPLENBQ25CLE1BQW9DLEVBQ3BDLE1BQWdCO1FBRWhCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRTNDLElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3pELE9BQU8sTUFBaUIsQ0FBQztRQUMzQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLDJGQUEyRjtZQUMzRixJQUFJLEtBQUssWUFBWSxtQ0FBZ0IsRUFBRSxDQUFDO2dCQUN0QyxNQUFNLEtBQUssQ0FBQztZQUNkLENBQUM7WUFFRCwrREFBK0Q7WUFDL0QsTUFBTSxlQUFlLEdBQUcsSUFBQSxpQ0FBYyxFQUNwQyxLQUFLLEVBQ0wsb0JBQW9CLE1BQU0sRUFBRSxFQUM1QixTQUFTLENBQ1YsQ0FBQztZQUVGLDBEQUEwRDtZQUMxRCxJQUNFLEtBQUs7Z0JBQ0wsT0FBTyxLQUFLLEtBQUssUUFBUTtnQkFDekIsTUFBTSxJQUFJLEtBQUs7Z0JBQ2YsU0FBUyxJQUFJLEtBQUssRUFDbEIsQ0FBQztnQkFDRCxNQUFNLFFBQVEsR0FBRyxLQUloQixDQUFDO2dCQUNGLE1BQU0sb0JBQW9CLEdBQUc7b0JBQzNCLE9BQU8sRUFBRSxLQUFjO29CQUN2QixLQUFLLEVBQUU7d0JBQ0wsSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJO3dCQUNuQixPQUFPLEVBQUUsUUFBUSxDQUFDLE9BQU87d0JBQ3pCLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSTtxQkFDcEI7b0JBQ0QsRUFBRSxFQUFFLElBQUk7aUJBQ1QsQ0FBQztnQkFFRixNQUFNLElBQUEsb0NBQWlCLEVBQUMsb0JBQW9CLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDM0QsQ0FBQztZQUVELE1BQU0sZUFBZSxDQUFDO1FBQ3hCLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsVUFBVSxDQUNkLFVBQWtCLEVBQ2xCLFFBQXlCO1FBRXpCLE1BQU0sTUFBTSxHQUFxQjtZQUMvQixXQUFXLEVBQUUsVUFBVTtZQUN2QixTQUFTLEVBQUUsUUFBUTtTQUNwQixDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFJLGFBQWEsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUNqQixVQUFrQixFQUNsQixVQUFvQyxFQUNwQyxPQUlDO1FBRUQsTUFBTSxNQUFNLEdBQXNCO1lBQ2hDLFdBQVcsRUFBRSxVQUFVO1lBQ3ZCLFVBQVU7WUFDVixHQUFHLE9BQU87U0FDWCxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFNLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQXVCO1FBQ3BDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBYSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUF3QjtRQUN2QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQWEsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxVQUFVLENBQ2QsTUFBdUIsRUFDdkIsT0FBa0M7UUFFbEMsTUFBTSxNQUFNLEdBQUc7WUFDYixHQUFHLEVBQUUsTUFBTTtZQUNYLEdBQUcsT0FBTztTQUNYLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxPQUFPLENBQWEsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxVQUFVLENBQUMsTUFBdUI7UUFDdEMsTUFBTSxNQUFNLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLENBQUM7UUFDL0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFVLGFBQWEsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUFDLE9BS2Q7UUFDQyxNQUFNLFVBQVUsR0FBNEIsRUFBRSxDQUFDO1FBRS9DLElBQUksT0FBTyxFQUFFLElBQUk7WUFBRSxVQUFVLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDbEQsSUFBSSxPQUFPLEVBQUUsTUFBTSxLQUFLLFNBQVM7WUFBRSxVQUFVLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFFdEUsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFhLE1BQU0sRUFBRSxVQUFVLEVBQUU7WUFDeEQsS0FBSyxFQUFFLE9BQU8sRUFBRSxLQUFLO1lBQ3JCLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTTtTQUN4QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsY0FBYztRQUNsQixJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNyQyxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFBQyxNQUFNLENBQUM7WUFDUCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUFDLE1BT3JCO1FBZ0JDLE1BQU0sYUFBYSxHQUFHO1lBQ3BCLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUTtZQUN6QixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssSUFBSSxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDO1lBQ3RELGNBQWMsRUFBRSxNQUFNLENBQUMsY0FBYztZQUNyQyxRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVE7WUFDekIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLElBQUksc0JBQXNCO1lBQzNDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFO1NBQzlDLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxPQUFPLENBZWhCLHdCQUF3QixFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVM7UUFDUCxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDNUIsQ0FBQztDQUNGO0FBNWFELG9DQTRhQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvd29ya3NwYWNlL3NyYy9zZXJ2aWNlcy9kcnVwYWwtY2xpZW50LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRHJ1cGFsIEpTT04tUlBDIGNsaWVudCBzZXJ2aWNlIHVzaW5nIGpzb24tcnBjLTIuMCBsaWJyYXJ5XG4gKi9cblxuaW1wb3J0IHsgSlNPTlJQQ0NsaWVudCB9IGZyb20gJ2pzb24tcnBjLTIuMCc7XG5pbXBvcnQge1xuICB0eXBlIERydXBhbENsaWVudENvbmZpZyxcbiAgdHlwZSBEcnVwYWxKc29uUnBjTWV0aG9kLFxuICB0eXBlIEVudGl0eUxvYWRQYXJhbXMsXG4gIHR5cGUgRW50aXR5UXVlcnlQYXJhbXMsXG4gIHR5cGUgTm9kZUNyZWF0ZVBhcmFtcyxcbiAgdHlwZSBEcnVwYWxOb2RlLFxuICB0eXBlIEpzb25ScGNSZXNwb25zZSxcbiAgaXNKc29uUnBjRXJyb3JSZXNwb25zZSxcbn0gZnJvbSAnQC90eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQge1xuICBJbnRlZ3JhdGlvbkVycm9yLFxuICBJbnRlZ3JhdGlvbkVycm9yVHlwZSxcbiAgbm9ybWFsaXplRXJyb3IsXG4gIHBhcnNlSnNvblJwY0Vycm9yLFxufSBmcm9tICdAL3V0aWxzL2Vycm9yLWhhbmRsZXIuanMnO1xuXG4vKipcbiAqIEN1c3RvbSBlcnJvciBmb3IgRHJ1cGFsIGNsaWVudCBvcGVyYXRpb25zXG4gKi9cbmV4cG9ydCBjbGFzcyBEcnVwYWxDbGllbnRFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IoXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICAgIHB1YmxpYyByZWFkb25seSBjb2RlPzogbnVtYmVyLFxuICAgIHB1YmxpYyByZWFkb25seSBvcmlnaW5hbEVycm9yPzogdW5rbm93blxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlKTtcbiAgICB0aGlzLm5hbWUgPSAnRHJ1cGFsQ2xpZW50RXJyb3InO1xuICB9XG59XG5cbi8qKlxuICogRHJ1cGFsIEpTT04tUlBDIGNsaWVudCBpbXBsZW1lbnRhdGlvblxuICovXG5leHBvcnQgY2xhc3MgRHJ1cGFsQ2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnQ6IEpTT05SUENDbGllbnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgYmFzZVVybDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHRpbWVvdXQ6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSByZXRyaWVzOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgcHJpdmF0ZSByZXF1ZXN0Q291bnRlciA9IDA7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjb25maWc6IERydXBhbENsaWVudENvbmZpZykge1xuICAgIHRoaXMuYmFzZVVybCA9IG5ldyBVUkwoY29uZmlnLmVuZHBvaW50LCBjb25maWcuYmFzZVVybCkudG9TdHJpbmcoKTtcbiAgICB0aGlzLnRpbWVvdXQgPSBjb25maWcudGltZW91dCA/PyAzMDAwMDsgLy8gMzAgc2Vjb25kIHRpbWVvdXQgZm9yIERydXBhbCByZXNwb25zZSB0aW1lc1xuICAgIHRoaXMucmV0cmllcyA9IGNvbmZpZy5yZXRyaWVzID8/IDM7XG4gICAgdGhpcy5oZWFkZXJzID0ge1xuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgLi4uY29uZmlnLmhlYWRlcnMsXG4gICAgfTtcblxuICAgIC8vIEluaXRpYWxpemUgSlNPTi1SUEMgY2xpZW50IHdpdGggSFRUUCB0cmFuc3BvcnRcbiAgICB0aGlzLmNsaWVudCA9IG5ldyBKU09OUlBDQ2xpZW50KGFzeW5jIGpzb25SUENSZXF1ZXN0ID0+IHtcbiAgICAgIHJldHVybiB0aGlzLm1ha2VIdHRwUmVxdWVzdChqc29uUlBDUmVxdWVzdCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGFjY2VzcyB0b2tlbiBmb3IgYXV0aGVudGljYXRlZCByZXF1ZXN0c1xuICAgKi9cbiAgc2V0QWNjZXNzVG9rZW4odG9rZW46IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYEJlYXJlciAke3Rva2VufWA7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWNjZXNzIHRva2VuXG4gICAqL1xuICBjbGVhckFjY2Vzc1Rva2VuKCk6IHZvaWQge1xuICAgIGRlbGV0ZSB0aGlzLmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYWtlIEhUVFAgcmVxdWVzdCB3aXRoIHJldHJ5IGxvZ2ljXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIG1ha2VIdHRwUmVxdWVzdChqc29uUlBDUmVxdWVzdDogdW5rbm93bik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRoaXMudGltZW91dCk7XG4gICAgY29uc3QgcmVxdWVzdElkID0gdGhpcy5nZW5lcmF0ZVJlcXVlc3RJZCgpO1xuXG4gICAgbGV0IGxhc3RFcnJvcjogSW50ZWdyYXRpb25FcnJvciB8IHVuZGVmaW5lZDtcblxuICAgIGZvciAobGV0IGF0dGVtcHQgPSAxOyBhdHRlbXB0IDw9IHRoaXMucmV0cmllczsgYXR0ZW1wdCsrKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHRoaXMuYmFzZVVybCwge1xuICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShqc29uUlBDUmVxdWVzdCksXG4gICAgICAgICAgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG5cbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgICAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyk7XG4gICAgICAgICAgaWYgKCFjb250ZW50VHlwZT8uaW5jbHVkZXMoJ2FwcGxpY2F0aW9uL2pzb24nKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludGVncmF0aW9uRXJyb3IoXG4gICAgICAgICAgICAgIEludGVncmF0aW9uRXJyb3JUeXBlLk1BTEZPUk1FRF9SRVNQT05TRSxcbiAgICAgICAgICAgICAgYEludmFsaWQgY29udGVudC10eXBlOiBleHBlY3RlZCBhcHBsaWNhdGlvbi9qc29uLCBnb3QgJHtjb250ZW50VHlwZX1gLFxuICAgICAgICAgICAgICByZXNwb25zZS5zdGF0dXMsXG4gICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgeyBleHBlY3RlZDogJ2FwcGxpY2F0aW9uL2pzb24nLCByZWNlaXZlZDogY29udGVudFR5cGUgfSxcbiAgICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICBmYWxzZVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsZXQganNvblJQQ1Jlc3BvbnNlOiB1bmtub3duO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBqc29uUlBDUmVzcG9uc2UgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgfSBjYXRjaCAocGFyc2VFcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludGVncmF0aW9uRXJyb3IoXG4gICAgICAgICAgICAgIEludGVncmF0aW9uRXJyb3JUeXBlLlBBUlNFX0VSUk9SLFxuICAgICAgICAgICAgICAnRmFpbGVkIHRvIHBhcnNlIEpTT04gcmVzcG9uc2UnLFxuICAgICAgICAgICAgICByZXNwb25zZS5zdGF0dXMsXG4gICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgeyBwYXJzZUVycm9yOiBTdHJpbmcocGFyc2VFcnJvcikgfSxcbiAgICAgICAgICAgICAgcGFyc2VFcnJvcixcbiAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gVmFsaWRhdGUgSlNPTi1SUEMgcmVzcG9uc2UgZm9ybWF0XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgIWpzb25SUENSZXNwb25zZSB8fFxuICAgICAgICAgICAgdHlwZW9mIGpzb25SUENSZXNwb25zZSAhPT0gJ29iamVjdCcgfHxcbiAgICAgICAgICAgICEoJ2pzb25ycGMnIGluIGpzb25SUENSZXNwb25zZSlcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnRlZ3JhdGlvbkVycm9yKFxuICAgICAgICAgICAgICBJbnRlZ3JhdGlvbkVycm9yVHlwZS5NQUxGT1JNRURfUkVTUE9OU0UsXG4gICAgICAgICAgICAgICdJbnZhbGlkIEpTT04tUlBDIHJlc3BvbnNlOiBtaXNzaW5nIGpzb25ycGMgZmllbGQnLFxuICAgICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgeyByZXNwb25zZToganNvblJQQ1Jlc3BvbnNlIH0sXG4gICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgcnBjUmVzcG9uc2UgPSBqc29uUlBDUmVzcG9uc2UgYXMgSnNvblJwY1Jlc3BvbnNlO1xuICAgICAgICAgIGlmIChycGNSZXNwb25zZS5qc29ucnBjICE9PSAnMi4wJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludGVncmF0aW9uRXJyb3IoXG4gICAgICAgICAgICAgIEludGVncmF0aW9uRXJyb3JUeXBlLk1BTEZPUk1FRF9SRVNQT05TRSxcbiAgICAgICAgICAgICAgYEludmFsaWQgSlNPTi1SUEMgdmVyc2lvbjogZXhwZWN0ZWQgXCIyLjBcIiwgZ290IFwiJHtycGNSZXNwb25zZS5qc29ucnBjfVwiYCxcbiAgICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICAgIHsgZXhwZWN0ZWQ6ICcyLjAnLCByZWNlaXZlZDogcnBjUmVzcG9uc2UuanNvbnJwYyB9LFxuICAgICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIENoZWNrIGZvciBKU09OLVJQQyBlcnJvcnMgaW4gdGhlIHJlc3BvbnNlXG4gICAgICAgICAgaWYgKGlzSnNvblJwY0Vycm9yUmVzcG9uc2UocnBjUmVzcG9uc2UpKSB7XG4gICAgICAgICAgICB0aHJvdyBwYXJzZUpzb25ScGNFcnJvcihycGNSZXNwb25zZSwgcmVxdWVzdElkKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLmNsaWVudC5yZWNlaXZlKHJwY1Jlc3BvbnNlIGFzIEpzb25ScGNSZXNwb25zZSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIEhhbmRsZSBIVFRQIGVycm9yIHJlc3BvbnNlc1xuICAgICAgICAgIGxldCBlcnJvclRleHQgPSAnJztcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXJyb3JUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgZXJyb3JUZXh0ID0gJ1VuYWJsZSB0byByZWFkIGVycm9yIHJlc3BvbnNlJztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBlcnJvclR5cGUgPVxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID49IDUwMFxuICAgICAgICAgICAgICA/IEludGVncmF0aW9uRXJyb3JUeXBlLlNFUlZFUl9VTkFWQUlMQUJMRVxuICAgICAgICAgICAgICA6IHJlc3BvbnNlLnN0YXR1cyA9PT0gNDI5XG4gICAgICAgICAgICAgICAgPyBJbnRlZ3JhdGlvbkVycm9yVHlwZS5SQVRFX0xJTUlUX0VSUk9SXG4gICAgICAgICAgICAgICAgOiByZXNwb25zZS5zdGF0dXMgPT09IDQwMSB8fCByZXNwb25zZS5zdGF0dXMgPT09IDQwM1xuICAgICAgICAgICAgICAgICAgPyBJbnRlZ3JhdGlvbkVycm9yVHlwZS5BVVRIRU5USUNBVElPTl9FUlJPUlxuICAgICAgICAgICAgICAgICAgOiBJbnRlZ3JhdGlvbkVycm9yVHlwZS5WQUxJREFUSU9OX0VSUk9SO1xuXG4gICAgICAgICAgdGhyb3cgbmV3IEludGVncmF0aW9uRXJyb3IoXG4gICAgICAgICAgICBlcnJvclR5cGUsXG4gICAgICAgICAgICBgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gLFxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgeyBzdGF0dXNUZXh0OiByZXNwb25zZS5zdGF0dXNUZXh0LCByZXNwb25zZUJvZHk6IGVycm9yVGV4dCB9LFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID49IDUwMCB8fCByZXNwb25zZS5zdGF0dXMgPT09IDQyOVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIE5vcm1hbGl6ZSB0aGUgZXJyb3IgdG8gSW50ZWdyYXRpb25FcnJvclxuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBJbnRlZ3JhdGlvbkVycm9yKSB7XG4gICAgICAgICAgbGFzdEVycm9yID0gZXJyb3I7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGFzdEVycm9yID0gbm9ybWFsaXplRXJyb3IoXG4gICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgIGBIVFRQIHJlcXVlc3QgYXR0ZW1wdCAke2F0dGVtcHR9LyR7dGhpcy5yZXRyaWVzfWAsXG4gICAgICAgICAgICByZXF1ZXN0SWRcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRG9uJ3QgcmV0cnkgb24gdGltZW91dC9hYm9ydCBlcnJvcnMgb3Igbm9uLXJldHJ5YWJsZSBlcnJvcnNcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGxhc3RFcnJvci5lcnJvclR5cGUgPT09IEludGVncmF0aW9uRXJyb3JUeXBlLlRJTUVPVVRfRVJST1IgfHxcbiAgICAgICAgICAhbGFzdEVycm9yLnJldHJ5YWJsZVxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBsYXN0RXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXR0ZW1wdCA9PT0gdGhpcy5yZXRyaWVzKSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBFeHBvbmVudGlhbCBiYWNrb2ZmIGZvciByZXRyeWFibGUgZXJyb3JzXG4gICAgICAgIGNvbnN0IGRlbGF5ID0gTWF0aC5taW4oMTAwMCAqIE1hdGgucG93KDIsIGF0dGVtcHQgLSAxKSwgNTAwMCk7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBkZWxheSkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuXG4gICAgaWYgKGxhc3RFcnJvcikge1xuICAgICAgLy8gV3JhcCB0aGUgZmluYWwgZXJyb3Igd2l0aCByZXRyeSBjb250ZXh0XG4gICAgICB0aHJvdyBuZXcgSW50ZWdyYXRpb25FcnJvcihcbiAgICAgICAgbGFzdEVycm9yLmVycm9yVHlwZSxcbiAgICAgICAgYEZhaWxlZCBhZnRlciAke3RoaXMucmV0cmllc30gYXR0ZW1wdHM6ICR7bGFzdEVycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgbGFzdEVycm9yLmNvZGUsXG4gICAgICAgIGxhc3RFcnJvci5maWVsZCxcbiAgICAgICAge1xuICAgICAgICAgIC4uLmxhc3RFcnJvci5kZXRhaWxzLFxuICAgICAgICAgIGF0dGVtcHRzOiB0aGlzLnJldHJpZXMsXG4gICAgICAgICAgb3JpZ2luYWxFcnJvcjogbGFzdEVycm9yLFxuICAgICAgICB9LFxuICAgICAgICBsYXN0RXJyb3IsXG4gICAgICAgIGZhbHNlIC8vIE5vIG1vcmUgcmV0cmllcyBhdmFpbGFibGVcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIHVuaXF1ZSByZXF1ZXN0IElEIGZvciB0cmFjaW5nXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlUmVxdWVzdElkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGByZXEtJHtEYXRlLm5vdygpfS0keysrdGhpcy5yZXF1ZXN0Q291bnRlcn1gO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ha2UgYSBKU09OLVJQQyByZXF1ZXN0IHdpdGggZXJyb3IgaGFuZGxpbmdcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcmVxdWVzdDxUUmVzdWx0ID0gdW5rbm93bj4oXG4gICAgbWV0aG9kOiBEcnVwYWxKc29uUnBjTWV0aG9kIHwgc3RyaW5nLFxuICAgIHBhcmFtcz86IHVua25vd25cbiAgKTogUHJvbWlzZTxUUmVzdWx0PiB7XG4gICAgY29uc3QgcmVxdWVzdElkID0gdGhpcy5nZW5lcmF0ZVJlcXVlc3RJZCgpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QobWV0aG9kLCBwYXJhbXMpO1xuICAgICAgcmV0dXJuIHJlc3VsdCBhcyBUUmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBUaGUgZXJyb3IgaGFzIGFscmVhZHkgYmVlbiBwcm9jZXNzZWQgYnkgbWFrZUh0dHBSZXF1ZXN0LCBzbyB3ZSBqdXN0IG5lZWQgdG8gbm9ybWFsaXplIGl0XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBJbnRlZ3JhdGlvbkVycm9yKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICAvLyBIYW5kbGUgYW55IHVuZXhwZWN0ZWQgZXJyb3JzIGZyb20gdGhlIEpTT04tUlBDIGNsaWVudCBpdHNlbGZcbiAgICAgIGNvbnN0IG5vcm1hbGl6ZWRFcnJvciA9IG5vcm1hbGl6ZUVycm9yKFxuICAgICAgICBlcnJvcixcbiAgICAgICAgYEpTT04tUlBDIG1ldGhvZDogJHttZXRob2R9YCxcbiAgICAgICAgcmVxdWVzdElkXG4gICAgICApO1xuXG4gICAgICAvLyBDaGVjayBpZiB0aGlzIGVycm9yIGNvbnRhaW5zIEpTT04tUlBDIGVycm9yIGluZm9ybWF0aW9uXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yICYmXG4gICAgICAgIHR5cGVvZiBlcnJvciA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgJ2NvZGUnIGluIGVycm9yICYmXG4gICAgICAgICdtZXNzYWdlJyBpbiBlcnJvclxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IHJwY0Vycm9yID0gZXJyb3IgYXMge1xuICAgICAgICAgIGNvZGU6IG51bWJlcjtcbiAgICAgICAgICBtZXNzYWdlOiBzdHJpbmc7XG4gICAgICAgICAgZGF0YT86IHVua25vd247XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGpzb25ScGNFcnJvclJlc3BvbnNlID0ge1xuICAgICAgICAgIGpzb25ycGM6ICcyLjAnIGFzIGNvbnN0LFxuICAgICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgICBjb2RlOiBycGNFcnJvci5jb2RlLFxuICAgICAgICAgICAgbWVzc2FnZTogcnBjRXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgIGRhdGE6IHJwY0Vycm9yLmRhdGEsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBpZDogbnVsbCxcbiAgICAgICAgfTtcblxuICAgICAgICB0aHJvdyBwYXJzZUpzb25ScGNFcnJvcihqc29uUnBjRXJyb3JSZXNwb25zZSwgcmVxdWVzdElkKTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbm9ybWFsaXplZEVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMb2FkIGFuIGVudGl0eSBieSB0eXBlIGFuZCBJRFxuICAgKi9cbiAgYXN5bmMgbG9hZEVudGl0eTxUID0gdW5rbm93bj4oXG4gICAgZW50aXR5VHlwZTogc3RyaW5nLFxuICAgIGVudGl0eUlkOiBzdHJpbmcgfCBudW1iZXJcbiAgKTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3QgcGFyYW1zOiBFbnRpdHlMb2FkUGFyYW1zID0ge1xuICAgICAgZW50aXR5X3R5cGU6IGVudGl0eVR5cGUsXG4gICAgICBlbnRpdHlfaWQ6IGVudGl0eUlkLFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0PFQ+KCdlbnRpdHkubG9hZCcsIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogUXVlcnkgZW50aXRpZXMgd2l0aCBjb25kaXRpb25zXG4gICAqL1xuICBhc3luYyBxdWVyeUVudGl0aWVzPFQgPSB1bmtub3duPihcbiAgICBlbnRpdHlUeXBlOiBzdHJpbmcsXG4gICAgY29uZGl0aW9ucz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgIG9wdGlvbnM/OiB7XG4gICAgICBsaW1pdD86IG51bWJlcjtcbiAgICAgIG9mZnNldD86IG51bWJlcjtcbiAgICAgIHNvcnQ/OiBSZWNvcmQ8c3RyaW5nLCAnQVNDJyB8ICdERVNDJz47XG4gICAgfVxuICApOiBQcm9taXNlPFRbXT4ge1xuICAgIGNvbnN0IHBhcmFtczogRW50aXR5UXVlcnlQYXJhbXMgPSB7XG4gICAgICBlbnRpdHlfdHlwZTogZW50aXR5VHlwZSxcbiAgICAgIGNvbmRpdGlvbnMsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0PFRbXT4oJ2VudGl0eS5xdWVyeScsIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBhIG5vZGUgYnkgSURcbiAgICovXG4gIGFzeW5jIGxvYWROb2RlKG5vZGVJZDogc3RyaW5nIHwgbnVtYmVyKTogUHJvbWlzZTxEcnVwYWxOb2RlPiB7XG4gICAgcmV0dXJuIHRoaXMubG9hZEVudGl0eTxEcnVwYWxOb2RlPignbm9kZScsIG5vZGVJZCk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IG5vZGVcbiAgICovXG4gIGFzeW5jIGNyZWF0ZU5vZGUocGFyYW1zOiBOb2RlQ3JlYXRlUGFyYW1zKTogUHJvbWlzZTxEcnVwYWxOb2RlPiB7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdDxEcnVwYWxOb2RlPignbm9kZS5jcmVhdGUnLCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBhbiBleGlzdGluZyBub2RlXG4gICAqL1xuICBhc3luYyB1cGRhdGVOb2RlKFxuICAgIG5vZGVJZDogc3RyaW5nIHwgbnVtYmVyLFxuICAgIHVwZGF0ZXM6IFBhcnRpYWw8Tm9kZUNyZWF0ZVBhcmFtcz5cbiAgKTogUHJvbWlzZTxEcnVwYWxOb2RlPiB7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgbmlkOiBub2RlSWQsXG4gICAgICAuLi51cGRhdGVzLFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0PERydXBhbE5vZGU+KCdub2RlLnVwZGF0ZScsIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIGEgbm9kZVxuICAgKi9cbiAgYXN5bmMgZGVsZXRlTm9kZShub2RlSWQ6IHN0cmluZyB8IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHBhcmFtcyA9IHsgbmlkOiBub2RlSWQgfTtcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0PGJvb2xlYW4+KCdub2RlLmRlbGV0ZScsIHBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IG5vZGVzIHdpdGggb3B0aW9uYWwgZmlsdGVyaW5nXG4gICAqL1xuICBhc3luYyBnZXROb2RlcyhvcHRpb25zPzoge1xuICAgIHR5cGU/OiBzdHJpbmc7XG4gICAgc3RhdHVzPzogYm9vbGVhbjtcbiAgICBsaW1pdD86IG51bWJlcjtcbiAgICBvZmZzZXQ/OiBudW1iZXI7XG4gIH0pOiBQcm9taXNlPERydXBhbE5vZGVbXT4ge1xuICAgIGNvbnN0IGNvbmRpdGlvbnM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0ge307XG5cbiAgICBpZiAob3B0aW9ucz8udHlwZSkgY29uZGl0aW9ucy50eXBlID0gb3B0aW9ucy50eXBlO1xuICAgIGlmIChvcHRpb25zPy5zdGF0dXMgIT09IHVuZGVmaW5lZCkgY29uZGl0aW9ucy5zdGF0dXMgPSBvcHRpb25zLnN0YXR1cztcblxuICAgIHJldHVybiB0aGlzLnF1ZXJ5RW50aXRpZXM8RHJ1cGFsTm9kZT4oJ25vZGUnLCBjb25kaXRpb25zLCB7XG4gICAgICBsaW1pdDogb3B0aW9ucz8ubGltaXQsXG4gICAgICBvZmZzZXQ6IG9wdGlvbnM/Lm9mZnNldCxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXN0IGNvbm5lY3Rpb24gdG8gRHJ1cGFsXG4gICAqL1xuICBhc3luYyB0ZXN0Q29ubmVjdGlvbigpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5yZXF1ZXN0KCdzeXN0ZW0uY29ubmVjdCcpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlYXJjaCB0dXRvcmlhbHMgdXNpbmcgSlNPTi1SUEMgZG1lX21jcC5zZWFyY2hfY29udGVudCBtZXRob2RcbiAgICovXG4gIGFzeW5jIHNlYXJjaFR1dG9yaWFscyhwYXJhbXM6IHtcbiAgICBrZXl3b3Jkczogc3RyaW5nO1xuICAgIHR5cGVzPzogc3RyaW5nW107XG4gICAgZHJ1cGFsX3ZlcnNpb24/OiBzdHJpbmdbXTtcbiAgICBjYXRlZ29yeT86IHN0cmluZ1tdO1xuICAgIHNvcnQ/OiBzdHJpbmc7XG4gICAgcGFnZT86IHsgbGltaXQ6IG51bWJlcjsgb2Zmc2V0OiBudW1iZXIgfTtcbiAgfSk6IFByb21pc2U8e1xuICAgIHJlc3VsdHM6IEFycmF5PHtcbiAgICAgIGlkOiBzdHJpbmc7XG4gICAgICB0aXRsZTogc3RyaW5nO1xuICAgICAgY29udGVudDogc3RyaW5nO1xuICAgICAgdGFnczogc3RyaW5nW107XG4gICAgICBkcnVwYWxfdmVyc2lvbjogc3RyaW5nW107XG4gICAgICB1cmw6IHN0cmluZztcbiAgICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgICAgZGlmZmljdWx0eT86IHN0cmluZztcbiAgICAgIGNyZWF0ZWQ6IHN0cmluZztcbiAgICAgIHVwZGF0ZWQ/OiBzdHJpbmc7XG4gICAgfT47XG4gICAgdG90YWw6IG51bWJlcjtcbiAgICBmYWNldHM/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgfT4ge1xuICAgIGNvbnN0IHJlcXVlc3RQYXJhbXMgPSB7XG4gICAgICBrZXl3b3JkczogcGFyYW1zLmtleXdvcmRzLFxuICAgICAgdHlwZXM6IHBhcmFtcy50eXBlcyB8fCBbJ3R1dG9yaWFsJywgJ3RvcGljJywgJ2NvdXJzZSddLFxuICAgICAgZHJ1cGFsX3ZlcnNpb246IHBhcmFtcy5kcnVwYWxfdmVyc2lvbixcbiAgICAgIGNhdGVnb3J5OiBwYXJhbXMuY2F0ZWdvcnksXG4gICAgICBzb3J0OiBwYXJhbXMuc29ydCB8fCAnc2VhcmNoX2FwaV9yZWxldmFuY2UnLFxuICAgICAgcGFnZTogcGFyYW1zLnBhZ2UgfHwgeyBsaW1pdDogMTAsIG9mZnNldDogMCB9LFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0PHtcbiAgICAgIHJlc3VsdHM6IEFycmF5PHtcbiAgICAgICAgaWQ6IHN0cmluZztcbiAgICAgICAgdGl0bGU6IHN0cmluZztcbiAgICAgICAgY29udGVudDogc3RyaW5nO1xuICAgICAgICB0YWdzOiBzdHJpbmdbXTtcbiAgICAgICAgZHJ1cGFsX3ZlcnNpb246IHN0cmluZ1tdO1xuICAgICAgICB1cmw6IHN0cmluZztcbiAgICAgICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgICAgIGRpZmZpY3VsdHk/OiBzdHJpbmc7XG4gICAgICAgIGNyZWF0ZWQ6IHN0cmluZztcbiAgICAgICAgdXBkYXRlZD86IHN0cmluZztcbiAgICAgIH0+O1xuICAgICAgdG90YWw6IG51bWJlcjtcbiAgICAgIGZhY2V0cz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgIH0+KCdkbWVfbWNwLnNlYXJjaF9jb250ZW50JywgcmVxdWVzdFBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHNlcnZlciBjb25maWd1cmF0aW9uXG4gICAqL1xuICBnZXRDb25maWcoKTogRHJ1cGFsQ2xpZW50Q29uZmlnIHtcbiAgICByZXR1cm4geyAuLi50aGlzLmNvbmZpZyB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=