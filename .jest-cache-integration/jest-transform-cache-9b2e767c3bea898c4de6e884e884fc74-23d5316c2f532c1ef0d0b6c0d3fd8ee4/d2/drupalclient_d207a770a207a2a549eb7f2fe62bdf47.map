{"file":"/workspace/src/services/drupal-client.ts","mappings":"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","names":[],"sources":["/workspace/src/services/drupal-client.ts"],"sourcesContent":["/**\n * Drupal JSON-RPC client service using json-rpc-2.0 library\n */\n\nimport { JSONRPCClient } from 'json-rpc-2.0';\nimport {\n  type DrupalClientConfig,\n  type DrupalJsonRpcMethod,\n  type EntityLoadParams,\n  type EntityQueryParams,\n  type NodeCreateParams,\n  type DrupalNode,\n  type JsonRpcResponse,\n  isJsonRpcErrorResponse,\n} from '@/types/index.js';\nimport {\n  IntegrationError,\n  IntegrationErrorType,\n  normalizeError,\n  parseJsonRpcError,\n} from '@/utils/error-handler.js';\n\n/**\n * Custom error for Drupal client operations\n */\nexport class DrupalClientError extends Error {\n  constructor(\n    message: string,\n    public readonly code?: number,\n    public readonly originalError?: unknown\n  ) {\n    super(message);\n    this.name = 'DrupalClientError';\n  }\n}\n\n/**\n * Drupal JSON-RPC client implementation\n */\nexport class DrupalClient {\n  private readonly client: JSONRPCClient;\n  private readonly baseUrl: string;\n  private readonly timeout: number;\n  private readonly retries: number;\n  private readonly headers: Record<string, string>;\n  private requestCounter = 0;\n\n  constructor(private readonly config: DrupalClientConfig) {\n    this.baseUrl = new URL(config.endpoint, config.baseUrl).toString();\n    this.timeout = config.timeout ?? 30000; // 30 second timeout for Drupal response times\n    this.retries = config.retries ?? 3;\n    this.headers = {\n      'Content-Type': 'application/json',\n      Accept: 'application/json',\n      ...config.headers,\n    };\n\n    // Initialize JSON-RPC client with HTTP transport\n    this.client = new JSONRPCClient(async jsonRPCRequest => {\n      return this.makeHttpRequest(jsonRPCRequest);\n    });\n  }\n\n  /**\n   * Set access token for authenticated requests\n   */\n  setAccessToken(token: string): void {\n    this.headers['Authorization'] = `Bearer ${token}`;\n  }\n\n  /**\n   * Clear access token\n   */\n  clearAccessToken(): void {\n    delete this.headers['Authorization'];\n  }\n\n  /**\n   * Make HTTP request with retry logic\n   */\n  private async makeHttpRequest(jsonRPCRequest: unknown): Promise<void> {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), this.timeout);\n    const requestId = this.generateRequestId();\n\n    let lastError: IntegrationError | undefined;\n\n    for (let attempt = 1; attempt <= this.retries; attempt++) {\n      try {\n        const response = await fetch(this.baseUrl, {\n          method: 'POST',\n          headers: this.headers,\n          body: JSON.stringify(jsonRPCRequest),\n          signal: controller.signal,\n        });\n\n        clearTimeout(timeoutId);\n\n        if (response.status === 200) {\n          const contentType = response.headers.get('content-type');\n          if (!contentType?.includes('application/json')) {\n            throw new IntegrationError(\n              IntegrationErrorType.MALFORMED_RESPONSE,\n              `Invalid content-type: expected application/json, got ${contentType}`,\n              response.status,\n              undefined,\n              { expected: 'application/json', received: contentType },\n              undefined,\n              false\n            );\n          }\n\n          let jsonRPCResponse: unknown;\n          try {\n            jsonRPCResponse = await response.json();\n          } catch (parseError) {\n            throw new IntegrationError(\n              IntegrationErrorType.PARSE_ERROR,\n              'Failed to parse JSON response',\n              response.status,\n              undefined,\n              { parseError: String(parseError) },\n              parseError,\n              false\n            );\n          }\n\n          // Validate JSON-RPC response format\n          if (\n            !jsonRPCResponse ||\n            typeof jsonRPCResponse !== 'object' ||\n            !('jsonrpc' in jsonRPCResponse)\n          ) {\n            throw new IntegrationError(\n              IntegrationErrorType.MALFORMED_RESPONSE,\n              'Invalid JSON-RPC response: missing jsonrpc field',\n              undefined,\n              undefined,\n              { response: jsonRPCResponse },\n              undefined,\n              false\n            );\n          }\n\n          const rpcResponse = jsonRPCResponse as JsonRpcResponse;\n          if (rpcResponse.jsonrpc !== '2.0') {\n            throw new IntegrationError(\n              IntegrationErrorType.MALFORMED_RESPONSE,\n              `Invalid JSON-RPC version: expected \"2.0\", got \"${rpcResponse.jsonrpc}\"`,\n              undefined,\n              undefined,\n              { expected: '2.0', received: rpcResponse.jsonrpc },\n              undefined,\n              false\n            );\n          }\n\n          // Check for JSON-RPC errors in the response\n          if (isJsonRpcErrorResponse(rpcResponse)) {\n            throw parseJsonRpcError(rpcResponse, requestId);\n          }\n\n          this.client.receive(rpcResponse as JsonRpcResponse);\n          return;\n        } else {\n          // Handle HTTP error responses\n          let errorText = '';\n          try {\n            errorText = await response.text();\n          } catch {\n            errorText = 'Unable to read error response';\n          }\n\n          const errorType =\n            response.status >= 500\n              ? IntegrationErrorType.SERVER_UNAVAILABLE\n              : response.status === 429\n                ? IntegrationErrorType.RATE_LIMIT_ERROR\n                : response.status === 401 || response.status === 403\n                  ? IntegrationErrorType.AUTHENTICATION_ERROR\n                  : IntegrationErrorType.VALIDATION_ERROR;\n\n          throw new IntegrationError(\n            errorType,\n            `HTTP ${response.status}: ${response.statusText}`,\n            response.status,\n            undefined,\n            { statusText: response.statusText, responseBody: errorText },\n            undefined,\n            response.status >= 500 || response.status === 429\n          );\n        }\n      } catch (error) {\n        // Normalize the error to IntegrationError\n        if (error instanceof IntegrationError) {\n          lastError = error;\n        } else {\n          lastError = normalizeError(\n            error,\n            `HTTP request attempt ${attempt}/${this.retries}`,\n            requestId\n          );\n        }\n\n        // Don't retry on timeout/abort errors or non-retryable errors\n        if (\n          lastError.errorType === IntegrationErrorType.TIMEOUT_ERROR ||\n          !lastError.retryable\n        ) {\n          throw lastError;\n        }\n\n        if (attempt === this.retries) {\n          break;\n        }\n\n        // Exponential backoff for retryable errors\n        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);\n        await new Promise(resolve => setTimeout(resolve, delay));\n      }\n    }\n\n    clearTimeout(timeoutId);\n\n    if (lastError) {\n      // Wrap the final error with retry context\n      throw new IntegrationError(\n        lastError.errorType,\n        `Failed after ${this.retries} attempts: ${lastError.message}`,\n        lastError.code,\n        lastError.field,\n        {\n          ...lastError.details,\n          attempts: this.retries,\n          originalError: lastError,\n        },\n        lastError,\n        false // No more retries available\n      );\n    }\n  }\n\n  /**\n   * Generate unique request ID for tracing\n   */\n  private generateRequestId(): string {\n    return `req-${Date.now()}-${++this.requestCounter}`;\n  }\n\n  /**\n   * Make a JSON-RPC request with error handling\n   */\n  private async request<TResult = unknown>(\n    method: DrupalJsonRpcMethod | string,\n    params?: unknown\n  ): Promise<TResult> {\n    const requestId = this.generateRequestId();\n\n    try {\n      const result = await this.client.request(method, params);\n      return result as TResult;\n    } catch (error) {\n      // The error has already been processed by makeHttpRequest, so we just need to normalize it\n      if (error instanceof IntegrationError) {\n        throw error;\n      }\n\n      // Handle any unexpected errors from the JSON-RPC client itself\n      const normalizedError = normalizeError(\n        error,\n        `JSON-RPC method: ${method}`,\n        requestId\n      );\n\n      // Check if this error contains JSON-RPC error information\n      if (\n        error &&\n        typeof error === 'object' &&\n        'code' in error &&\n        'message' in error\n      ) {\n        const rpcError = error as {\n          code: number;\n          message: string;\n          data?: unknown;\n        };\n        const jsonRpcErrorResponse = {\n          jsonrpc: '2.0' as const,\n          error: {\n            code: rpcError.code,\n            message: rpcError.message,\n            data: rpcError.data,\n          },\n          id: null,\n        };\n\n        throw parseJsonRpcError(jsonRpcErrorResponse, requestId);\n      }\n\n      throw normalizedError;\n    }\n  }\n\n  /**\n   * Load an entity by type and ID\n   */\n  async loadEntity<T = unknown>(\n    entityType: string,\n    entityId: string | number\n  ): Promise<T> {\n    const params: EntityLoadParams = {\n      entity_type: entityType,\n      entity_id: entityId,\n    };\n\n    return this.request<T>('entity.load', params);\n  }\n\n  /**\n   * Query entities with conditions\n   */\n  async queryEntities<T = unknown>(\n    entityType: string,\n    conditions?: Record<string, unknown>,\n    options?: {\n      limit?: number;\n      offset?: number;\n      sort?: Record<string, 'ASC' | 'DESC'>;\n    }\n  ): Promise<T[]> {\n    const params: EntityQueryParams = {\n      entity_type: entityType,\n      conditions,\n      ...options,\n    };\n\n    return this.request<T[]>('entity.query', params);\n  }\n\n  /**\n   * Load a node by ID\n   */\n  async loadNode(nodeId: string | number): Promise<DrupalNode> {\n    return this.loadEntity<DrupalNode>('node', nodeId);\n  }\n\n  /**\n   * Create a new node\n   */\n  async createNode(params: NodeCreateParams): Promise<DrupalNode> {\n    return this.request<DrupalNode>('node.create', params);\n  }\n\n  /**\n   * Update an existing node\n   */\n  async updateNode(\n    nodeId: string | number,\n    updates: Partial<NodeCreateParams>\n  ): Promise<DrupalNode> {\n    const params = {\n      nid: nodeId,\n      ...updates,\n    };\n\n    return this.request<DrupalNode>('node.update', params);\n  }\n\n  /**\n   * Delete a node\n   */\n  async deleteNode(nodeId: string | number): Promise<boolean> {\n    const params = { nid: nodeId };\n    return this.request<boolean>('node.delete', params);\n  }\n\n  /**\n   * Get nodes with optional filtering\n   */\n  async getNodes(options?: {\n    type?: string;\n    status?: boolean;\n    limit?: number;\n    offset?: number;\n  }): Promise<DrupalNode[]> {\n    const conditions: Record<string, unknown> = {};\n\n    if (options?.type) conditions.type = options.type;\n    if (options?.status !== undefined) conditions.status = options.status;\n\n    return this.queryEntities<DrupalNode>('node', conditions, {\n      limit: options?.limit,\n      offset: options?.offset,\n    });\n  }\n\n  /**\n   * Test connection to Drupal\n   */\n  async testConnection(): Promise<boolean> {\n    try {\n      await this.request('system.connect');\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Search tutorials using JSON-RPC dme_mcp.search_content method\n   */\n  async searchTutorials(params: {\n    keywords: string;\n    types?: string[];\n    drupal_version?: string[];\n    category?: string[];\n    sort?: string;\n    page?: { limit: number; offset: number };\n  }): Promise<{\n    results: Array<{\n      id: string;\n      title: string;\n      content: string;\n      tags: string[];\n      drupal_version: string[];\n      url: string;\n      description?: string;\n      difficulty?: string;\n      created: string;\n      updated?: string;\n    }>;\n    total: number;\n    facets?: Record<string, unknown>;\n  }> {\n    const requestParams = {\n      keywords: params.keywords,\n      types: params.types || ['tutorial', 'topic', 'course'],\n      drupal_version: params.drupal_version,\n      category: params.category,\n      sort: params.sort || 'search_api_relevance',\n      page: params.page || { limit: 10, offset: 0 },\n    };\n\n    return this.request<{\n      results: Array<{\n        id: string;\n        title: string;\n        content: string;\n        tags: string[];\n        drupal_version: string[];\n        url: string;\n        description?: string;\n        difficulty?: string;\n        created: string;\n        updated?: string;\n      }>;\n      total: number;\n      facets?: Record<string, unknown>;\n    }>('dme_mcp.search_content', requestParams);\n  }\n\n  /**\n   * Get server configuration\n   */\n  getConfig(): DrupalClientConfig {\n    return { ...this.config };\n  }\n}\n"],"version":3}