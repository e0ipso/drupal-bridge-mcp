{"file":"/workspace/src/auth/oauth-provider.ts","mappings":";AAAA;;;;GAIG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,sEAKkD;AAMlD,2BAAoC;AACpC,+BAA4B;AAC5B,2BAA6B;AAoB7B;;GAEG;AACH,MAAa,gBAAgB;IACV,MAAM,CAAiB;IACvB,SAAS,CAAS;IAC3B,aAAa,CAAe;IAC5B,iBAAiB,CAAU;IAEnC,YAAY,MAAsB,EAAE,MAAM,GAAG,SAAS;QACpD,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,MAAM,QAAQ,GAAG,IAAA,WAAI,EAAC,IAAA,YAAO,GAAE,EAAE,oBAAoB,CAAC,CAAC;QACvD,IAAI,CAAC,SAAS,GAAG,IAAA,WAAI,EAAC,QAAQ,EAAE,UAAU,MAAM,OAAO,CAAC,CAAC;IAC3D,CAAC;IAED,wCAAwC;IACxC,IAAI,WAAW;QACb,OAAO,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;IACjC,CAAC;IACD,IAAI,cAAc;QAChB,OAAO;YACL,aAAa,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;YACxC,WAAW,EAAE,CAAC,oBAAoB,EAAE,eAAe,CAAC;YACpD,cAAc,EAAE,CAAC,MAAM,CAAC;YACxB,0BAA0B,EAAE,MAAM;YAClC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC;SACpC,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,iBAAiB;QACrB,OAAO,EAAE,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC;IAC7C,CAAC;IAED,KAAK,CAAC,MAAM;QACV,IAAI,IAAI,CAAC,aAAa;YAAE,OAAO,IAAI,CAAC,aAAa,CAAC;QAClD,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,aAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC,CAAC;YACnE,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,MAAM,CAAC;YACjC,OAAO,IAAI,CAAC,MAAM,CAAC;QACrB,CAAC;QAAC,MAAM,CAAC;YACP,OAAO,SAAS,CAAC;QACnB,CAAC;IACH,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,MAAmB;QAClC,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC;QAC5B,MAAM,aAAE,CAAC,KAAK,CAAC,IAAA,WAAI,EAAC,IAAA,YAAO,GAAE,EAAE,oBAAoB,CAAC,EAAE;YACpD,SAAS,EAAE,IAAI;YACf,IAAI,EAAE,KAAK;SACZ,CAAC,CAAC;QACH,MAAM,aAAE,CAAC,SAAS,CAChB,IAAI,CAAC,SAAS,EACd,IAAI,CAAC,SAAS,CAAC;YACb,MAAM;YACN,MAAM,EAAE,SAAS;YACjB,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM;YAC1B,SAAS,EAAE,MAAM,CAAC,UAAU;gBAC1B,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,MAAM,CAAC,UAAU,GAAG,IAAI;gBACvC,CAAC,CAAC,SAAS;SACd,CAAC,EACF,EAAE,IAAI,EAAE,KAAK,EAAE,CAChB,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,uBAAuB,CAAC,GAAQ;QACpC,OAAO,CAAC,GAAG,CAAC,YAAY,GAAG,EAAE,CAAC,CAAC;QAC/B,IAAI,CAAC;YACH,CAAC,wDAAa,MAAM,GAAC,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;QACjD,CAAC;QAAC,MAAM,CAAC;YACP,0CAA0C;QAC5C,CAAC;IACH,CAAC;IAED,KAAK,CAAC,gBAAgB,CAAC,QAAgB;QACrC,IAAI,CAAC,iBAAiB,GAAG,QAAQ,CAAC;IACpC,CAAC;IACD,KAAK,CAAC,YAAY;QAChB,OAAO,IAAI,CAAC,iBAAkB,CAAC;IACjC,CAAC;IAED,kCAAkC;IAClC,KAAK,CAAC,SAAS;QACb,MAAM,MAAM,GAAG,MAAM,IAAA,cAAI,EAAC,IAAI,EAAE;YAC9B,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,SAAS;YAChC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC;SACpC,CAAC,CAAC;QACH,IAAI,MAAM,KAAK,UAAU;YAAE,MAAM,IAAI,KAAK,CAAC,+BAA+B,CAAC,CAAC;QAC5E,OAAO,CAAC,MAAM,IAAI,CAAC,MAAM,EAAE,CAAE,CAAC;IAChC,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,YAAoB;QACrC,MAAM,QAAQ,GAAG,MAAM,IAAA,6CAAmC,EACxD,IAAI,CAAC,MAAM,CAAC,qBAAqB,CAClC,CAAC;QACF,MAAM,MAAM,GAAG,MAAM,IAAA,8BAAoB,EACvC,IAAI,CAAC,MAAM,CAAC,qBAAqB,EACjC;YACE,QAAQ;YACR,iBAAiB,EAAE,MAAM,IAAI,CAAC,iBAAiB,EAAE;YACjD,YAAY;SACb,CACF,CAAC;QACF,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QAC9B,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,KAAK,CAAC,mBAAmB;QACvB,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,aAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC,CAAC;YACnE,IAAI,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,MAAM,EAAE,CAAC;gBAC5D,cAAc;gBACd,OAAO,IAAI,CAAC,MAAM,CAAC,aAAa;oBAC9B,CAAC,CAAC,CAAC,MAAM,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,YAAY;oBACnE,CAAC,CAAC,IAAI,CAAC;YACX,CAAC;YACD,OAAO,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC;QAClC,CAAC;QAAC,MAAM,CAAC;YACP,OAAO,IAAI,CAAC;QACd,CAAC;IACH,CAAC;IAED,KAAK,CAAC,aAAa;QACjB,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,aAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC,CAAC;YACnE,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACvB,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,SAAS,IAAI,GAAG,CAAC;YAC1D,OAAO;gBACL,OAAO,EAAE,CAAC,SAAS;gBACnB,SAAS,EAAE,CAAC,CAAC,SAAS;gBACtB,YAAY,EAAE,IAAI,CAAC,SAAS,IAAI,GAAG,GAAG,MAAM;aAC7C,CAAC;QACJ,CAAC;QAAC,MAAM,CAAC;YACP,OAAO,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,YAAY,EAAE,IAAI,EAAE,CAAC;QACjE,CAAC;IACH,CAAC;IAED,KAAK,CAAC,WAAW;QACf,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;QAC/B,IAAI,CAAC;YACH,MAAM,aAAE,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAClC,CAAC;QAAC,MAAM,CAAC;YACP,+BAA+B;QACjC,CAAC;IACH,CAAC;IAED,KAAK,CAAC,cAAc;QAClB,OAAO,CAAC,MAAM,IAAI,CAAC,mBAAmB,EAAE,CAAC,KAAK,IAAI,CAAC;IACrD,CAAC;IAED,4CAA4C;IAC5C,KAAK,CAAC,WAAW,CACf,MAAmB,EACnB,OAAe,EACf,OAAiB;QAEjB,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;IAChC,CAAC;IAED,KAAK,CAAC,SAAS;QACb,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,aAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC,CAAC;YACnE,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,MAAM,CAAC;YACP,OAAO,IAAI,CAAC;QACd,CAAC;IACH,CAAC;IAED,KAAK,CAAC,YAAY;QAChB,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,SAAS,EAAE,CAAC;QACpC,IAAI,CAAC,IAAI;YAAE,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;QACvC,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,aAAa,EAAE,CAAC;QAC9C,OAAO,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG,UAAU,EAAE,GAAG,IAAI,EAAE,CAAC;IACrD,CAAC;CACF;AA1KD,4CA0KC","names":[],"sources":["/workspace/src/auth/oauth-provider.ts"],"sourcesContent":["/**\n * OAuth 2.1 Provider using MCP SDK's built-in OAuth functionality\n * Replaces custom OAuthClient (335 lines) and TokenManager (320 lines) with SDK components\n * Reduces authentication code from 655 lines to ~150 lines with full OAuth 2.1 compliance\n */\n\nimport {\n  auth,\n  refreshAuthorization,\n  discoverAuthorizationServerMetadata,\n  type OAuthClientProvider,\n} from '@modelcontextprotocol/sdk/client/auth.js';\nimport {\n  type OAuthTokens,\n  type OAuthClientMetadata,\n  type OAuthClientInformation,\n} from '@modelcontextprotocol/sdk/shared/auth.js';\nimport { promises as fs } from 'fs';\nimport { join } from 'path';\nimport { homedir } from 'os';\n\nexport interface McpOAuthConfig {\n  clientId: string;\n  authorizationEndpoint: string;\n  redirectUri: string;\n  scopes: string[];\n  serverUrl: string;\n}\n\n// Re-export types for backward compatibility\nexport { type OAuthTokens } from '@modelcontextprotocol/sdk/shared/auth.js';\nexport interface TokenValidationResult {\n  isValid: boolean;\n  isExpired: boolean;\n  needsRefresh: boolean;\n  scopes?: string[];\n  userId?: string;\n}\n\n/**\n * Simplified OAuth 2.1 Provider using MCP SDK with automatic PKCE\n */\nexport class McpOAuthProvider implements OAuthClientProvider {\n  private readonly config: McpOAuthConfig;\n  private readonly tokenFile: string;\n  private currentTokens?: OAuthTokens;\n  private codeVerifierValue?: string;\n\n  constructor(config: McpOAuthConfig, userId = 'default') {\n    this.config = config;\n    const tokenDir = join(homedir(), '.drupal-bridge-mcp');\n    this.tokenFile = join(tokenDir, `tokens_${userId}.json`);\n  }\n\n  // MCP SDK OAuthClientProvider interface\n  get redirectUrl() {\n    return this.config.redirectUri;\n  }\n  get clientMetadata(): OAuthClientMetadata {\n    return {\n      redirect_uris: [this.config.redirectUri],\n      grant_types: ['authorization_code', 'refresh_token'],\n      response_types: ['code'],\n      token_endpoint_auth_method: 'none',\n      scope: this.config.scopes.join(' '),\n    };\n  }\n\n  async clientInformation(): Promise<OAuthClientInformation> {\n    return { client_id: this.config.clientId };\n  }\n\n  async tokens(): Promise<OAuthTokens | undefined> {\n    if (this.currentTokens) return this.currentTokens;\n    try {\n      const data = JSON.parse(await fs.readFile(this.tokenFile, 'utf8'));\n      this.currentTokens = data.tokens;\n      return data.tokens;\n    } catch {\n      return undefined;\n    }\n  }\n\n  async saveTokens(tokens: OAuthTokens): Promise<void> {\n    this.currentTokens = tokens;\n    await fs.mkdir(join(homedir(), '.drupal-bridge-mcp'), {\n      recursive: true,\n      mode: 0o700,\n    });\n    await fs.writeFile(\n      this.tokenFile,\n      JSON.stringify({\n        tokens,\n        userId: 'default',\n        scopes: this.config.scopes,\n        expiresAt: tokens.expires_in\n          ? Date.now() + tokens.expires_in * 1000\n          : undefined,\n      }),\n      { mode: 0o600 }\n    );\n  }\n\n  async redirectToAuthorization(url: URL): Promise<void> {\n    console.log(`Opening: ${url}`);\n    try {\n      (await import('open')).default(url.toString());\n    } catch {\n      // Ignore import errors - open is optional\n    }\n  }\n\n  async saveCodeVerifier(verifier: string): Promise<void> {\n    this.codeVerifierValue = verifier;\n  }\n  async codeVerifier(): Promise<string> {\n    return this.codeVerifierValue!;\n  }\n\n  // Backward compatible API methods\n  async authorize(): Promise<OAuthTokens> {\n    const result = await auth(this, {\n      serverUrl: this.config.serverUrl,\n      scope: this.config.scopes.join(' '),\n    });\n    if (result === 'REDIRECT') throw new Error('Manual authorization required');\n    return (await this.tokens())!;\n  }\n\n  async refreshToken(refreshToken: string): Promise<OAuthTokens> {\n    const metadata = await discoverAuthorizationServerMetadata(\n      this.config.authorizationEndpoint\n    );\n    const tokens = await refreshAuthorization(\n      this.config.authorizationEndpoint,\n      {\n        metadata,\n        clientInformation: await this.clientInformation(),\n        refreshToken,\n      }\n    );\n    await this.saveTokens(tokens);\n    return tokens;\n  }\n\n  async getValidAccessToken(): Promise<string | null> {\n    try {\n      const data = JSON.parse(await fs.readFile(this.tokenFile, 'utf8'));\n      if (data.expiresAt && data.expiresAt <= Date.now() + 300000) {\n        // 5min buffer\n        return data.tokens.refresh_token\n          ? (await this.refreshToken(data.tokens.refresh_token)).access_token\n          : null;\n      }\n      return data.tokens.access_token;\n    } catch {\n      return null;\n    }\n  }\n\n  async validateToken(): Promise<TokenValidationResult> {\n    try {\n      const data = JSON.parse(await fs.readFile(this.tokenFile, 'utf8'));\n      const now = Date.now();\n      const isExpired = data.expiresAt && data.expiresAt <= now;\n      return {\n        isValid: !isExpired,\n        isExpired: !!isExpired,\n        needsRefresh: data.expiresAt <= now + 300000,\n      };\n    } catch {\n      return { isValid: false, isExpired: true, needsRefresh: true };\n    }\n  }\n\n  async clearTokens(): Promise<void> {\n    this.currentTokens = undefined;\n    try {\n      await fs.unlink(this.tokenFile);\n    } catch {\n      // Ignore file not found errors\n    }\n  }\n\n  async hasValidTokens(): Promise<boolean> {\n    return (await this.getValidAccessToken()) !== null;\n  }\n\n  // Additional backward compatibility methods\n  async storeTokens(\n    tokens: OAuthTokens,\n    _userId: string,\n    _scopes: string[]\n  ): Promise<void> {\n    await this.saveTokens(tokens);\n  }\n\n  async getTokens(): Promise<unknown> {\n    try {\n      const data = JSON.parse(await fs.readFile(this.tokenFile, 'utf8'));\n      return data;\n    } catch {\n      return null;\n    }\n  }\n\n  async getTokenInfo(): Promise<unknown> {\n    const data = await this.getTokens();\n    if (!data) return { hasTokens: false };\n    const validation = await this.validateToken();\n    return { hasTokens: true, ...validation, ...data };\n  }\n}\n"],"version":3}