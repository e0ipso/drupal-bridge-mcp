1acb800b2fc2c21b0b3adc1aa2af319d
"use strict";
/**
 * OAuth 2.1 Provider using MCP SDK's built-in OAuth functionality
 * Replaces custom OAuthClient (335 lines) and TokenManager (320 lines) with SDK components
 * Reduces authentication code from 655 lines to ~150 lines with full OAuth 2.1 compliance
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.McpOAuthProvider = void 0;
const auth_js_1 = require("@modelcontextprotocol/sdk/client/auth.js");
const fs_1 = require("fs");
const path_1 = require("path");
const os_1 = require("os");
/**
 * Simplified OAuth 2.1 Provider using MCP SDK with automatic PKCE
 */
class McpOAuthProvider {
    config;
    tokenFile;
    currentTokens;
    codeVerifierValue;
    constructor(config, userId = 'default') {
        this.config = config;
        const tokenDir = (0, path_1.join)((0, os_1.homedir)(), '.drupal-bridge-mcp');
        this.tokenFile = (0, path_1.join)(tokenDir, `tokens_${userId}.json`);
    }
    // MCP SDK OAuthClientProvider interface
    get redirectUrl() {
        return this.config.redirectUri;
    }
    get clientMetadata() {
        return {
            redirect_uris: [this.config.redirectUri],
            grant_types: ['authorization_code', 'refresh_token'],
            response_types: ['code'],
            token_endpoint_auth_method: 'none',
            scope: this.config.scopes.join(' '),
        };
    }
    async clientInformation() {
        return { client_id: this.config.clientId };
    }
    async tokens() {
        if (this.currentTokens)
            return this.currentTokens;
        try {
            const data = JSON.parse(await fs_1.promises.readFile(this.tokenFile, 'utf8'));
            this.currentTokens = data.tokens;
            return data.tokens;
        }
        catch {
            return undefined;
        }
    }
    async saveTokens(tokens) {
        this.currentTokens = tokens;
        await fs_1.promises.mkdir((0, path_1.join)((0, os_1.homedir)(), '.drupal-bridge-mcp'), {
            recursive: true,
            mode: 0o700,
        });
        await fs_1.promises.writeFile(this.tokenFile, JSON.stringify({
            tokens,
            userId: 'default',
            scopes: this.config.scopes,
            expiresAt: tokens.expires_in
                ? Date.now() + tokens.expires_in * 1000
                : undefined,
        }), { mode: 0o600 });
    }
    async redirectToAuthorization(url) {
        console.log(`Opening: ${url}`);
        try {
            (await Promise.resolve().then(() => __importStar(require('open')))).default(url.toString());
        }
        catch {
            // Ignore import errors - open is optional
        }
    }
    async saveCodeVerifier(verifier) {
        this.codeVerifierValue = verifier;
    }
    async codeVerifier() {
        return this.codeVerifierValue;
    }
    // Backward compatible API methods
    async authorize() {
        const result = await (0, auth_js_1.auth)(this, {
            serverUrl: this.config.serverUrl,
            scope: this.config.scopes.join(' '),
        });
        if (result === 'REDIRECT')
            throw new Error('Manual authorization required');
        return (await this.tokens());
    }
    async refreshToken(refreshToken) {
        const metadata = await (0, auth_js_1.discoverAuthorizationServerMetadata)(this.config.authorizationEndpoint);
        const tokens = await (0, auth_js_1.refreshAuthorization)(this.config.authorizationEndpoint, {
            metadata,
            clientInformation: await this.clientInformation(),
            refreshToken,
        });
        await this.saveTokens(tokens);
        return tokens;
    }
    async getValidAccessToken() {
        try {
            const data = JSON.parse(await fs_1.promises.readFile(this.tokenFile, 'utf8'));
            if (data.expiresAt && data.expiresAt <= Date.now() + 300000) {
                // 5min buffer
                return data.tokens.refresh_token
                    ? (await this.refreshToken(data.tokens.refresh_token)).access_token
                    : null;
            }
            return data.tokens.access_token;
        }
        catch {
            return null;
        }
    }
    async validateToken() {
        try {
            const data = JSON.parse(await fs_1.promises.readFile(this.tokenFile, 'utf8'));
            const now = Date.now();
            const isExpired = data.expiresAt && data.expiresAt <= now;
            return {
                isValid: !isExpired,
                isExpired: !!isExpired,
                needsRefresh: data.expiresAt <= now + 300000,
            };
        }
        catch {
            return { isValid: false, isExpired: true, needsRefresh: true };
        }
    }
    async clearTokens() {
        this.currentTokens = undefined;
        try {
            await fs_1.promises.unlink(this.tokenFile);
        }
        catch {
            // Ignore file not found errors
        }
    }
    async hasValidTokens() {
        return (await this.getValidAccessToken()) !== null;
    }
    // Additional backward compatibility methods
    async storeTokens(tokens, _userId, _scopes) {
        await this.saveTokens(tokens);
    }
    async getTokens() {
        try {
            const data = JSON.parse(await fs_1.promises.readFile(this.tokenFile, 'utf8'));
            return data;
        }
        catch {
            return null;
        }
    }
    async getTokenInfo() {
        const data = await this.getTokens();
        if (!data)
            return { hasTokens: false };
        const validation = await this.validateToken();
        return { hasTokens: true, ...validation, ...data };
    }
}
exports.McpOAuthProvider = McpOAuthProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVk7UUFDaEIsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLElBQUk7WUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDO1FBQ3ZDLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQzlDLE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsVUFBVSxFQUFFLEdBQUcsSUFBSSxFQUFFLENBQUM7SUFDckQsQ0FBQztDQUNGO0FBMUtELDRDQTBLQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvd29ya3NwYWNlL3NyYy9hdXRoL29hdXRoLXByb3ZpZGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogT0F1dGggMi4xIFByb3ZpZGVyIHVzaW5nIE1DUCBTREsncyBidWlsdC1pbiBPQXV0aCBmdW5jdGlvbmFsaXR5XG4gKiBSZXBsYWNlcyBjdXN0b20gT0F1dGhDbGllbnQgKDMzNSBsaW5lcykgYW5kIFRva2VuTWFuYWdlciAoMzIwIGxpbmVzKSB3aXRoIFNESyBjb21wb25lbnRzXG4gKiBSZWR1Y2VzIGF1dGhlbnRpY2F0aW9uIGNvZGUgZnJvbSA2NTUgbGluZXMgdG8gfjE1MCBsaW5lcyB3aXRoIGZ1bGwgT0F1dGggMi4xIGNvbXBsaWFuY2VcbiAqL1xuXG5pbXBvcnQge1xuICBhdXRoLFxuICByZWZyZXNoQXV0aG9yaXphdGlvbixcbiAgZGlzY292ZXJBdXRob3JpemF0aW9uU2VydmVyTWV0YWRhdGEsXG4gIHR5cGUgT0F1dGhDbGllbnRQcm92aWRlcixcbn0gZnJvbSAnQG1vZGVsY29udGV4dHByb3RvY29sL3Nkay9jbGllbnQvYXV0aC5qcyc7XG5pbXBvcnQge1xuICB0eXBlIE9BdXRoVG9rZW5zLFxuICB0eXBlIE9BdXRoQ2xpZW50TWV0YWRhdGEsXG4gIHR5cGUgT0F1dGhDbGllbnRJbmZvcm1hdGlvbixcbn0gZnJvbSAnQG1vZGVsY29udGV4dHByb3RvY29sL3Nkay9zaGFyZWQvYXV0aC5qcyc7XG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGhvbWVkaXIgfSBmcm9tICdvcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWNwT0F1dGhDb25maWcge1xuICBjbGllbnRJZDogc3RyaW5nO1xuICBhdXRob3JpemF0aW9uRW5kcG9pbnQ6IHN0cmluZztcbiAgcmVkaXJlY3RVcmk6IHN0cmluZztcbiAgc2NvcGVzOiBzdHJpbmdbXTtcbiAgc2VydmVyVXJsOiBzdHJpbmc7XG59XG5cbi8vIFJlLWV4cG9ydCB0eXBlcyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuZXhwb3J0IHsgdHlwZSBPQXV0aFRva2VucyB9IGZyb20gJ0Btb2RlbGNvbnRleHRwcm90b2NvbC9zZGsvc2hhcmVkL2F1dGguanMnO1xuZXhwb3J0IGludGVyZmFjZSBUb2tlblZhbGlkYXRpb25SZXN1bHQge1xuICBpc1ZhbGlkOiBib29sZWFuO1xuICBpc0V4cGlyZWQ6IGJvb2xlYW47XG4gIG5lZWRzUmVmcmVzaDogYm9vbGVhbjtcbiAgc2NvcGVzPzogc3RyaW5nW107XG4gIHVzZXJJZD86IHN0cmluZztcbn1cblxuLyoqXG4gKiBTaW1wbGlmaWVkIE9BdXRoIDIuMSBQcm92aWRlciB1c2luZyBNQ1AgU0RLIHdpdGggYXV0b21hdGljIFBLQ0VcbiAqL1xuZXhwb3J0IGNsYXNzIE1jcE9BdXRoUHJvdmlkZXIgaW1wbGVtZW50cyBPQXV0aENsaWVudFByb3ZpZGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IE1jcE9BdXRoQ29uZmlnO1xuICBwcml2YXRlIHJlYWRvbmx5IHRva2VuRmlsZTogc3RyaW5nO1xuICBwcml2YXRlIGN1cnJlbnRUb2tlbnM/OiBPQXV0aFRva2VucztcbiAgcHJpdmF0ZSBjb2RlVmVyaWZpZXJWYWx1ZT86IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IE1jcE9BdXRoQ29uZmlnLCB1c2VySWQgPSAnZGVmYXVsdCcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICBjb25zdCB0b2tlbkRpciA9IGpvaW4oaG9tZWRpcigpLCAnLmRydXBhbC1icmlkZ2UtbWNwJyk7XG4gICAgdGhpcy50b2tlbkZpbGUgPSBqb2luKHRva2VuRGlyLCBgdG9rZW5zXyR7dXNlcklkfS5qc29uYCk7XG4gIH1cblxuICAvLyBNQ1AgU0RLIE9BdXRoQ2xpZW50UHJvdmlkZXIgaW50ZXJmYWNlXG4gIGdldCByZWRpcmVjdFVybCgpIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcucmVkaXJlY3RVcmk7XG4gIH1cbiAgZ2V0IGNsaWVudE1ldGFkYXRhKCk6IE9BdXRoQ2xpZW50TWV0YWRhdGEge1xuICAgIHJldHVybiB7XG4gICAgICByZWRpcmVjdF91cmlzOiBbdGhpcy5jb25maWcucmVkaXJlY3RVcmldLFxuICAgICAgZ3JhbnRfdHlwZXM6IFsnYXV0aG9yaXphdGlvbl9jb2RlJywgJ3JlZnJlc2hfdG9rZW4nXSxcbiAgICAgIHJlc3BvbnNlX3R5cGVzOiBbJ2NvZGUnXSxcbiAgICAgIHRva2VuX2VuZHBvaW50X2F1dGhfbWV0aG9kOiAnbm9uZScsXG4gICAgICBzY29wZTogdGhpcy5jb25maWcuc2NvcGVzLmpvaW4oJyAnKSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgY2xpZW50SW5mb3JtYXRpb24oKTogUHJvbWlzZTxPQXV0aENsaWVudEluZm9ybWF0aW9uPiB7XG4gICAgcmV0dXJuIHsgY2xpZW50X2lkOiB0aGlzLmNvbmZpZy5jbGllbnRJZCB9O1xuICB9XG5cbiAgYXN5bmMgdG9rZW5zKCk6IFByb21pc2U8T0F1dGhUb2tlbnMgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAodGhpcy5jdXJyZW50VG9rZW5zKSByZXR1cm4gdGhpcy5jdXJyZW50VG9rZW5zO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZSh0aGlzLnRva2VuRmlsZSwgJ3V0ZjgnKSk7XG4gICAgICB0aGlzLmN1cnJlbnRUb2tlbnMgPSBkYXRhLnRva2VucztcbiAgICAgIHJldHVybiBkYXRhLnRva2VucztcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZVRva2Vucyh0b2tlbnM6IE9BdXRoVG9rZW5zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5jdXJyZW50VG9rZW5zID0gdG9rZW5zO1xuICAgIGF3YWl0IGZzLm1rZGlyKGpvaW4oaG9tZWRpcigpLCAnLmRydXBhbC1icmlkZ2UtbWNwJyksIHtcbiAgICAgIHJlY3Vyc2l2ZTogdHJ1ZSxcbiAgICAgIG1vZGU6IDBvNzAwLFxuICAgIH0pO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShcbiAgICAgIHRoaXMudG9rZW5GaWxlLFxuICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICB0b2tlbnMsXG4gICAgICAgIHVzZXJJZDogJ2RlZmF1bHQnLFxuICAgICAgICBzY29wZXM6IHRoaXMuY29uZmlnLnNjb3BlcyxcbiAgICAgICAgZXhwaXJlc0F0OiB0b2tlbnMuZXhwaXJlc19pblxuICAgICAgICAgID8gRGF0ZS5ub3coKSArIHRva2Vucy5leHBpcmVzX2luICogMTAwMFxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgfSksXG4gICAgICB7IG1vZGU6IDBvNjAwIH1cbiAgICApO1xuICB9XG5cbiAgYXN5bmMgcmVkaXJlY3RUb0F1dGhvcml6YXRpb24odXJsOiBVUkwpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zb2xlLmxvZyhgT3BlbmluZzogJHt1cmx9YCk7XG4gICAgdHJ5IHtcbiAgICAgIChhd2FpdCBpbXBvcnQoJ29wZW4nKSkuZGVmYXVsdCh1cmwudG9TdHJpbmcoKSk7XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBJZ25vcmUgaW1wb3J0IGVycm9ycyAtIG9wZW4gaXMgb3B0aW9uYWxcbiAgICB9XG4gIH1cblxuICBhc3luYyBzYXZlQ29kZVZlcmlmaWVyKHZlcmlmaWVyOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmNvZGVWZXJpZmllclZhbHVlID0gdmVyaWZpZXI7XG4gIH1cbiAgYXN5bmMgY29kZVZlcmlmaWVyKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuY29kZVZlcmlmaWVyVmFsdWUhO1xuICB9XG5cbiAgLy8gQmFja3dhcmQgY29tcGF0aWJsZSBBUEkgbWV0aG9kc1xuICBhc3luYyBhdXRob3JpemUoKTogUHJvbWlzZTxPQXV0aFRva2Vucz4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGF1dGgodGhpcywge1xuICAgICAgc2VydmVyVXJsOiB0aGlzLmNvbmZpZy5zZXJ2ZXJVcmwsXG4gICAgICBzY29wZTogdGhpcy5jb25maWcuc2NvcGVzLmpvaW4oJyAnKSxcbiAgICB9KTtcbiAgICBpZiAocmVzdWx0ID09PSAnUkVESVJFQ1QnKSB0aHJvdyBuZXcgRXJyb3IoJ01hbnVhbCBhdXRob3JpemF0aW9uIHJlcXVpcmVkJyk7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLnRva2VucygpKSE7XG4gIH1cblxuICBhc3luYyByZWZyZXNoVG9rZW4ocmVmcmVzaFRva2VuOiBzdHJpbmcpOiBQcm9taXNlPE9BdXRoVG9rZW5zPiB7XG4gICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCBkaXNjb3ZlckF1dGhvcml6YXRpb25TZXJ2ZXJNZXRhZGF0YShcbiAgICAgIHRoaXMuY29uZmlnLmF1dGhvcml6YXRpb25FbmRwb2ludFxuICAgICk7XG4gICAgY29uc3QgdG9rZW5zID0gYXdhaXQgcmVmcmVzaEF1dGhvcml6YXRpb24oXG4gICAgICB0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uRW5kcG9pbnQsXG4gICAgICB7XG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICBjbGllbnRJbmZvcm1hdGlvbjogYXdhaXQgdGhpcy5jbGllbnRJbmZvcm1hdGlvbigpLFxuICAgICAgICByZWZyZXNoVG9rZW4sXG4gICAgICB9XG4gICAgKTtcbiAgICBhd2FpdCB0aGlzLnNhdmVUb2tlbnModG9rZW5zKTtcbiAgICByZXR1cm4gdG9rZW5zO1xuICB9XG5cbiAgYXN5bmMgZ2V0VmFsaWRBY2Nlc3NUb2tlbigpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoYXdhaXQgZnMucmVhZEZpbGUodGhpcy50b2tlbkZpbGUsICd1dGY4JykpO1xuICAgICAgaWYgKGRhdGEuZXhwaXJlc0F0ICYmIGRhdGEuZXhwaXJlc0F0IDw9IERhdGUubm93KCkgKyAzMDAwMDApIHtcbiAgICAgICAgLy8gNW1pbiBidWZmZXJcbiAgICAgICAgcmV0dXJuIGRhdGEudG9rZW5zLnJlZnJlc2hfdG9rZW5cbiAgICAgICAgICA/IChhd2FpdCB0aGlzLnJlZnJlc2hUb2tlbihkYXRhLnRva2Vucy5yZWZyZXNoX3Rva2VuKSkuYWNjZXNzX3Rva2VuXG4gICAgICAgICAgOiBudWxsO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRhdGEudG9rZW5zLmFjY2Vzc190b2tlbjtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlVG9rZW4oKTogUHJvbWlzZTxUb2tlblZhbGlkYXRpb25SZXN1bHQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoYXdhaXQgZnMucmVhZEZpbGUodGhpcy50b2tlbkZpbGUsICd1dGY4JykpO1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbnN0IGlzRXhwaXJlZCA9IGRhdGEuZXhwaXJlc0F0ICYmIGRhdGEuZXhwaXJlc0F0IDw9IG5vdztcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzVmFsaWQ6ICFpc0V4cGlyZWQsXG4gICAgICAgIGlzRXhwaXJlZDogISFpc0V4cGlyZWQsXG4gICAgICAgIG5lZWRzUmVmcmVzaDogZGF0YS5leHBpcmVzQXQgPD0gbm93ICsgMzAwMDAwLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiB7IGlzVmFsaWQ6IGZhbHNlLCBpc0V4cGlyZWQ6IHRydWUsIG5lZWRzUmVmcmVzaDogdHJ1ZSB9O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNsZWFyVG9rZW5zKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuY3VycmVudFRva2VucyA9IHVuZGVmaW5lZDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnMudW5saW5rKHRoaXMudG9rZW5GaWxlKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIC8vIElnbm9yZSBmaWxlIG5vdCBmb3VuZCBlcnJvcnNcbiAgICB9XG4gIH1cblxuICBhc3luYyBoYXNWYWxpZFRva2VucygpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0VmFsaWRBY2Nlc3NUb2tlbigpKSAhPT0gbnVsbDtcbiAgfVxuXG4gIC8vIEFkZGl0aW9uYWwgYmFja3dhcmQgY29tcGF0aWJpbGl0eSBtZXRob2RzXG4gIGFzeW5jIHN0b3JlVG9rZW5zKFxuICAgIHRva2VuczogT0F1dGhUb2tlbnMsXG4gICAgX3VzZXJJZDogc3RyaW5nLFxuICAgIF9zY29wZXM6IHN0cmluZ1tdXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuc2F2ZVRva2Vucyh0b2tlbnMpO1xuICB9XG5cbiAgYXN5bmMgZ2V0VG9rZW5zKCk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZSh0aGlzLnRva2VuRmlsZSwgJ3V0ZjgnKSk7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFRva2VuSW5mbygpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5nZXRUb2tlbnMoKTtcbiAgICBpZiAoIWRhdGEpIHJldHVybiB7IGhhc1Rva2VuczogZmFsc2UgfTtcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgdGhpcy52YWxpZGF0ZVRva2VuKCk7XG4gICAgcmV0dXJuIHsgaGFzVG9rZW5zOiB0cnVlLCAuLi52YWxpZGF0aW9uLCAuLi5kYXRhIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==