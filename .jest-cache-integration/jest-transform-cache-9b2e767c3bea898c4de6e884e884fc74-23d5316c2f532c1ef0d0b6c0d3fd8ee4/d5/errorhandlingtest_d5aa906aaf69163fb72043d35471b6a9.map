{"file":"/workspace/tests/integration/error-handling.test.ts","mappings":"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","names":[],"sources":["/workspace/tests/integration/error-handling.test.ts"],"sourcesContent":["/**\n * Integration tests for error handling across the JSON-RPC Drupal integration\n */\n\nimport {\n  describe,\n  test,\n  expect,\n  beforeEach,\n  afterEach,\n  jest,\n} from '@jest/globals';\nimport {\n  IntegrationError,\n  IntegrationErrorType,\n  parseJsonRpcError,\n  normalizeError,\n  formatMcpErrorResponse,\n} from '@/utils/error-handler.js';\nimport { DrupalClient } from '@/services/drupal-client.js';\nimport { DrupalMcpServer } from '@/mcp/server.js';\nimport { loadConfig } from '@/config/index.js';\nimport type { JsonRpcErrorResponse } from '@/types/index.js';\n\n// Mock fetch to simulate various error scenarios\nconst mockFetch = jest.fn();\nglobal.fetch = mockFetch as any;\n\ndescribe('Error Handling Integration', () => {\n  let config: any;\n  let drupalClient: DrupalClient;\n  let mcpServer: DrupalMcpServer;\n\n  beforeEach(async () => {\n    config = {\n      drupal: {\n        baseUrl: 'http://localhost/drupal',\n        endpoint: '/jsonrpc',\n        timeout: 10000,\n        retries: 3,\n        headers: {\n          'Content-Type': 'application/json',\n          Accept: 'application/json',\n        },\n      },\n      oauth: {\n        clientId: 'test-client-id',\n        authorizationEndpoint: 'http://localhost/drupal/oauth/authorize',\n        tokenEndpoint: 'http://localhost/drupal/oauth/token',\n        redirectUri: 'http://127.0.0.1:3000/callback',\n        scopes: ['tutorial:read', 'user:profile'],\n      },\n      auth: {\n        enabled: false, // Disable auth for error handling tests\n        requiredScopes: ['tutorial:read'],\n        skipAuth: true,\n      },\n      mcp: {\n        name: 'test-drupal-bridge-mcp',\n        version: '1.0.0-test',\n        protocolVersion: '2024-11-05',\n        capabilities: {\n          resources: { subscribe: true, listChanged: true },\n          tools: { listChanged: true },\n          prompts: { listChanged: true },\n        },\n      },\n      server: {\n        port: 3000,\n        host: '0.0.0.0',\n      },\n      logging: {\n        level: 'error' as const,\n      },\n      environment: 'test' as const,\n    };\n    drupalClient = new DrupalClient(config.drupal);\n    mcpServer = new DrupalMcpServer(config);\n\n    // Reset all mocks\n    jest.clearAllMocks();\n  });\n\n  afterEach(() => {\n    jest.restoreAllMocks();\n  });\n\n  describe('JSON-RPC Error Response Parsing', () => {\n    test('should parse standard JSON-RPC validation error', () => {\n      const errorResponse: JsonRpcErrorResponse = {\n        jsonrpc: '2.0',\n        error: {\n          code: -32602,\n          message: 'Invalid search parameters',\n          data: {\n            type: 'VALIDATION_ERROR',\n            details: 'Search keywords must be at least 2 characters',\n            field: 'keywords',\n          },\n        },\n        id: 'search-request-001',\n      };\n\n      const error = parseJsonRpcError(errorResponse, 'test-request-123');\n\n      expect(error).toBeInstanceOf(IntegrationError);\n      expect(error.errorType).toBe(IntegrationErrorType.VALIDATION_ERROR);\n      expect(error.message).toBe('Invalid search parameters');\n      expect(error.field).toBe('keywords');\n      expect(error.retryable).toBe(false);\n      expect(error.details?.jsonrpc_code).toBe(-32602);\n    });\n\n    test('should parse JSON-RPC server error as retryable', () => {\n      const errorResponse: JsonRpcErrorResponse = {\n        jsonrpc: '2.0',\n        error: {\n          code: -32603,\n          message: 'Internal server error',\n        },\n        id: 'search-request-002',\n      };\n\n      const error = parseJsonRpcError(errorResponse);\n\n      expect(error.errorType).toBe(IntegrationErrorType.SERVER_UNAVAILABLE);\n      expect(error.retryable).toBe(true);\n    });\n\n    test('should parse custom Drupal server errors', () => {\n      const errorResponse: JsonRpcErrorResponse = {\n        jsonrpc: '2.0',\n        error: {\n          code: -32050,\n          message: 'Database connection failed',\n          data: {\n            details: 'Connection timeout after 30 seconds',\n          },\n        },\n        id: 'search-request-003',\n      };\n\n      const error = parseJsonRpcError(errorResponse);\n\n      expect(error.errorType).toBe(IntegrationErrorType.DRUPAL_ERROR);\n      expect(error.retryable).toBe(true);\n      expect(error.details?.server_details).toBe(\n        'Connection timeout after 30 seconds'\n      );\n    });\n  });\n\n  describe('Network Error Handling', () => {\n    test('should handle network timeout errors', async () => {\n      // Mock a timeout error (AbortError)\n      const abortError = new Error('The user aborted a request');\n      abortError.name = 'AbortError';\n      mockFetch.mockRejectedValue(abortError);\n\n      try {\n        await drupalClient.searchTutorials({\n          keywords: 'test search',\n        });\n        // If we reach here, the test should fail\n        expect(true).toBe(false);\n      } catch (error) {\n        expect(error).toBeInstanceOf(IntegrationError);\n        if (error instanceof IntegrationError) {\n          // All errors through JSON-RPC client get normalized to JSONRPC_ERROR\n          expect(error.errorType).toBe(IntegrationErrorType.JSONRPC_ERROR);\n          expect(error.message).toBe('The user aborted a request');\n          expect(error.retryable).toBe(false);\n        }\n      }\n    });\n\n    test('should handle network connection errors', async () => {\n      // Mock a network connection error\n      mockFetch.mockRejectedValue(new TypeError('fetch failed'));\n\n      try {\n        // Use a different method that throws errors instead of testConnection which swallows them\n        await drupalClient.searchTutorials({ keywords: 'test' });\n        expect(true).toBe(false); // Should not reach here\n      } catch (error) {\n        expect(error).toBeInstanceOf(IntegrationError);\n        if (error instanceof IntegrationError) {\n          // Network errors get wrapped after retries\n          expect(error.errorType).toBe(IntegrationErrorType.JSONRPC_ERROR);\n          expect(error.message).toContain('Failed after 3 attempts');\n          expect(error.retryable).toBe(false); // Final wrapped error is not retryable\n        }\n      }\n    });\n\n    test('should handle malformed JSON responses', async () => {\n      // Mock a response with invalid JSON\n      mockFetch.mockResolvedValue({\n        status: 200,\n        headers: {\n          get: jest.fn((name: string) => {\n            if (name === 'content-type') return 'application/json';\n            return null;\n          }),\n        },\n        json: jest.fn().mockRejectedValue(new SyntaxError('Unexpected token')),\n      } as any);\n\n      try {\n        await drupalClient.loadNode(123);\n        expect(true).toBe(false); // Should not reach here\n      } catch (error) {\n        expect(error).toBeInstanceOf(IntegrationError);\n        if (error instanceof IntegrationError) {\n          // All errors through JSON-RPC client get normalized to JSONRPC_ERROR\n          expect(error.errorType).toBe(IntegrationErrorType.JSONRPC_ERROR);\n          expect(error.message).toBe('Failed to parse JSON response');\n          expect(error.retryable).toBe(false);\n        }\n      }\n    });\n  });\n\n  describe('HTTP Status Code Handling', () => {\n    test('should handle 401 authentication errors', async () => {\n      mockFetch.mockResolvedValue({\n        status: 401,\n        statusText: 'Unauthorized',\n        text: jest.fn().mockResolvedValue('Authentication required'),\n      } as any);\n\n      try {\n        await drupalClient.getNodes({ limit: 5 });\n        expect(true).toBe(false); // Should not reach here\n      } catch (error) {\n        expect(error).toBeInstanceOf(IntegrationError);\n        if (error instanceof IntegrationError) {\n          // All errors through JSON-RPC client get normalized to JSONRPC_ERROR\n          expect(error.errorType).toBe(IntegrationErrorType.JSONRPC_ERROR);\n          expect(error.message).toBe('HTTP 401: Unauthorized');\n          expect(error.retryable).toBe(false);\n          expect(error.getUserFriendlyMessage()).toContain('Server error');\n        }\n      }\n    });\n\n    test('should handle 429 rate limiting errors', async () => {\n      mockFetch.mockResolvedValue({\n        status: 429,\n        statusText: 'Too Many Requests',\n        text: jest.fn().mockResolvedValue('Rate limit exceeded'),\n      } as any);\n\n      try {\n        await drupalClient.searchTutorials({ keywords: 'test' });\n        expect(true).toBe(false); // Should not reach here\n      } catch (error) {\n        expect(error).toBeInstanceOf(IntegrationError);\n        if (error instanceof IntegrationError) {\n          // After retry logic, rate limit errors get wrapped as JSONRPC_ERROR\n          expect(error.errorType).toBe(IntegrationErrorType.JSONRPC_ERROR);\n          expect(error.message).toContain('Failed after 3 attempts');\n          expect(error.retryable).toBe(false); // Final wrapped error is not retryable\n          expect(error.getUserFriendlyMessage()).toContain('Server error');\n        }\n      }\n    });\n\n    test('should handle 500 server errors', async () => {\n      mockFetch.mockResolvedValue({\n        status: 500,\n        statusText: 'Internal Server Error',\n        text: jest.fn().mockResolvedValue('Database connection failed'),\n      } as any);\n\n      try {\n        await drupalClient.createNode({\n          type: 'article',\n          title: 'Test Article',\n        });\n        expect(true).toBe(false); // Should not reach here\n      } catch (error) {\n        expect(error).toBeInstanceOf(IntegrationError);\n        if (error instanceof IntegrationError) {\n          // After retry logic, server errors get wrapped as JSONRPC_ERROR\n          expect(error.errorType).toBe(IntegrationErrorType.JSONRPC_ERROR);\n          expect(error.message).toContain('Failed after 3 attempts');\n          expect(error.retryable).toBe(false); // Final wrapped error is not retryable\n        }\n      }\n    });\n  });\n\n  describe('MCP Tool Error Formatting', () => {\n    test('should format validation errors for MCP response', () => {\n      const validationError = new IntegrationError(\n        IntegrationErrorType.VALIDATION_ERROR,\n        'Search keywords must be at least 2 characters',\n        undefined,\n        'keywords',\n        { minLength: 2, provided: 'a' },\n        undefined,\n        false\n      );\n\n      const mcpResponse = formatMcpErrorResponse(\n        validationError,\n        'test-req-123'\n      );\n\n      expect(mcpResponse.content).toHaveLength(1);\n      expect(mcpResponse.content[0].type).toBe('text');\n\n      const errorData = JSON.parse(mcpResponse.content[0].text);\n      expect(errorData.error.type).toBe(IntegrationErrorType.VALIDATION_ERROR);\n      expect(errorData.error.message).toContain(\n        'Please check the keywords parameter'\n      );\n      expect(errorData.error.details.field).toBe('keywords');\n      expect(errorData.error.details.retryable).toBe(false);\n      expect(errorData.error.details.request_id).toBe('test-req-123');\n    });\n\n    test('should format network errors for MCP response', () => {\n      const networkError = new IntegrationError(\n        IntegrationErrorType.NETWORK_ERROR,\n        'Connection refused',\n        undefined,\n        undefined,\n        { context: 'Searching tutorials' },\n        new Error('ECONNREFUSED'),\n        true\n      );\n\n      const mcpResponse = formatMcpErrorResponse(networkError);\n\n      const errorData = JSON.parse(mcpResponse.content[0].text);\n      expect(errorData.error.type).toBe(IntegrationErrorType.NETWORK_ERROR);\n      expect(errorData.error.message).toContain('Unable to connect');\n      expect(errorData.error.details.retryable).toBe(true);\n    });\n  });\n\n  describe('Error Normalization', () => {\n    test('should normalize generic Error to IntegrationError', () => {\n      const genericError = new Error('Something went wrong');\n      const normalized = normalizeError(genericError, 'Test operation');\n\n      expect(normalized).toBeInstanceOf(IntegrationError);\n      expect(normalized.errorType).toBe(IntegrationErrorType.NETWORK_ERROR);\n      expect(normalized.message).toContain('Something went wrong');\n      expect(normalized.details?.context).toBe('Test operation');\n    });\n\n    test('should preserve IntegrationError when normalizing', () => {\n      const originalError = new IntegrationError(\n        IntegrationErrorType.VALIDATION_ERROR,\n        'Invalid parameter',\n        400,\n        'test_field'\n      );\n\n      const normalized = normalizeError(originalError, 'Test operation');\n\n      expect(normalized).toBe(originalError); // Should be the same instance\n    });\n\n    test('should handle unknown error types', () => {\n      const unknownError = { message: 'Unknown error', code: 'UNKNOWN' };\n      const normalized = normalizeError(unknownError, 'Test operation');\n\n      expect(normalized.errorType).toBe(IntegrationErrorType.NETWORK_ERROR);\n      expect(normalized.message).toContain('Test operation: [object Object]'); // Since we're passing an object, it gets stringified\n    });\n  });\n});\n"],"version":3}