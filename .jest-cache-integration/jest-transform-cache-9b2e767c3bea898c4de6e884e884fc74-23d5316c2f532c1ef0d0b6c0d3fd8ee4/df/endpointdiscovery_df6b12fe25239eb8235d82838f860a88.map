{"file":"/workspace/src/auth/endpoint-discovery.ts","mappings":"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","names":[],"sources":["/workspace/src/auth/endpoint-discovery.ts"],"sourcesContent":["/**\n * RFC8414-compliant OAuth 2.0 Authorization Server Metadata discovery\n *\n * This module implements the OAuth 2.0 Authorization Server Metadata specification\n * (RFC 8414) to dynamically discover OAuth endpoints from the .well-known metadata\n * endpoint, with graceful fallback to standard endpoints.\n */\n\nimport type {\n  OAuthServerMetadata,\n  OAuthEndpoints,\n  DiscoveryConfig,\n  CacheEntry,\n} from './types.js';\nimport { DiscoveryError, DiscoveryErrorType } from './types.js';\n\n/**\n * Default configuration values\n */\nconst DEFAULT_CONFIG: Required<Omit<DiscoveryConfig, 'baseUrl'>> = {\n  timeout: 5000,\n  retries: 2,\n  cacheTtl: 3600000, // 1 hour\n  validateHttps: true,\n  debug: false,\n};\n\n/**\n * In-memory cache for discovered metadata\n */\nclass MetadataCache {\n  private cache = new Map<string, CacheEntry>();\n\n  /**\n   * Get cached endpoints if valid\n   */\n  get(baseUrl: string): OAuthEndpoints | null {\n    const entry = this.cache.get(baseUrl);\n    if (!entry) {\n      return null;\n    }\n\n    if (Date.now() > entry.expiresAt) {\n      this.cache.delete(baseUrl);\n      return null;\n    }\n\n    return entry.endpoints;\n  }\n\n  /**\n   * Store endpoints in cache\n   */\n  set(baseUrl: string, endpoints: OAuthEndpoints, ttl: number): void {\n    this.cache.set(baseUrl, {\n      endpoints,\n      expiresAt: Date.now() + ttl,\n    });\n  }\n\n  /**\n   * Clear expired entries\n   */\n  cleanup(): void {\n    const now = Date.now();\n    for (const [key, entry] of this.cache) {\n      if (now > entry.expiresAt) {\n        this.cache.delete(key);\n      }\n    }\n  }\n\n  /**\n   * Clear all cache entries\n   */\n  clear(): void {\n    this.cache.clear();\n  }\n}\n\n/**\n * Global metadata cache instance\n */\nconst metadataCache = new MetadataCache();\n\n/**\n * Create a fetch function with timeout support\n */\nasync function fetchWithTimeout(\n  url: string,\n  timeout: number\n): Promise<Response> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n  try {\n    const fetch = globalThis.fetch || (await import('node-fetch')).default;\n    const response = await fetch(url, {\n      signal: controller.signal,\n      headers: {\n        Accept: 'application/json',\n        'User-Agent': 'Drupal-MCP-Bridge/1.0.0',\n      },\n    });\n    return response as Response;\n  } finally {\n    clearTimeout(timeoutId);\n  }\n}\n\n/**\n * Validate required fields in OAuth server metadata\n */\nfunction validateMetadata(metadata: unknown): OAuthServerMetadata {\n  if (!metadata || typeof metadata !== 'object') {\n    throw new DiscoveryError(\n      'Invalid metadata: response is not a JSON object',\n      DiscoveryErrorType.INVALID_JSON\n    );\n  }\n\n  const requiredFields = ['issuer', 'authorization_endpoint', 'token_endpoint'];\n  const missingFields = requiredFields.filter(\n    field => !(metadata as Record<string, unknown>)[field]\n  );\n\n  if (missingFields.length > 0) {\n    throw new DiscoveryError(\n      `Missing required metadata fields: ${missingFields.join(', ')}`,\n      DiscoveryErrorType.MISSING_REQUIRED_FIELDS\n    );\n  }\n\n  // Validate URL format for required endpoints\n  const metadataRecord = metadata as Record<string, unknown>;\n  try {\n    new URL(metadataRecord.authorization_endpoint as string);\n    new URL(metadataRecord.token_endpoint as string);\n  } catch (error) {\n    throw new DiscoveryError(\n      'Invalid endpoint URL format in metadata',\n      DiscoveryErrorType.INVALID_URL,\n      error as Error\n    );\n  }\n\n  return metadata as OAuthServerMetadata;\n}\n\n/**\n * Fetch and parse OAuth server metadata with retries\n */\nasync function fetchMetadata(\n  wellKnownUrl: string,\n  config: Required<DiscoveryConfig>\n): Promise<OAuthServerMetadata> {\n  let lastError: Error | null = null;\n  const maxAttempts = config.retries + 1;\n\n  for (let attempt = 1; attempt <= maxAttempts; attempt++) {\n    try {\n      if (config.debug) {\n        console.log(\n          `[Discovery] Attempt ${attempt}/${maxAttempts}: ${wellKnownUrl}`\n        );\n      }\n\n      const response = await fetchWithTimeout(wellKnownUrl, config.timeout);\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const contentType = response.headers.get('content-type');\n      if (!contentType?.includes('application/json')) {\n        throw new DiscoveryError(\n          `Invalid content type: ${contentType}. Expected application/json`,\n          DiscoveryErrorType.INVALID_JSON\n        );\n      }\n\n      const metadata = await response.json();\n      return validateMetadata(metadata);\n    } catch (error) {\n      lastError = error as Error;\n\n      if (error instanceof DiscoveryError) {\n        throw error; // Don't retry validation errors\n      }\n\n      if (attempt < maxAttempts) {\n        // Exponential backoff: 1s, 2s, 4s...\n        const delay = Math.pow(2, attempt - 1) * 1000;\n        if (config.debug) {\n          console.log(\n            `[Discovery] Retry ${attempt} after ${delay}ms due to:`,\n            error\n          );\n        }\n        await new Promise(resolve => setTimeout(resolve, delay));\n      }\n    }\n  }\n\n  // Determine error type for the final failure\n  const errorMessage = lastError?.message || 'Unknown error';\n  let errorType = DiscoveryErrorType.NETWORK_ERROR;\n\n  if (errorMessage.includes('timeout') || errorMessage.includes('aborted')) {\n    errorType = DiscoveryErrorType.TIMEOUT_ERROR;\n  } else if (errorMessage.includes('JSON') || errorMessage.includes('parse')) {\n    errorType = DiscoveryErrorType.INVALID_JSON;\n  }\n\n  throw new DiscoveryError(\n    `Failed to fetch metadata after ${maxAttempts} attempts: ${errorMessage}`,\n    errorType,\n    lastError || undefined\n  );\n}\n\n/**\n * Create fallback endpoints when discovery fails\n */\nfunction createFallbackEndpoints(baseUrl: string): OAuthEndpoints {\n  const normalizedBaseUrl = baseUrl.endsWith('/')\n    ? baseUrl.slice(0, -1)\n    : baseUrl;\n\n  return {\n    authorizationEndpoint: `${normalizedBaseUrl}/oauth/authorize`,\n    tokenEndpoint: `${normalizedBaseUrl}/oauth/token`,\n    issuer: normalizedBaseUrl,\n    discoveredAt: new Date(),\n    isFallback: true,\n  };\n}\n\n/**\n * Discover OAuth endpoints using RFC8414 metadata discovery\n *\n * @param config Discovery configuration\n * @returns Promise resolving to OAuth endpoints\n */\nexport async function discoverOAuthEndpoints(\n  config: DiscoveryConfig\n): Promise<OAuthEndpoints> {\n  // Merge with defaults\n  const fullConfig: Required<DiscoveryConfig> = {\n    ...DEFAULT_CONFIG,\n    ...config,\n  };\n\n  // Validate base URL\n  let baseUrl: URL;\n  try {\n    baseUrl = new URL(fullConfig.baseUrl);\n  } catch (error) {\n    throw new DiscoveryError(\n      `Invalid base URL: ${fullConfig.baseUrl}`,\n      DiscoveryErrorType.INVALID_URL,\n      error as Error\n    );\n  }\n\n  // Validate HTTPS in production\n  if (\n    fullConfig.validateHttps &&\n    process.env.NODE_ENV === 'production' &&\n    baseUrl.protocol !== 'https:'\n  ) {\n    throw new DiscoveryError(\n      'HTTPS is required in production environments',\n      DiscoveryErrorType.HTTPS_REQUIRED\n    );\n  }\n\n  // Check cache first\n  const cacheKey = fullConfig.baseUrl;\n  const cachedEndpoints = metadataCache.get(cacheKey);\n  if (cachedEndpoints) {\n    if (fullConfig.debug) {\n      console.log('[Discovery] Using cached endpoints');\n    }\n    return cachedEndpoints;\n  }\n\n  // Construct well-known metadata URL\n  const normalizedBaseUrl = baseUrl.toString().endsWith('/')\n    ? baseUrl.toString().slice(0, -1)\n    : baseUrl.toString();\n  const wellKnownUrl = `${normalizedBaseUrl}/.well-known/oauth-authorization-server`;\n\n  try {\n    if (fullConfig.debug) {\n      console.log(\n        `[Discovery] Discovering OAuth endpoints from: ${wellKnownUrl}`\n      );\n    }\n\n    // Fetch and validate metadata\n    const metadata = await fetchMetadata(wellKnownUrl, fullConfig);\n\n    // Create endpoints from metadata\n    const endpoints: OAuthEndpoints = {\n      authorizationEndpoint: metadata.authorization_endpoint,\n      tokenEndpoint: metadata.token_endpoint,\n      issuer: metadata.issuer,\n      discoveredAt: new Date(),\n      isFallback: false,\n      metadata,\n    };\n\n    // Cache the successful result\n    metadataCache.set(cacheKey, endpoints, fullConfig.cacheTtl);\n\n    if (fullConfig.debug) {\n      console.log('[Discovery] Successfully discovered OAuth endpoints');\n    }\n\n    return endpoints;\n  } catch (error) {\n    if (fullConfig.debug) {\n      console.warn(\n        '[Discovery] Failed to discover endpoints, using fallback:',\n        error\n      );\n    }\n\n    // Create fallback endpoints\n    const fallbackEndpoints = createFallbackEndpoints(normalizedBaseUrl);\n\n    // Cache fallback endpoints with shorter TTL\n    metadataCache.set(\n      cacheKey,\n      fallbackEndpoints,\n      Math.min(fullConfig.cacheTtl, 300000)\n    ); // 5 minutes max\n\n    return fallbackEndpoints;\n  }\n}\n\n/**\n * Clear the metadata cache\n */\nexport function clearDiscoveryCache(): void {\n  metadataCache.clear();\n}\n\n/**\n * Perform cache cleanup (remove expired entries)\n */\nexport function cleanupDiscoveryCache(): void {\n  metadataCache.cleanup();\n}\n\n/**\n * Get current cache statistics (for debugging)\n */\nexport function getDiscoveryCacheStats(): { size: number; entries: string[] } {\n  return {\n    size: metadataCache['cache'].size,\n    entries: Array.from(metadataCache['cache'].keys()),\n  };\n}\n"],"version":3}