1bcc80627b603bfeec88fa677b8f53cc
"use strict";
/**
 * OAuth Integration Tests
 *
 * Tests application-specific OAuth integration behavior
 */
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const oauth_client_js_1 = require("@/auth/oauth-client.js");
const endpoint_discovery_js_1 = require("@/auth/endpoint-discovery.js");
const http_1 = require("http");
(0, globals_1.describe)('OAuth Integration Tests', () => {
    let mockOAuthServer;
    let serverPort;
    let oauthClient;
    (0, globals_1.beforeAll)(async () => {
        mockOAuthServer = await createTestServer();
        const address = mockOAuthServer.address();
        serverPort = address.port;
        oauthClient = new oauth_client_js_1.OAuthClient({
            clientId: 'test-client-id',
            authorizationEndpoint: `http://localhost:${serverPort}/oauth/authorize`,
            tokenEndpoint: `http://localhost:${serverPort}/oauth/token`,
            redirectUri: 'http://127.0.0.1:3000/callback',
            scopes: ['tutorial:read', 'user:profile'],
        });
    });
    (0, globals_1.afterAll)(async () => {
        if (mockOAuthServer) {
            await new Promise(resolve => {
                mockOAuthServer.close(() => resolve());
            });
        }
    });
    (0, globals_1.describe)('Application OAuth Integration', () => {
        (0, globals_1.test)('should discover OAuth endpoints for application use', async () => {
            const endpoints = await (0, endpoint_discovery_js_1.discoverOAuthEndpoints)({
                baseUrl: `http://localhost:${serverPort}`,
                timeout: 5000,
                debug: false,
            });
            (0, globals_1.expect)(endpoints.isFallback).toBe(false);
            (0, globals_1.expect)(endpoints.authorizationEndpoint).toBeDefined();
            (0, globals_1.expect)(endpoints.tokenEndpoint).toBeDefined();
            (0, globals_1.expect)(endpoints.issuer).toBeDefined();
        });
        (0, globals_1.test)('should handle token exchange for application workflow', async () => {
            const mockTokens = {
                accessToken: 'access_token_12345',
                refreshToken: 'refresh_token_67890',
                tokenType: 'Bearer',
                expiresIn: 3600,
                scope: 'tutorial:read user:profile',
            };
            setMockTokenResponse(mockTokens);
            const challenge = oauthClient.generatePKCEChallenge();
            const exchangeMethod = oauthClient.exchangeCodeForTokens.bind(oauthClient);
            const tokens = await exchangeMethod('test_code_123', challenge.codeVerifier);
            (0, globals_1.expect)(tokens.accessToken).toBe(mockTokens.accessToken);
            (0, globals_1.expect)(tokens.tokenType).toBe('Bearer');
            (0, globals_1.expect)(tokens.expiresIn).toBe(3600);
        });
    });
});
// Minimal mock server for application testing
async function createTestServer() {
    return new Promise(resolve => {
        const server = (0, http_1.createServer)((req, res) => {
            const url = new URL(req.url || '', `http://localhost`);
            if (url.pathname === '/.well-known/oauth-authorization-server') {
                const address = req.socket.address();
                const baseUrl = `http://localhost:${address.port}`;
                const metadata = {
                    issuer: baseUrl,
                    authorization_endpoint: `${baseUrl}/oauth/authorize`,
                    token_endpoint: `${baseUrl}/oauth/token`,
                    response_types_supported: ['code'],
                    grant_types_supported: ['authorization_code', 'refresh_token'],
                    code_challenge_methods_supported: ['S256'],
                };
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify(metadata));
            }
            else if (url.pathname === '/oauth/token' && req.method === 'POST') {
                handleTokenRequest(req, res);
            }
            else {
                res.writeHead(404);
                res.end('Not found');
            }
        });
        server.listen(0, '127.0.0.1', () => {
            resolve(server);
        });
    });
}
let mockTokenResponse = null;
function setMockTokenResponse(tokens) {
    mockTokenResponse = tokens;
}
function handleTokenRequest(req, res) {
    if (mockTokenResponse) {
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({
            access_token: mockTokenResponse.accessToken,
            refresh_token: mockTokenResponse.refreshToken,
            token_type: mockTokenResponse.tokenType,
            expires_in: mockTokenResponse.expiresIn,
            scope: mockTokenResponse.scope,
        }));
        return;
    }
    res.writeHead(500, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ error: 'server_error' }));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL3dvcmtzcGFjZS90ZXN0cy9pbnRlZ3JhdGlvbi9vYXV0aDIxLXJmYy1jb21wbGlhbmNlLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7O0FBRUgsMkNBQTRFO0FBQzVFLDREQUFxRDtBQUNyRCx3RUFBc0U7QUFFdEUsK0JBQW9DO0FBSXBDLElBQUEsa0JBQVEsRUFBQyx5QkFBeUIsRUFBRSxHQUFHLEVBQUU7SUFDdkMsSUFBSSxlQUF1QixDQUFDO0lBQzVCLElBQUksVUFBa0IsQ0FBQztJQUN2QixJQUFJLFdBQXdCLENBQUM7SUFFN0IsSUFBQSxtQkFBUyxFQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLGVBQWUsR0FBRyxNQUFNLGdCQUFnQixFQUFFLENBQUM7UUFDM0MsTUFBTSxPQUFPLEdBQUcsZUFBZSxDQUFDLE9BQU8sRUFBaUIsQ0FBQztRQUN6RCxVQUFVLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQztRQUUxQixXQUFXLEdBQUcsSUFBSSw2QkFBVyxDQUFDO1lBQzVCLFFBQVEsRUFBRSxnQkFBZ0I7WUFDMUIscUJBQXFCLEVBQUUsb0JBQW9CLFVBQVUsa0JBQWtCO1lBQ3ZFLGFBQWEsRUFBRSxvQkFBb0IsVUFBVSxjQUFjO1lBQzNELFdBQVcsRUFBRSxnQ0FBZ0M7WUFDN0MsTUFBTSxFQUFFLENBQUMsZUFBZSxFQUFFLGNBQWMsQ0FBQztTQUMxQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsa0JBQVEsRUFBQyxLQUFLLElBQUksRUFBRTtRQUNsQixJQUFJLGVBQWUsRUFBRSxDQUFDO1lBQ3BCLE1BQU0sSUFBSSxPQUFPLENBQU8sT0FBTyxDQUFDLEVBQUU7Z0JBQ2hDLGVBQWUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUN6QyxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsa0JBQVEsRUFBQywrQkFBK0IsRUFBRSxHQUFHLEVBQUU7UUFDN0MsSUFBQSxjQUFJLEVBQUMscURBQXFELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDckUsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFBLDhDQUFzQixFQUFDO2dCQUM3QyxPQUFPLEVBQUUsb0JBQW9CLFVBQVUsRUFBRTtnQkFDekMsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsS0FBSyxFQUFFLEtBQUs7YUFDYixDQUFDLENBQUM7WUFFSCxJQUFBLGdCQUFNLEVBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN6QyxJQUFBLGdCQUFNLEVBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDdEQsSUFBQSxnQkFBTSxFQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM5QyxJQUFBLGdCQUFNLEVBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBQSxjQUFJLEVBQUMsdURBQXVELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDdkUsTUFBTSxVQUFVLEdBQWdCO2dCQUM5QixXQUFXLEVBQUUsb0JBQW9CO2dCQUNqQyxZQUFZLEVBQUUscUJBQXFCO2dCQUNuQyxTQUFTLEVBQUUsUUFBUTtnQkFDbkIsU0FBUyxFQUFFLElBQUk7Z0JBQ2YsS0FBSyxFQUFFLDRCQUE0QjthQUNwQyxDQUFDO1lBRUYsb0JBQW9CLENBQUMsVUFBVSxDQUFDLENBQUM7WUFFakMsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDdEQsTUFBTSxjQUFjLEdBQUksV0FBbUIsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQ3BFLFdBQVcsQ0FDWixDQUFDO1lBRUYsTUFBTSxNQUFNLEdBQUcsTUFBTSxjQUFjLENBQ2pDLGVBQWUsRUFDZixTQUFTLENBQUMsWUFBWSxDQUN2QixDQUFDO1lBRUYsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3hELElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3hDLElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILDhDQUE4QztBQUM5QyxLQUFLLFVBQVUsZ0JBQWdCO0lBQzdCLE9BQU8sSUFBSSxPQUFPLENBQVMsT0FBTyxDQUFDLEVBQUU7UUFDbkMsTUFBTSxNQUFNLEdBQUcsSUFBQSxtQkFBWSxFQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ3ZDLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLGtCQUFrQixDQUFDLENBQUM7WUFFdkQsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLHlDQUF5QyxFQUFFLENBQUM7Z0JBQy9ELE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ3JDLE1BQU0sT0FBTyxHQUFHLG9CQUFvQixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBRW5ELE1BQU0sUUFBUSxHQUFHO29CQUNmLE1BQU0sRUFBRSxPQUFPO29CQUNmLHNCQUFzQixFQUFFLEdBQUcsT0FBTyxrQkFBa0I7b0JBQ3BELGNBQWMsRUFBRSxHQUFHLE9BQU8sY0FBYztvQkFDeEMsd0JBQXdCLEVBQUUsQ0FBQyxNQUFNLENBQUM7b0JBQ2xDLHFCQUFxQixFQUFFLENBQUMsb0JBQW9CLEVBQUUsZUFBZSxDQUFDO29CQUM5RCxnQ0FBZ0MsRUFBRSxDQUFDLE1BQU0sQ0FBQztpQkFDM0MsQ0FBQztnQkFFRixHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDLENBQUM7Z0JBQzNELEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLENBQUM7aUJBQU0sSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLGNBQWMsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLE1BQU0sRUFBRSxDQUFDO2dCQUNwRSxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDL0IsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ25CLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDdkIsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRTtZQUNqQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxJQUFJLGlCQUFpQixHQUF1QixJQUFJLENBQUM7QUFFakQsU0FBUyxvQkFBb0IsQ0FBQyxNQUFtQjtJQUMvQyxpQkFBaUIsR0FBRyxNQUFNLENBQUM7QUFDN0IsQ0FBQztBQUVELFNBQVMsa0JBQWtCLENBQUMsR0FBUSxFQUFFLEdBQVE7SUFDNUMsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO1FBQ3RCLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUMzRCxHQUFHLENBQUMsR0FBRyxDQUNMLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDYixZQUFZLEVBQUUsaUJBQWlCLENBQUMsV0FBVztZQUMzQyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsWUFBWTtZQUM3QyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsU0FBUztZQUN2QyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsU0FBUztZQUN2QyxLQUFLLEVBQUUsaUJBQWlCLENBQUMsS0FBSztTQUMvQixDQUFDLENBQ0gsQ0FBQztRQUNGLE9BQU87SUFDVCxDQUFDO0lBRUQsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQzNELEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDckQsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvd29ya3NwYWNlL3Rlc3RzL2ludGVncmF0aW9uL29hdXRoMjEtcmZjLWNvbXBsaWFuY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE9BdXRoIEludGVncmF0aW9uIFRlc3RzXG4gKlxuICogVGVzdHMgYXBwbGljYXRpb24tc3BlY2lmaWMgT0F1dGggaW50ZWdyYXRpb24gYmVoYXZpb3JcbiAqL1xuXG5pbXBvcnQgeyBkZXNjcmliZSwgdGVzdCwgZXhwZWN0LCBiZWZvcmVBbGwsIGFmdGVyQWxsIH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5pbXBvcnQgeyBPQXV0aENsaWVudCB9IGZyb20gJ0AvYXV0aC9vYXV0aC1jbGllbnQuanMnO1xuaW1wb3J0IHsgZGlzY292ZXJPQXV0aEVuZHBvaW50cyB9IGZyb20gJ0AvYXV0aC9lbmRwb2ludC1kaXNjb3ZlcnkuanMnO1xuaW1wb3J0IHR5cGUgeyBPQXV0aFRva2VucyB9IGZyb20gJ0AvYXV0aC9vYXV0aC1jbGllbnQuanMnO1xuaW1wb3J0IHsgY3JlYXRlU2VydmVyIH0gZnJvbSAnaHR0cCc7XG5pbXBvcnQgdHlwZSB7IFNlcnZlciB9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IHR5cGUgeyBBZGRyZXNzSW5mbyB9IGZyb20gJ25ldCc7XG5cbmRlc2NyaWJlKCdPQXV0aCBJbnRlZ3JhdGlvbiBUZXN0cycsICgpID0+IHtcbiAgbGV0IG1vY2tPQXV0aFNlcnZlcjogU2VydmVyO1xuICBsZXQgc2VydmVyUG9ydDogbnVtYmVyO1xuICBsZXQgb2F1dGhDbGllbnQ6IE9BdXRoQ2xpZW50O1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgbW9ja09BdXRoU2VydmVyID0gYXdhaXQgY3JlYXRlVGVzdFNlcnZlcigpO1xuICAgIGNvbnN0IGFkZHJlc3MgPSBtb2NrT0F1dGhTZXJ2ZXIuYWRkcmVzcygpIGFzIEFkZHJlc3NJbmZvO1xuICAgIHNlcnZlclBvcnQgPSBhZGRyZXNzLnBvcnQ7XG5cbiAgICBvYXV0aENsaWVudCA9IG5ldyBPQXV0aENsaWVudCh7XG4gICAgICBjbGllbnRJZDogJ3Rlc3QtY2xpZW50LWlkJyxcbiAgICAgIGF1dGhvcml6YXRpb25FbmRwb2ludDogYGh0dHA6Ly9sb2NhbGhvc3Q6JHtzZXJ2ZXJQb3J0fS9vYXV0aC9hdXRob3JpemVgLFxuICAgICAgdG9rZW5FbmRwb2ludDogYGh0dHA6Ly9sb2NhbGhvc3Q6JHtzZXJ2ZXJQb3J0fS9vYXV0aC90b2tlbmAsXG4gICAgICByZWRpcmVjdFVyaTogJ2h0dHA6Ly8xMjcuMC4wLjE6MzAwMC9jYWxsYmFjaycsXG4gICAgICBzY29wZXM6IFsndHV0b3JpYWw6cmVhZCcsICd1c2VyOnByb2ZpbGUnXSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGlmIChtb2NrT0F1dGhTZXJ2ZXIpIHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4ge1xuICAgICAgICBtb2NrT0F1dGhTZXJ2ZXIuY2xvc2UoKCkgPT4gcmVzb2x2ZSgpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FwcGxpY2F0aW9uIE9BdXRoIEludGVncmF0aW9uJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Nob3VsZCBkaXNjb3ZlciBPQXV0aCBlbmRwb2ludHMgZm9yIGFwcGxpY2F0aW9uIHVzZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVuZHBvaW50cyA9IGF3YWl0IGRpc2NvdmVyT0F1dGhFbmRwb2ludHMoe1xuICAgICAgICBiYXNlVXJsOiBgaHR0cDovL2xvY2FsaG9zdDoke3NlcnZlclBvcnR9YCxcbiAgICAgICAgdGltZW91dDogNTAwMCxcbiAgICAgICAgZGVidWc6IGZhbHNlLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChlbmRwb2ludHMuaXNGYWxsYmFjaykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QoZW5kcG9pbnRzLmF1dGhvcml6YXRpb25FbmRwb2ludCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChlbmRwb2ludHMudG9rZW5FbmRwb2ludCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChlbmRwb2ludHMuaXNzdWVyKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIGhhbmRsZSB0b2tlbiBleGNoYW5nZSBmb3IgYXBwbGljYXRpb24gd29ya2Zsb3cnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrVG9rZW5zOiBPQXV0aFRva2VucyA9IHtcbiAgICAgICAgYWNjZXNzVG9rZW46ICdhY2Nlc3NfdG9rZW5fMTIzNDUnLFxuICAgICAgICByZWZyZXNoVG9rZW46ICdyZWZyZXNoX3Rva2VuXzY3ODkwJyxcbiAgICAgICAgdG9rZW5UeXBlOiAnQmVhcmVyJyxcbiAgICAgICAgZXhwaXJlc0luOiAzNjAwLFxuICAgICAgICBzY29wZTogJ3R1dG9yaWFsOnJlYWQgdXNlcjpwcm9maWxlJyxcbiAgICAgIH07XG5cbiAgICAgIHNldE1vY2tUb2tlblJlc3BvbnNlKG1vY2tUb2tlbnMpO1xuXG4gICAgICBjb25zdCBjaGFsbGVuZ2UgPSBvYXV0aENsaWVudC5nZW5lcmF0ZVBLQ0VDaGFsbGVuZ2UoKTtcbiAgICAgIGNvbnN0IGV4Y2hhbmdlTWV0aG9kID0gKG9hdXRoQ2xpZW50IGFzIGFueSkuZXhjaGFuZ2VDb2RlRm9yVG9rZW5zLmJpbmQoXG4gICAgICAgIG9hdXRoQ2xpZW50XG4gICAgICApO1xuXG4gICAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCBleGNoYW5nZU1ldGhvZChcbiAgICAgICAgJ3Rlc3RfY29kZV8xMjMnLFxuICAgICAgICBjaGFsbGVuZ2UuY29kZVZlcmlmaWVyXG4gICAgICApO1xuXG4gICAgICBleHBlY3QodG9rZW5zLmFjY2Vzc1Rva2VuKS50b0JlKG1vY2tUb2tlbnMuYWNjZXNzVG9rZW4pO1xuICAgICAgZXhwZWN0KHRva2Vucy50b2tlblR5cGUpLnRvQmUoJ0JlYXJlcicpO1xuICAgICAgZXhwZWN0KHRva2Vucy5leHBpcmVzSW4pLnRvQmUoMzYwMCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbi8vIE1pbmltYWwgbW9jayBzZXJ2ZXIgZm9yIGFwcGxpY2F0aW9uIHRlc3RpbmdcbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRlc3RTZXJ2ZXIoKTogUHJvbWlzZTxTZXJ2ZXI+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPFNlcnZlcj4ocmVzb2x2ZSA9PiB7XG4gICAgY29uc3Qgc2VydmVyID0gY3JlYXRlU2VydmVyKChyZXEsIHJlcykgPT4ge1xuICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChyZXEudXJsIHx8ICcnLCBgaHR0cDovL2xvY2FsaG9zdGApO1xuXG4gICAgICBpZiAodXJsLnBhdGhuYW1lID09PSAnLy53ZWxsLWtub3duL29hdXRoLWF1dGhvcml6YXRpb24tc2VydmVyJykge1xuICAgICAgICBjb25zdCBhZGRyZXNzID0gcmVxLnNvY2tldC5hZGRyZXNzKCk7XG4gICAgICAgIGNvbnN0IGJhc2VVcmwgPSBgaHR0cDovL2xvY2FsaG9zdDoke2FkZHJlc3MucG9ydH1gO1xuXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0ge1xuICAgICAgICAgIGlzc3VlcjogYmFzZVVybCxcbiAgICAgICAgICBhdXRob3JpemF0aW9uX2VuZHBvaW50OiBgJHtiYXNlVXJsfS9vYXV0aC9hdXRob3JpemVgLFxuICAgICAgICAgIHRva2VuX2VuZHBvaW50OiBgJHtiYXNlVXJsfS9vYXV0aC90b2tlbmAsXG4gICAgICAgICAgcmVzcG9uc2VfdHlwZXNfc3VwcG9ydGVkOiBbJ2NvZGUnXSxcbiAgICAgICAgICBncmFudF90eXBlc19zdXBwb3J0ZWQ6IFsnYXV0aG9yaXphdGlvbl9jb2RlJywgJ3JlZnJlc2hfdG9rZW4nXSxcbiAgICAgICAgICBjb2RlX2NoYWxsZW5nZV9tZXRob2RzX3N1cHBvcnRlZDogWydTMjU2J10sXG4gICAgICAgIH07XG5cbiAgICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KTtcbiAgICAgICAgcmVzLmVuZChKU09OLnN0cmluZ2lmeShtZXRhZGF0YSkpO1xuICAgICAgfSBlbHNlIGlmICh1cmwucGF0aG5hbWUgPT09ICcvb2F1dGgvdG9rZW4nICYmIHJlcS5tZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICBoYW5kbGVUb2tlblJlcXVlc3QocmVxLCByZXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLndyaXRlSGVhZCg0MDQpO1xuICAgICAgICByZXMuZW5kKCdOb3QgZm91bmQnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHNlcnZlci5saXN0ZW4oMCwgJzEyNy4wLjAuMScsICgpID0+IHtcbiAgICAgIHJlc29sdmUoc2VydmVyKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmxldCBtb2NrVG9rZW5SZXNwb25zZTogT0F1dGhUb2tlbnMgfCBudWxsID0gbnVsbDtcblxuZnVuY3Rpb24gc2V0TW9ja1Rva2VuUmVzcG9uc2UodG9rZW5zOiBPQXV0aFRva2Vucyk6IHZvaWQge1xuICBtb2NrVG9rZW5SZXNwb25zZSA9IHRva2Vucztcbn1cblxuZnVuY3Rpb24gaGFuZGxlVG9rZW5SZXF1ZXN0KHJlcTogYW55LCByZXM6IGFueSk6IHZvaWQge1xuICBpZiAobW9ja1Rva2VuUmVzcG9uc2UpIHtcbiAgICByZXMud3JpdGVIZWFkKDIwMCwgeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pO1xuICAgIHJlcy5lbmQoXG4gICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGFjY2Vzc190b2tlbjogbW9ja1Rva2VuUmVzcG9uc2UuYWNjZXNzVG9rZW4sXG4gICAgICAgIHJlZnJlc2hfdG9rZW46IG1vY2tUb2tlblJlc3BvbnNlLnJlZnJlc2hUb2tlbixcbiAgICAgICAgdG9rZW5fdHlwZTogbW9ja1Rva2VuUmVzcG9uc2UudG9rZW5UeXBlLFxuICAgICAgICBleHBpcmVzX2luOiBtb2NrVG9rZW5SZXNwb25zZS5leHBpcmVzSW4sXG4gICAgICAgIHNjb3BlOiBtb2NrVG9rZW5SZXNwb25zZS5zY29wZSxcbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm47XG4gIH1cblxuICByZXMud3JpdGVIZWFkKDUwMCwgeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pO1xuICByZXMuZW5kKEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdzZXJ2ZXJfZXJyb3InIH0pKTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==