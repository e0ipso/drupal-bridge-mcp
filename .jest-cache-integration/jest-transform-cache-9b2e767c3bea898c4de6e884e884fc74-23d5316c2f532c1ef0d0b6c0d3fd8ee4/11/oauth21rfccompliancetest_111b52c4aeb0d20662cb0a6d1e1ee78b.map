{"file":"/workspace/tests/integration/oauth21-rfc-compliance.test.ts","mappings":";AAAA;;;;GAIG;;AAEH,2CAA4E;AAC5E,4DAAqD;AACrD,wEAAsE;AAEtE,+BAAoC;AAIpC,IAAA,kBAAQ,EAAC,yBAAyB,EAAE,GAAG,EAAE;IACvC,IAAI,eAAuB,CAAC;IAC5B,IAAI,UAAkB,CAAC;IACvB,IAAI,WAAwB,CAAC;IAE7B,IAAA,mBAAS,EAAC,KAAK,IAAI,EAAE;QACnB,eAAe,GAAG,MAAM,gBAAgB,EAAE,CAAC;QAC3C,MAAM,OAAO,GAAG,eAAe,CAAC,OAAO,EAAiB,CAAC;QACzD,UAAU,GAAG,OAAO,CAAC,IAAI,CAAC;QAE1B,WAAW,GAAG,IAAI,6BAAW,CAAC;YAC5B,QAAQ,EAAE,gBAAgB;YAC1B,qBAAqB,EAAE,oBAAoB,UAAU,kBAAkB;YACvE,aAAa,EAAE,oBAAoB,UAAU,cAAc;YAC3D,WAAW,EAAE,gCAAgC;YAC7C,MAAM,EAAE,CAAC,eAAe,EAAE,cAAc,CAAC;SAC1C,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,IAAA,kBAAQ,EAAC,KAAK,IAAI,EAAE;QAClB,IAAI,eAAe,EAAE,CAAC;YACpB,MAAM,IAAI,OAAO,CAAO,OAAO,CAAC,EAAE;gBAChC,eAAe,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,OAAO,EAAE,CAAC,CAAC;YACzC,CAAC,CAAC,CAAC;QACL,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,IAAA,kBAAQ,EAAC,+BAA+B,EAAE,GAAG,EAAE;QAC7C,IAAA,cAAI,EAAC,qDAAqD,EAAE,KAAK,IAAI,EAAE;YACrE,MAAM,SAAS,GAAG,MAAM,IAAA,8CAAsB,EAAC;gBAC7C,OAAO,EAAE,oBAAoB,UAAU,EAAE;gBACzC,OAAO,EAAE,IAAI;gBACb,KAAK,EAAE,KAAK;aACb,CAAC,CAAC;YAEH,IAAA,gBAAM,EAAC,SAAS,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACzC,IAAA,gBAAM,EAAC,SAAS,CAAC,qBAAqB,CAAC,CAAC,WAAW,EAAE,CAAC;YACtD,IAAA,gBAAM,EAAC,SAAS,CAAC,aAAa,CAAC,CAAC,WAAW,EAAE,CAAC;YAC9C,IAAA,gBAAM,EAAC,SAAS,CAAC,MAAM,CAAC,CAAC,WAAW,EAAE,CAAC;QACzC,CAAC,CAAC,CAAC;QAEH,IAAA,cAAI,EAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;YACvE,MAAM,UAAU,GAAgB;gBAC9B,WAAW,EAAE,oBAAoB;gBACjC,YAAY,EAAE,qBAAqB;gBACnC,SAAS,EAAE,QAAQ;gBACnB,SAAS,EAAE,IAAI;gBACf,KAAK,EAAE,4BAA4B;aACpC,CAAC;YAEF,oBAAoB,CAAC,UAAU,CAAC,CAAC;YAEjC,MAAM,SAAS,GAAG,WAAW,CAAC,qBAAqB,EAAE,CAAC;YACtD,MAAM,cAAc,GAAI,WAAmB,CAAC,qBAAqB,CAAC,IAAI,CACpE,WAAW,CACZ,CAAC;YAEF,MAAM,MAAM,GAAG,MAAM,cAAc,CACjC,eAAe,EACf,SAAS,CAAC,YAAY,CACvB,CAAC;YAEF,IAAA,gBAAM,EAAC,MAAM,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;YACxD,IAAA,gBAAM,EAAC,MAAM,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACxC,IAAA,gBAAM,EAAC,MAAM,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACtC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC;AAEH,8CAA8C;AAC9C,KAAK,UAAU,gBAAgB;IAC7B,OAAO,IAAI,OAAO,CAAS,OAAO,CAAC,EAAE;QACnC,MAAM,MAAM,GAAG,IAAA,mBAAY,EAAC,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;YACvC,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,GAAG,CAAC,GAAG,IAAI,EAAE,EAAE,kBAAkB,CAAC,CAAC;YAEvD,IAAI,GAAG,CAAC,QAAQ,KAAK,yCAAyC,EAAE,CAAC;gBAC/D,MAAM,OAAO,GAAG,GAAG,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;gBACrC,MAAM,OAAO,GAAG,oBAAoB,OAAO,CAAC,IAAI,EAAE,CAAC;gBAEnD,MAAM,QAAQ,GAAG;oBACf,MAAM,EAAE,OAAO;oBACf,sBAAsB,EAAE,GAAG,OAAO,kBAAkB;oBACpD,cAAc,EAAE,GAAG,OAAO,cAAc;oBACxC,wBAAwB,EAAE,CAAC,MAAM,CAAC;oBAClC,qBAAqB,EAAE,CAAC,oBAAoB,EAAE,eAAe,CAAC;oBAC9D,gCAAgC,EAAE,CAAC,MAAM,CAAC;iBAC3C,CAAC;gBAEF,GAAG,CAAC,SAAS,CAAC,GAAG,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE,CAAC,CAAC;gBAC3D,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAC;YACpC,CAAC;iBAAM,IAAI,GAAG,CAAC,QAAQ,KAAK,cAAc,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,EAAE,CAAC;gBACpE,kBAAkB,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;YAC/B,CAAC;iBAAM,CAAC;gBACN,GAAG,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;gBACnB,GAAG,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;YACvB,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,WAAW,EAAE,GAAG,EAAE;YACjC,OAAO,CAAC,MAAM,CAAC,CAAC;QAClB,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC;AAED,IAAI,iBAAiB,GAAuB,IAAI,CAAC;AAEjD,SAAS,oBAAoB,CAAC,MAAmB;IAC/C,iBAAiB,GAAG,MAAM,CAAC;AAC7B,CAAC;AAED,SAAS,kBAAkB,CAAC,GAAQ,EAAE,GAAQ;IAC5C,IAAI,iBAAiB,EAAE,CAAC;QACtB,GAAG,CAAC,SAAS,CAAC,GAAG,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE,CAAC,CAAC;QAC3D,GAAG,CAAC,GAAG,CACL,IAAI,CAAC,SAAS,CAAC;YACb,YAAY,EAAE,iBAAiB,CAAC,WAAW;YAC3C,aAAa,EAAE,iBAAiB,CAAC,YAAY;YAC7C,UAAU,EAAE,iBAAiB,CAAC,SAAS;YACvC,UAAU,EAAE,iBAAiB,CAAC,SAAS;YACvC,KAAK,EAAE,iBAAiB,CAAC,KAAK;SAC/B,CAAC,CACH,CAAC;QACF,OAAO;IACT,CAAC;IAED,GAAG,CAAC,SAAS,CAAC,GAAG,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE,CAAC,CAAC;IAC3D,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,cAAc,EAAE,CAAC,CAAC,CAAC;AACrD,CAAC","names":[],"sources":["/workspace/tests/integration/oauth21-rfc-compliance.test.ts"],"sourcesContent":["/**\n * OAuth Integration Tests\n *\n * Tests application-specific OAuth integration behavior\n */\n\nimport { describe, test, expect, beforeAll, afterAll } from '@jest/globals';\nimport { OAuthClient } from '@/auth/oauth-client.js';\nimport { discoverOAuthEndpoints } from '@/auth/endpoint-discovery.js';\nimport type { OAuthTokens } from '@/auth/oauth-client.js';\nimport { createServer } from 'http';\nimport type { Server } from 'http';\nimport type { AddressInfo } from 'net';\n\ndescribe('OAuth Integration Tests', () => {\n  let mockOAuthServer: Server;\n  let serverPort: number;\n  let oauthClient: OAuthClient;\n\n  beforeAll(async () => {\n    mockOAuthServer = await createTestServer();\n    const address = mockOAuthServer.address() as AddressInfo;\n    serverPort = address.port;\n\n    oauthClient = new OAuthClient({\n      clientId: 'test-client-id',\n      authorizationEndpoint: `http://localhost:${serverPort}/oauth/authorize`,\n      tokenEndpoint: `http://localhost:${serverPort}/oauth/token`,\n      redirectUri: 'http://127.0.0.1:3000/callback',\n      scopes: ['tutorial:read', 'user:profile'],\n    });\n  });\n\n  afterAll(async () => {\n    if (mockOAuthServer) {\n      await new Promise<void>(resolve => {\n        mockOAuthServer.close(() => resolve());\n      });\n    }\n  });\n\n  describe('Application OAuth Integration', () => {\n    test('should discover OAuth endpoints for application use', async () => {\n      const endpoints = await discoverOAuthEndpoints({\n        baseUrl: `http://localhost:${serverPort}`,\n        timeout: 5000,\n        debug: false,\n      });\n\n      expect(endpoints.isFallback).toBe(false);\n      expect(endpoints.authorizationEndpoint).toBeDefined();\n      expect(endpoints.tokenEndpoint).toBeDefined();\n      expect(endpoints.issuer).toBeDefined();\n    });\n\n    test('should handle token exchange for application workflow', async () => {\n      const mockTokens: OAuthTokens = {\n        accessToken: 'access_token_12345',\n        refreshToken: 'refresh_token_67890',\n        tokenType: 'Bearer',\n        expiresIn: 3600,\n        scope: 'tutorial:read user:profile',\n      };\n\n      setMockTokenResponse(mockTokens);\n\n      const challenge = oauthClient.generatePKCEChallenge();\n      const exchangeMethod = (oauthClient as any).exchangeCodeForTokens.bind(\n        oauthClient\n      );\n\n      const tokens = await exchangeMethod(\n        'test_code_123',\n        challenge.codeVerifier\n      );\n\n      expect(tokens.accessToken).toBe(mockTokens.accessToken);\n      expect(tokens.tokenType).toBe('Bearer');\n      expect(tokens.expiresIn).toBe(3600);\n    });\n  });\n});\n\n// Minimal mock server for application testing\nasync function createTestServer(): Promise<Server> {\n  return new Promise<Server>(resolve => {\n    const server = createServer((req, res) => {\n      const url = new URL(req.url || '', `http://localhost`);\n\n      if (url.pathname === '/.well-known/oauth-authorization-server') {\n        const address = req.socket.address();\n        const baseUrl = `http://localhost:${address.port}`;\n\n        const metadata = {\n          issuer: baseUrl,\n          authorization_endpoint: `${baseUrl}/oauth/authorize`,\n          token_endpoint: `${baseUrl}/oauth/token`,\n          response_types_supported: ['code'],\n          grant_types_supported: ['authorization_code', 'refresh_token'],\n          code_challenge_methods_supported: ['S256'],\n        };\n\n        res.writeHead(200, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify(metadata));\n      } else if (url.pathname === '/oauth/token' && req.method === 'POST') {\n        handleTokenRequest(req, res);\n      } else {\n        res.writeHead(404);\n        res.end('Not found');\n      }\n    });\n\n    server.listen(0, '127.0.0.1', () => {\n      resolve(server);\n    });\n  });\n}\n\nlet mockTokenResponse: OAuthTokens | null = null;\n\nfunction setMockTokenResponse(tokens: OAuthTokens): void {\n  mockTokenResponse = tokens;\n}\n\nfunction handleTokenRequest(req: any, res: any): void {\n  if (mockTokenResponse) {\n    res.writeHead(200, { 'Content-Type': 'application/json' });\n    res.end(\n      JSON.stringify({\n        access_token: mockTokenResponse.accessToken,\n        refresh_token: mockTokenResponse.refreshToken,\n        token_type: mockTokenResponse.tokenType,\n        expires_in: mockTokenResponse.expiresIn,\n        scope: mockTokenResponse.scope,\n      })\n    );\n    return;\n  }\n\n  res.writeHead(500, { 'Content-Type': 'application/json' });\n  res.end(JSON.stringify({ error: 'server_error' }));\n}\n"],"version":3}