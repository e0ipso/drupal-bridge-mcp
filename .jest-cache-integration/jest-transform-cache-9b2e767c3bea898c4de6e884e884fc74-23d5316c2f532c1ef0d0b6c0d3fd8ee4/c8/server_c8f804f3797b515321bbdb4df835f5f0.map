{"file":"/workspace/src/mcp/server.ts","mappings":"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","names":[],"sources":["/workspace/src/mcp/server.ts"],"sourcesContent":["/**\n * MCP server implementation for Drupal integration\n */\n\nimport { Server } from '@modelcontextprotocol/sdk/server/index.js';\nimport type { Transport } from '@modelcontextprotocol/sdk/shared/transport.js';\nimport {\n  CallToolRequestSchema,\n  GetPromptRequestSchema,\n  ListPromptsRequestSchema,\n  ListResourcesRequestSchema,\n  ListToolsRequestSchema,\n  ReadResourceRequestSchema,\n} from '@modelcontextprotocol/sdk/types.js';\n\nimport type { AppConfig } from '@/config/index.js';\nimport { createOAuthProvider } from '@/config/index.js';\nimport type {\n  McpResource,\n  McpTool,\n  McpPrompt,\n  ProcessedSearchContentParams,\n  SearchContentResponse,\n  TutorialSearchResult,\n} from '@/types/index.js';\nimport { DrupalClient, DrupalClientError } from '@/services/drupal-client.js';\nimport { validateSearchContentParams, ValidationError } from '@/utils/index.js';\nimport {\n  IntegrationError,\n  IntegrationErrorType,\n  normalizeError,\n  formatMcpErrorResponse,\n  formatErrorForLogging,\n} from '@/utils/error-handler.js';\nimport {\n  OAuthClient,\n  TokenManager,\n  AuthenticationRequiredError,\n  createMcpErrorResponse,\n  McpOAuthProvider,\n  type AuthContext,\n} from '@/auth/index.js';\n\n/**\n * MCP server for Drupal integration\n */\nexport class DrupalMcpServer {\n  private readonly server: Server;\n  private readonly drupalClient: DrupalClient;\n  private readonly oauthClient: OAuthClient;\n  private readonly mcpOAuthProvider: McpOAuthProvider;\n  private readonly tokenManager: TokenManager;\n  private requestCounter = 0;\n\n  constructor(private readonly config: AppConfig) {\n    this.server = new Server(\n      {\n        name: config.mcp.name,\n        version: config.mcp.version,\n      },\n      {\n        capabilities: {\n          resources: config.mcp.capabilities.resources,\n          tools: config.mcp.capabilities.tools,\n          prompts: config.mcp.capabilities.prompts,\n        },\n      }\n    );\n\n    this.drupalClient = new DrupalClient(config.drupal);\n\n    // Initialize authentication components with new MCP OAuth provider (OAuth 2.1 stateless design)\n    this.mcpOAuthProvider = createOAuthProvider(config);\n\n    // Convert SimplifiedOAuthConfig to OAuthConfig for backward compatibility\n    const legacyOAuthConfig = {\n      clientId: config.oauth.clientId,\n      authorizationEndpoint:\n        config.oauth.authorizationEndpoint ||\n        config.oauth.discoveredEndpoints?.authorizationEndpoint ||\n        '',\n      tokenEndpoint:\n        config.oauth.tokenEndpoint ||\n        config.oauth.discoveredEndpoints?.tokenEndpoint ||\n        '',\n      redirectUri: config.oauth.redirectUri,\n      scopes: config.oauth.scopes,\n    };\n\n    this.oauthClient = new OAuthClient(legacyOAuthConfig); // Keep for backward compatibility\n    this.tokenManager = new TokenManager(this.oauthClient);\n\n    this.setupHandlers();\n  }\n\n  /**\n   * Generate unique request ID for tracing\n   */\n  private generateRequestId(): string {\n    return `mcp-req-${Date.now()}-${++this.requestCounter}`;\n  }\n\n  /**\n   * Simplified authentication check for OAuth 2.1 stateless design\n   */\n  private async requireAuthentication(): Promise<AuthContext> {\n    // Skip authentication if configured\n    if (this.config.auth.skipAuth) {\n      return { isAuthenticated: true };\n    }\n\n    try {\n      // Try to get valid access token from new MCP OAuth provider first\n      const validToken = await this.mcpOAuthProvider.getValidAccessToken();\n\n      if (validToken) {\n        // OAuth 2.1 tokens are stateless - no user info stored in token\n        return {\n          isAuthenticated: true,\n          userId: 'default', // OAuth 2.1 stateless design - derive from token claims if needed\n          scopes: this.config.auth.requiredScopes,\n          accessToken: validToken,\n        };\n      }\n\n      // Fall back to legacy token manager if needed\n      const accessToken = await this.tokenManager.getValidAccessToken(\n        undefined,\n        this.config.auth.requiredScopes\n      );\n\n      if (accessToken) {\n        const validation = await this.tokenManager.validateToken(\n          accessToken,\n          this.config.auth.requiredScopes\n        );\n\n        if (validation.isValid) {\n          return {\n            isAuthenticated: true,\n            userId: validation.userId || 'default',\n            scopes: validation.scopes,\n            accessToken,\n          };\n        }\n      }\n\n      return { isAuthenticated: false };\n    } catch (error) {\n      console.error('Authentication error:', error);\n      return { isAuthenticated: false };\n    }\n  }\n\n  /**\n   * Setup MCP request handlers\n   */\n  private setupHandlers(): void {\n    // List available resources\n    this.server.setRequestHandler(ListResourcesRequestSchema, async () => {\n      return {\n        resources: await this.getResources(),\n      };\n    });\n\n    // Read specific resource\n    this.server.setRequestHandler(ReadResourceRequestSchema, async request => {\n      return this.readResource(request.params.uri);\n    });\n\n    // List available tools\n    this.server.setRequestHandler(ListToolsRequestSchema, async () => {\n      return {\n        tools: this.getTools(),\n      };\n    });\n\n    // Execute tool (with authentication)\n    this.server.setRequestHandler(CallToolRequestSchema, async request => {\n      return this.executeToolWithAuth(\n        request.params.name,\n        request.params.arguments\n      );\n    });\n\n    // List available prompts\n    this.server.setRequestHandler(ListPromptsRequestSchema, async () => {\n      return {\n        prompts: this.getPrompts(),\n      };\n    });\n\n    // Get prompt\n    this.server.setRequestHandler(GetPromptRequestSchema, async request => {\n      return this.getPrompt(request.params.name, request.params.arguments);\n    });\n  }\n\n  /**\n   * Get available resources\n   */\n  private async getResources(): Promise<McpResource[]> {\n    const resources: McpResource[] = [\n      {\n        uri: 'drupal://nodes',\n        name: 'Drupal Nodes',\n        description: 'Access to Drupal node content',\n        mimeType: 'application/json',\n      },\n      {\n        uri: 'drupal://entities',\n        name: 'Drupal Entities',\n        description: 'Access to Drupal entity data',\n        mimeType: 'application/json',\n      },\n    ];\n\n    return resources;\n  }\n\n  /**\n   * Read a specific resource\n   */\n  private async readResource(uri: string): Promise<{\n    contents: Array<{ uri: string; mimeType?: string; text?: string }>;\n  }> {\n    try {\n      let content: unknown;\n\n      switch (uri) {\n        case 'drupal://nodes':\n          content = await this.drupalClient.getNodes({ limit: 10 });\n          break;\n\n        case 'drupal://entities':\n          content = await this.drupalClient.queryEntities('node', undefined, {\n            limit: 10,\n          });\n          break;\n\n        default:\n          throw new IntegrationError(\n            IntegrationErrorType.VALIDATION_ERROR,\n            `Unknown resource URI: ${uri}`,\n            undefined,\n            'uri',\n            { validUris: ['drupal://nodes', 'drupal://entities'] },\n            undefined,\n            false\n          );\n      }\n\n      return {\n        contents: [\n          {\n            uri,\n            mimeType: 'application/json',\n            text: JSON.stringify(content, null, 2),\n          },\n        ],\n      };\n    } catch (error) {\n      const integrationError =\n        error instanceof IntegrationError\n          ? error\n          : normalizeError(error, `Reading resource: ${uri}`);\n\n      // Log the error for debugging\n      const logData = formatErrorForLogging(integrationError, { uri });\n      console[logData.level](logData.message, logData.meta);\n\n      return {\n        contents: [\n          {\n            uri,\n            mimeType: 'application/json',\n            text: JSON.stringify(\n              {\n                error: {\n                  type: integrationError.errorType,\n                  message: integrationError.getUserFriendlyMessage(),\n                  details: {\n                    technical_message: integrationError.message,\n                    timestamp: new Date().toISOString(),\n                    retryable: integrationError.retryable,\n                  },\n                },\n              },\n              null,\n              2\n            ),\n          },\n        ],\n      };\n    }\n  }\n\n  /**\n   * Get available tools\n   */\n  private getTools(): McpTool[] {\n    const authTools: McpTool[] = [\n      {\n        name: 'auth_login',\n        description: 'Authenticate with Drupalize.me OAuth',\n        inputSchema: {\n          type: 'object',\n          properties: {},\n        },\n      },\n      {\n        name: 'auth_status',\n        description: 'Check current authentication status',\n        inputSchema: {\n          type: 'object',\n          properties: {},\n        },\n      },\n      {\n        name: 'auth_logout',\n        description: 'Logout and clear stored tokens',\n        inputSchema: {\n          type: 'object',\n          properties: {},\n        },\n      },\n    ];\n\n    const dataTools: McpTool[] = [\n      {\n        name: 'load_node',\n        description: 'Load a Drupal node by ID',\n        inputSchema: {\n          type: 'object',\n          properties: {\n            nodeId: {\n              type: ['string', 'number'],\n              description: 'The node ID to load',\n            },\n          },\n          required: ['nodeId'],\n        },\n      },\n      {\n        name: 'create_node',\n        description: 'Create a new Drupal node',\n        inputSchema: {\n          type: 'object',\n          properties: {\n            type: {\n              type: 'string',\n              description: 'The node type (e.g., \"article\", \"page\")',\n            },\n            title: {\n              type: 'string',\n              description: 'The node title',\n            },\n            body: {\n              type: 'string',\n              description: 'The node body content',\n            },\n            status: {\n              type: 'boolean',\n              description: 'Whether the node is published',\n              default: true,\n            },\n          },\n          required: ['type', 'title'],\n        },\n      },\n      {\n        name: 'search_nodes',\n        description: 'Search for Drupal nodes',\n        inputSchema: {\n          type: 'object',\n          properties: {\n            type: {\n              type: 'string',\n              description: 'Filter by node type',\n            },\n            status: {\n              type: 'boolean',\n              description: 'Filter by published status',\n            },\n            limit: {\n              type: 'number',\n              description: 'Maximum number of results',\n              default: 10,\n              minimum: 1,\n              maximum: 100,\n            },\n          },\n        },\n      },\n      {\n        name: 'test_connection',\n        description: 'Test connection to Drupal server',\n        inputSchema: {\n          type: 'object',\n          properties: {},\n        },\n      },\n      {\n        name: 'search_tutorials',\n        description:\n          'Search Drupalize.me tutorials with filtering by content types, Drupal versions, categories, and sorting options',\n        inputSchema: {\n          type: 'object',\n          properties: {\n            keywords: {\n              type: 'string',\n              description: 'Search keywords (minimum 2 characters)',\n              minLength: 2,\n            },\n            types: {\n              type: 'array',\n              description:\n                'Filter by content types (defaults to [\"tutorial\", \"topic\", \"course\"])',\n              items: {\n                type: 'string',\n                enum: ['tutorial', 'topic', 'course', 'video', 'guide'],\n              },\n            },\n            drupal_version: {\n              type: 'array',\n              description: 'Filter by Drupal versions',\n              items: {\n                type: 'string',\n                enum: ['9', '10', '11'],\n              },\n            },\n            category: {\n              type: 'array',\n              description: 'Filter by tutorial categories/tags',\n              items: {\n                type: 'string',\n              },\n            },\n            sort: {\n              type: 'string',\n              description: 'Sort results by relevance, date, or title',\n              enum: ['search_api_relevance', 'created', 'changed', 'title'],\n            },\n            page: {\n              type: 'object',\n              description: 'Pagination settings',\n              properties: {\n                limit: {\n                  type: 'number',\n                  description: 'Number of results per page',\n                  minimum: 1,\n                  maximum: 100,\n                  default: 10,\n                },\n                offset: {\n                  type: 'number',\n                  description: 'Number of results to skip',\n                  minimum: 0,\n                  default: 0,\n                },\n              },\n            },\n          },\n          required: ['keywords'],\n        },\n      },\n    ];\n\n    return [...authTools, ...dataTools];\n  }\n\n  /**\n   * Execute a tool with authentication\n   */\n  private async executeToolWithAuth(\n    name: string,\n    args: unknown\n  ): Promise<{ content: Array<{ type: string; text: string }> }> {\n    const requestId = this.generateRequestId();\n\n    try {\n      // Handle authentication tools separately\n      if (name.startsWith('auth_')) {\n        return await this.executeAuthTool(name, args);\n      }\n\n      // For data tools, require authentication (unless skipped)\n      if (!this.config.auth.skipAuth) {\n        const authContext = await this.requireAuthentication();\n\n        if (!authContext.isAuthenticated) {\n          throw new AuthenticationRequiredError(\n            'Please authenticate first using auth_login tool'\n          );\n        }\n\n        // Update Drupal client with access token\n        if (authContext.accessToken) {\n          this.drupalClient.setAccessToken(authContext.accessToken);\n        }\n      }\n\n      return await this.executeTool(name, args);\n    } catch (error) {\n      if (error instanceof AuthenticationRequiredError) {\n        return {\n          content: [\n            {\n              type: 'text',\n              text: JSON.stringify(\n                createMcpErrorResponse(requestId, error),\n                null,\n                2\n              ),\n            },\n          ],\n        };\n      }\n\n      throw error;\n    }\n  }\n\n  /**\n   * Execute authentication tools\n   */\n  private async executeAuthTool(\n    name: string,\n    args: unknown\n  ): Promise<{ content: Array<{ type: string; text: string }> }> {\n    try {\n      let result: unknown;\n\n      switch (name) {\n        case 'auth_login':\n          result = await this.executeAuthLogin();\n          break;\n\n        case 'auth_status':\n          result = await this.executeAuthStatus();\n          break;\n\n        case 'auth_logout':\n          result = await this.executeAuthLogout();\n          break;\n\n        default:\n          throw new Error(`Unknown auth tool: ${name}`);\n      }\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2),\n          },\n        ],\n      };\n    } catch (error) {\n      const integrationError =\n        error instanceof IntegrationError\n          ? error\n          : normalizeError(error, `Executing auth tool: ${name}`);\n\n      const logData = formatErrorForLogging(integrationError, {\n        tool: name,\n        args,\n      });\n      console[logData.level](logData.message, logData.meta);\n\n      return formatMcpErrorResponse(integrationError, this.generateRequestId());\n    }\n  }\n\n  /**\n   * Execute data tools (original executeTool method)\n   */\n  private async executeTool(\n    name: string,\n    args: unknown\n  ): Promise<{ content: Array<{ type: string; text: string }> }> {\n    const requestId = this.generateRequestId();\n\n    try {\n      let result: unknown;\n\n      switch (name) {\n        case 'load_node':\n          result = await this.executeLoadNode(args);\n          break;\n\n        case 'create_node':\n          result = await this.executeCreateNode(args);\n          break;\n\n        case 'search_nodes':\n          result = await this.executeSearchNodes(args);\n          break;\n\n        case 'test_connection':\n          result = await this.executeTestConnection();\n          break;\n\n        case 'search_tutorials':\n          result = await this.executeSearchTutorials(args);\n          break;\n\n        default:\n          throw new IntegrationError(\n            IntegrationErrorType.VALIDATION_ERROR,\n            `Unknown tool: ${name}`,\n            undefined,\n            'name',\n            {\n              validTools: [\n                'load_node',\n                'create_node',\n                'search_nodes',\n                'test_connection',\n                'search_tutorials',\n              ],\n              requestedTool: name,\n            },\n            undefined,\n            false\n          );\n      }\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2),\n          },\n        ],\n      };\n    } catch (error) {\n      const integrationError =\n        error instanceof IntegrationError\n          ? error\n          : normalizeError(error, `Executing tool: ${name}`, requestId);\n\n      // Log the error for debugging\n      const logData = formatErrorForLogging(integrationError, {\n        tool: name,\n        args,\n      });\n      console[logData.level](logData.message, logData.meta);\n\n      return formatMcpErrorResponse(integrationError, requestId);\n    }\n  }\n\n  /**\n   * Execute load node tool\n   */\n  private async executeLoadNode(args: unknown): Promise<unknown> {\n    if (!args || typeof args !== 'object' || !('nodeId' in args)) {\n      throw new Error('nodeId is required');\n    }\n\n    const { nodeId } = args as { nodeId: string | number };\n    return this.drupalClient.loadNode(nodeId);\n  }\n\n  /**\n   * Execute create node tool\n   */\n  private async executeCreateNode(args: unknown): Promise<unknown> {\n    if (!args || typeof args !== 'object') {\n      throw new Error('Invalid arguments');\n    }\n\n    const {\n      type,\n      title,\n      body,\n      status = true,\n    } = args as {\n      type: string;\n      title: string;\n      body?: string;\n      status?: boolean;\n    };\n\n    if (!type || !title) {\n      throw new Error('type and title are required');\n    }\n\n    return this.drupalClient.createNode({ type, title, body, status });\n  }\n\n  /**\n   * Execute search nodes tool\n   */\n  private async executeSearchNodes(args: unknown): Promise<unknown> {\n    const options =\n      (args as { type?: string; status?: boolean; limit?: number }) || {};\n    return this.drupalClient.getNodes(options);\n  }\n\n  /**\n   * Execute test connection tool\n   */\n  private async executeTestConnection(): Promise<{\n    connected: boolean;\n    config: unknown;\n  }> {\n    const connected = await this.drupalClient.testConnection();\n    const config = this.drupalClient.getConfig();\n\n    return { connected, config };\n  }\n\n  /**\n   * Execute authentication login using new MCP OAuth provider\n   */\n  private async executeAuthLogin(): Promise<unknown> {\n    try {\n      // Use the new MCP OAuth provider for authentication\n      const tokens = await this.mcpOAuthProvider.authorize();\n      const userId = 'default'; // In production, derive from token or user input\n\n      // Convert MCP SDK tokens to legacy token format for compatibility\n      const legacyTokens = {\n        accessToken: tokens.access_token,\n        refreshToken: tokens.refresh_token,\n        tokenType: tokens.token_type || 'Bearer',\n        expiresIn: tokens.expires_in,\n        scope: tokens.scope,\n      };\n\n      // Store tokens using both old and new systems for compatibility\n      await this.tokenManager.storeTokens(\n        legacyTokens,\n        userId,\n        this.config.auth.requiredScopes\n      );\n      await this.mcpOAuthProvider.saveTokens(tokens);\n\n      // Set access token on Drupal client for immediate use\n      this.drupalClient.setAccessToken(tokens.access_token);\n\n      return {\n        success: true,\n        message:\n          'Authentication successful using OAuth 2.1 stateless configuration',\n        userId,\n        scopes: this.config.auth.requiredScopes,\n        provider: 'McpOAuthProvider',\n        endpointsDiscovered: !!this.config.oauth.discoveredEndpoints,\n        isFallback: this.config.oauth.discoveredEndpoints?.isFallback,\n        tokenExpiry: tokens.expires_in\n          ? Date.now() + tokens.expires_in * 1000\n          : undefined,\n      };\n    } catch (error) {\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'Authentication failed',\n        hint: 'Make sure to complete the OAuth flow in your browser. Check that DRUPAL_BASE_URL and OAUTH_CLIENT_ID are set correctly.',\n      };\n    }\n  }\n\n  /**\n   * Execute authentication status check\n   */\n  private async executeAuthStatus(): Promise<unknown> {\n    try {\n      const tokenInfo = await this.tokenManager.getTokenInfo();\n      const mcpTokenInfo = await this.mcpOAuthProvider.getTokenInfo();\n      const hasValidTokens = await this.mcpOAuthProvider.hasValidTokens();\n      const authContext = await this.requireAuthentication();\n\n      return {\n        isAuthenticated: authContext.isAuthenticated,\n        userId: authContext.userId,\n        scopes: authContext.scopes,\n        tokenInfo,\n        mcpProvider: {\n          hasValidTokens,\n          tokenInfo: mcpTokenInfo,\n        },\n        provider: 'McpOAuthProvider (OAuth 2.1 Stateless)',\n        configInfo: {\n          endpointsDiscovered: !!this.config.oauth.discoveredEndpoints,\n          isFallback: this.config.oauth.discoveredEndpoints?.isFallback,\n          authorizationEndpoint: this.config.oauth.authorizationEndpoint,\n          tokenEndpoint: this.config.oauth.tokenEndpoint,\n          skipAuth: this.config.auth.skipAuth,\n        },\n      };\n    } catch (error) {\n      return {\n        isAuthenticated: false,\n        error:\n          error instanceof Error\n            ? error.message\n            : 'Failed to check auth status',\n      };\n    }\n  }\n\n  /**\n   * Execute authentication logout\n   */\n  private async executeAuthLogout(): Promise<unknown> {\n    try {\n      await this.tokenManager.clearTokens();\n      await this.mcpOAuthProvider.clearTokens();\n      this.drupalClient.clearAccessToken();\n\n      return {\n        success: true,\n        message: 'Logout successful - cleared all tokens (OAuth 2.1 stateless)',\n      };\n    } catch (error) {\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'Logout failed',\n      };\n    }\n  }\n\n  /**\n   * Execute search tutorials tool\n   */\n  private async executeSearchTutorials(\n    args: unknown\n  ): Promise<SearchContentResponse> {\n    // Validate and process input parameters using new validation function\n    const processedParams = validateSearchContentParams(args);\n\n    // In test environment or when Drupal is unavailable, return mock data\n    if (this.config.environment === 'test' || process.env.NODE_ENV === 'test') {\n      return this.getMockSearchContentResults(processedParams);\n    }\n\n    try {\n      // Make real JSON-RPC call to Drupal endpoint using new parameter structure\n      const response = await this.drupalClient.searchTutorials({\n        keywords: processedParams.keywords,\n        types: processedParams.types,\n        drupal_version: processedParams.drupal_version,\n        category: processedParams.category,\n        sort: processedParams.sort,\n        page: processedParams.page,\n      });\n\n      // Process and format the response for MCP consumption\n      const results: TutorialSearchResult[] = response.results.map(\n        tutorial => ({\n          id: tutorial.id,\n          title: tutorial.title,\n          url: tutorial.url,\n          description:\n            tutorial.description ||\n            this.extractDescriptionFromContent(tutorial.content),\n          drupal_version: tutorial.drupal_version,\n          tags: tutorial.tags,\n          difficulty: tutorial.difficulty as\n            | 'beginner'\n            | 'intermediate'\n            | 'advanced'\n            | undefined,\n          created: tutorial.created,\n          updated: tutorial.updated,\n        })\n      );\n\n      return {\n        results,\n        total: response.total,\n        facets: response.facets,\n        query: processedParams,\n      };\n    } catch (error) {\n      // Convert any validation errors to IntegrationError\n      if (error instanceof ValidationError) {\n        throw new IntegrationError(\n          IntegrationErrorType.VALIDATION_ERROR,\n          error.message,\n          undefined,\n          error.field,\n          { processedParams },\n          error,\n          false\n        );\n      }\n\n      // Handle IntegrationErrors from the DrupalClient\n      if (error instanceof IntegrationError) {\n        // In production, re-throw the error; in development, log and return mock data for certain error types\n        if (this.config.environment === 'production' || !error.retryable) {\n          throw error;\n        }\n\n        // Fallback to mock data if the real endpoint is unavailable and error is retryable\n        console.warn(\n          `API unavailable (${error.errorType}), returning mock data: ${error.message}`\n        );\n        return this.getMockSearchContentResults(processedParams);\n      }\n\n      // Handle any other unexpected errors\n      const integrationError = normalizeError(error, 'Tutorial search');\n\n      // In production, re-throw; in development, return mock data for network-related errors\n      if (this.config.environment === 'production') {\n        throw integrationError;\n      }\n\n      console.warn(\n        `Unexpected error, returning mock data: ${integrationError.message}`\n      );\n      return this.getMockSearchContentResults(processedParams);\n    }\n  }\n\n  /**\n   * Get mock search results for new content API (testing and fallback scenarios)\n   */\n  private getMockSearchContentResults(\n    processedParams: ProcessedSearchContentParams\n  ): SearchContentResponse {\n    // Create mock results that support filtering\n    const allMockResults: TutorialSearchResult[] = [\n      {\n        id: '1',\n        title: `Tutorial about ${processedParams.keywords}`,\n        url: 'https://drupalize.me/tutorial/sample-tutorial',\n        description: `A comprehensive tutorial covering ${processedParams.keywords} concepts`,\n        drupal_version: ['10', '11'],\n        tags:\n          processedParams.category && processedParams.category.length > 0\n            ? processedParams.category\n            : ['tutorial', 'drupal'],\n        difficulty: 'intermediate',\n        created: '2024-01-01T00:00:00Z',\n        updated: '2024-06-01T00:00:00Z',\n      },\n      // Add a Drupal 9 specific tutorial for testing filtering\n      {\n        id: '2',\n        title: `Drupal 9 specific tutorial about ${processedParams.keywords}`,\n        url: 'https://drupalize.me/tutorial/drupal9-tutorial',\n        description: `Legacy tutorial for ${processedParams.keywords} in Drupal 9`,\n        drupal_version: ['9'],\n        tags:\n          processedParams.category && processedParams.category.length > 0\n            ? [...processedParams.category, 'drupal-9']\n            : ['tutorial', 'drupal', 'drupal-9'],\n        difficulty: 'intermediate',\n        created: '2023-01-01T00:00:00Z',\n        updated: '2023-06-01T00:00:00Z',\n      },\n    ];\n\n    // Filter results by drupal_version if specified\n    const filteredResults =\n      processedParams.drupal_version &&\n      processedParams.drupal_version.length > 0\n        ? allMockResults.filter(result =>\n            processedParams.drupal_version!.some(version =>\n              result.drupal_version?.includes(version)\n            )\n          )\n        : allMockResults.slice(0, 1); // Return only the first result when no version filter is applied\n\n    return {\n      results: filteredResults,\n      total: filteredResults.length,\n      facets: {\n        drupal_version: {\n          '9': 1,\n          '10': 1,\n          '11': 1,\n        },\n        content_type: {\n          tutorial: 2,\n          topic: 0,\n          course: 0,\n        },\n      },\n      query: processedParams,\n    };\n  }\n\n  /**\n   * Extract description from tutorial content for RAG optimization\n   */\n  private extractDescriptionFromContent(content: string): string {\n    // Extract first paragraph or first 200 characters as description\n    const lines = content.split('\\n').filter(line => line.trim());\n    const firstContentLine = lines.find(\n      line => !line.startsWith('#') && line.trim().length > 0\n    );\n\n    if (firstContentLine) {\n      return firstContentLine.length > 200\n        ? `${firstContentLine.substring(0, 197)}...`\n        : firstContentLine;\n    }\n\n    // Fallback: return first 200 characters\n    return `${content.substring(0, 197)}...`;\n  }\n\n  /**\n   * Get available prompts\n   */\n  private getPrompts(): McpPrompt[] {\n    return [\n      {\n        name: 'drupal_content_summary',\n        description: 'Generate a summary of Drupal content',\n        arguments: [\n          {\n            name: 'content_type',\n            description: 'Type of content to summarize',\n            required: false,\n          },\n          {\n            name: 'limit',\n            description: 'Maximum number of items to include',\n            required: false,\n          },\n        ],\n      },\n    ];\n  }\n\n  /**\n   * Get a specific prompt\n   */\n  private async getPrompt(\n    name: string,\n    args?: Record<string, unknown>\n  ): Promise<{\n    description: string;\n    messages: Array<{ role: string; content: { type: string; text: string } }>;\n  }> {\n    switch (name) {\n      case 'drupal_content_summary':\n        return this.getDrupalContentSummaryPrompt(args);\n      default:\n        throw new Error(`Unknown prompt: ${name}`);\n    }\n  }\n\n  /**\n   * Get Drupal content summary prompt\n   */\n  private async getDrupalContentSummaryPrompt(\n    args?: Record<string, unknown>\n  ): Promise<{\n    description: string;\n    messages: Array<{ role: string; content: { type: string; text: string } }>;\n  }> {\n    const contentType = args?.content_type as string | undefined;\n    const limit = (args?.limit as number) || 10;\n\n    try {\n      const nodes = await this.drupalClient.getNodes({\n        type: contentType,\n        limit,\n      });\n\n      const content = `Here are the recent Drupal nodes${contentType ? ` of type \"${contentType}\"` : ''}:\\n\\n${nodes\n        .map(\n          (node, index) =>\n            `${index + 1}. ${node.attributes.title} (ID: ${node.attributes.nid})`\n        )\n        .join('\\n')}\\n\\nPlease provide a summary of this content.`;\n\n      return {\n        description: `Summary of Drupal content${contentType ? ` (${contentType})` : ''}`,\n        messages: [\n          {\n            role: 'user',\n            content: {\n              type: 'text',\n              text: content,\n            },\n          },\n        ],\n      };\n    } catch (error) {\n      const errorMessage =\n        error instanceof DrupalClientError ? error.message : String(error);\n\n      return {\n        description: 'Error generating Drupal content summary',\n        messages: [\n          {\n            role: 'user',\n            content: {\n              type: 'text',\n              text: `Error fetching Drupal content: ${errorMessage}`,\n            },\n          },\n        ],\n      };\n    }\n  }\n\n  /**\n   * Get the underlying server instance\n   */\n  getServer(): Server {\n    return this.server;\n  }\n\n  /**\n   * Connect the server to a transport\n   */\n  async connect(transport: Transport): Promise<void> {\n    await this.server.connect(transport);\n  }\n\n  /**\n   * Close the server\n   */\n  async close(): Promise<void> {\n    await this.server.close();\n  }\n}\n"],"version":3}